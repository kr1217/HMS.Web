@page "/Doctor/UploadReport/{PatientId:int}"
@using Microsoft.AspNetCore.Authorization
@using HMS.Web.Models
@using HMS.Web.DAL
@using HMS.Web.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Hosting
@using System.IO
@attribute [Authorize(Roles = "Doctor")]
@rendermode InteractiveServer
@inject DoctorRepository DoctorRepo
@inject PatientRepository PatientRepo
@inject ReportRepository ReportRepo
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav
@inject NotificationRepository NotificationRepo
@inject AppointmentRepository AppointmentRepo
@inject IWebHostEnvironment Environment
<RadzenStack Class="rz-p-4" Gap="2rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
        JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0">
            <RadzenText Text="Clinical Report Management" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
            @if (Patient != null)
            {
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                    <RadzenText Text="@($"Patient: {Patient.FullName}")" TextStyle="TextStyle.Subtitle2" Class="rz-m-0" />
                    <RadzenBadge Text="@($"#PAT-{PatientId}")" BadgeStyle="BadgeStyle.Light" IsPill="true" />
                </RadzenStack>
            }
        </RadzenStack>
        <RadzenButton Icon="arrow_back" Text="Dashboard" ButtonStyle="ButtonStyle.Light" Click="@GoBack"
            Variant="Variant.Flat" />
    </RadzenStack>

    @if (CurrentDoctor == null)
    {
        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
            <RadzenText Text="Authenticating clinician session..." TextStyle="TextStyle.Caption" />
        </RadzenStack>
    }
    else
    {
        <RadzenRow JustifyContent="JustifyContent.Center">
            <RadzenColumn Size="12" SizeMD="10" SizeLG="8">
                <RadzenCard Class="rz-p-6 rz-shadow-4" Style="border-radius: 16px;">
                    <RadzenText Text="Archive New Document" TextStyle="TextStyle.H6" Class="rz-mb-6 rz-color-primary" />

                    <EditForm Model="NewReport" OnValidSubmit="SaveReport">
                        <DataAnnotationsValidator />
                        <RadzenStack Gap="1.5rem">
                            <RadzenRow Gap="1rem">
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Report Title" Style="width: 100%;">
                                        <RadzenTextBox @bind-Value="NewReport.ReportName" MaxLength="100"
                                            Placeholder="e.g., Post-Op Assessment" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Document Type" Style="width: 100%;">
                                        <RadzenDropDown @bind-Value="NewReport.ReportType"
                                            Data="@(new[] { "Lab Test", "Radiology", "Diagnosis", "Discharge Summary", "Other" })" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>

                            <RadzenFormField Text="Clinical Observations & Findings" Style="width: 100%;">
                                <RadzenTextArea @bind-Value="NewReport.Observations" Rows="4"
                                    Placeholder="Provide a clinical summary of results..." />
                            </RadzenFormField>

                            <RadzenStack Gap="0.5rem">
                                <RadzenText Text="Attach Clinical Document (PDF/JPG/PNG)" TextStyle="TextStyle.Caption"
                                    Class="rz-m-0" />
                                <RadzenStack Class="rz-p-4 rz-border-radius-2 rz-background-color-base-100"
                                    Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                    <InputFile OnChange="HandleFileSelected" class="custom-file-input"
                                        accept=".pdf,.png,.jpg,.jpeg" style="width: 100%;" id="report-upload" />
                                </RadzenStack>
                                <ValidationMessage For="@(() => NewReport.ReportName)" />
                            </RadzenStack>

                            @if (IsUploading)
                            {
                                <RadzenStack Gap="0.5rem">
                                    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                                    <RadzenText Text="Securing document transmission..." TextStyle="TextStyle.Overline"
                                        TextAlign="TextAlign.Center" />
                                </RadzenStack>
                            }
                            else if (!string.IsNullOrEmpty(UploadedFileName))
                            {
                                <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter"
                                    AllowClose="false" Size="AlertSize.Small">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                                        Gap="0.5rem">
                                        <RadzenIcon Icon="check_circle" />
                                        <RadzenText Text="@($"Ready: {UploadedFileName}")" TextStyle="TextStyle.Caption"
                                            Class="rz-m-0 rz-color-success-dark" />
                                    </RadzenStack>
                                </RadzenAlert>
                            }

                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem"
                                Class="rz-mt-4">
                                <RadzenButton Text="Discard" ButtonStyle="ButtonStyle.Light" Click="@GoBack" />
                                <RadzenButton Text="Authorize & Archive" Icon="cloud_upload"
                                    ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit"
                                    Disabled="@(IsUploading || string.IsNullOrEmpty(UploadedFilePath))" Class="rz-px-8" />
                            </RadzenStack>
                        </RadzenStack>
                    </EditForm>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

<style>
    .custom-file-input::file-selector-button {
        background: var(--rz-primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 1rem;
        transition: background 0.2s;
    }

    .custom-file-input::file-selector-button:hover {
        background: var(--rz-primary-dark);
    }
</style>

@code {
    [Parameter]
    public int PatientId { get; set; }

    [SupplyParameterFromQuery]
    public int? AppointmentId { get; set; }

    private Doctor? CurrentDoctor;
    private Patient? Patient;
    private Report NewReport { get; set; } = new();

    private string UploadedFilePath = "";
    private string UploadedFileName = "";
    private long MaxFileSize = 10 * 1024 * 1024; // 10 MB
    private bool IsUploading = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userClaims = authState.User;

        if (userClaims.Identity?.IsAuthenticated == true)
        {
            var userId = UserManager.GetUserId(userClaims);
            if (!string.IsNullOrEmpty(userId))
            {
                CurrentDoctor = DoctorRepo.GetDoctorByUserId(userId);
            }
        }

        Patient = PatientRepo.GetPatientById(PatientId);
        NewReport.ReportDate = DateTime.Now;
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file != null)
            {
                if (file.Size > MaxFileSize)
                {
                    // Handle error
                    return;
                }

                UploadedFileName = file.Name;
                IsUploading = true;
                StateHasChanged();

                // Ensure directory exists
                var uploadPath = Path.Combine(Environment.WebRootPath, "uploads", "reports");
                if (!Directory.Exists(uploadPath))
                {
                    Directory.CreateDirectory(uploadPath);
                }

                // Generate unique filename
                var uniqueFileName = $"{Guid.NewGuid()}_{file.Name}";
                var filePath = Path.Combine(uploadPath, uniqueFileName);

                await using (var stream = new FileStream(filePath, FileMode.Create))
                {
                    await file.OpenReadStream(MaxFileSize).CopyToAsync(stream);
                }

                UploadedFilePath = $"/uploads/reports/{uniqueFileName}";
                IsUploading = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"File upload failed: {ex.Message}");
            IsUploading = false;
        }
    }
    private void SaveReport()
    {
        if (CurrentDoctor == null || string.IsNullOrEmpty(UploadedFilePath)) return;

        NewReport.PatientId = PatientId;
        NewReport.DoctorId = CurrentDoctor.DoctorId;
        NewReport.AppointmentId = AppointmentId;
        NewReport.FilePath = UploadedFilePath;
        NewReport.Status = "Finalized";
        NewReport.ReportDate = DateTime.Now;

        ReportRepo.CreateReport(NewReport);

        // Mark appointment as Completed if linked
        if (AppointmentId.HasValue)
        {
            AppointmentRepo.UpdateAppointmentStatus(AppointmentId.Value, "Completed");
        }

        NotificationRepo.CreateNotification(new Notification
            {
                PatientId = PatientId,
                Title = "New Medical Report",
                Message = $"Dr. {CurrentDoctor.FullName} has uploaded a new report: {NewReport.ReportName}.",
                CreatedDate = DateTime.Now,
                IsRead = false
            });

        Nav.NavigateTo("/Doctor/Dashboard?tab=patients");
    }

    private void GoBack()
    {
        Nav.NavigateTo("/Doctor/Dashboard");
    }
}
