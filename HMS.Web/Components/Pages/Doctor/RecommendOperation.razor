@*
 * FILE: RecommendOperation.razor
 * PURPOSE: Doctor-facing component for clinical management.
 * COMMUNICATES WITH: DoctorRepository, OperationRepository, PatientRepository, NotificationRepository, AppointmentRepository
*@
@page "/Doctor/RecommendOperation/{PatientId:int}"
@using Microsoft.AspNetCore.Authorization
@using HMS.Web.Models
@using HMS.Web.DAL
@using HMS.Web.Data
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@attribute [Authorize(Roles = "Doctor")]
@rendermode InteractiveServer
@inject DoctorRepository DoctorRepo
@inject OperationRepository OperationRepo
@inject PatientRepository PatientRepo
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav
@inject NotificationRepository NotificationRepo
@inject NotificationService NotificationService
@*
    COMPONENT: Surgical Recommendation Interface
    PURPOSE: Allows doctors to propose surgical interventions for patients.
    OPTIMIZATION: [Smart Defaults] Pre-fills standard package costs and details to save physician time, while allowing custom overrides.
*@

<RadzenStack Class="rz-p-4" Gap="2rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0">
            <RadzenText Text="Surgical Intervention Planning" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
            @if (Patient != null)
            {
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                    <RadzenText Text="@($"Patient: {Patient.FullName}")" TextStyle="TextStyle.Subtitle2" Class="rz-m-0" />
                    <RadzenBadge Text="@($"#PAT-{PatientId}")" BadgeStyle="BadgeStyle.Light" IsPill="true" />
                </RadzenStack>
            }
        </RadzenStack>
        <RadzenButton Icon="arrow_back" Text="Dashboard" ButtonStyle="ButtonStyle.Light" Click="@GoBack" Variant="Variant.Flat" />
    </RadzenStack>

    @if (CurrentDoctor == null)
    {
        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
            <RadzenText Text="Retrieving clinician credentials..." TextStyle="TextStyle.Caption" />
        </RadzenStack>
    }
    else
    {
        <RadzenRow Gap="2rem">
            <RadzenColumn Size="12" SizeLG="8">
                <RadzenCard Class="rz-p-6 rz-shadow-4" Style="border-radius: 16px;">
                    <RadzenText Text="Procedure Details" TextStyle="TextStyle.H6" Class="rz-mb-6 rz-color-primary" />
                    
                    <EditForm Model="NewOperation" OnValidSubmit="SaveOperation">
                        <DataAnnotationsValidator />
                        <RadzenStack Gap="1.5rem">
                            
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" Class="rz-mb-2">
                                <RadzenCheckBox TValue="bool" @bind-Value="IsCustomOperation" Name="customOp" />
                                <RadzenLabel Text="Propose Custom Surgical Procedure (Not in Standard List)" Component="customOp" Class="rz-color-warning-dark" />
                            </RadzenStack>

                            <RadzenRow Gap="1rem">
                                <RadzenColumn Size="12" SizeMD="8">
                                    @if (!IsCustomOperation)
                                    {
                                        <RadzenFormField Text="Select Surgical Package" Style="width: 100%;">
                                            <RadzenDropDown @bind-Value="NewOperation.PackageId" 
                                                           Data="@Packages" TextProperty="PackageName" ValueProperty="PackageId"
                                                           Placeholder="Search standard procedures..." TValue="int?" />
                                        </RadzenFormField>
                                    }
                                    else
                                    {
                                        <RadzenFormField Text="Procedure Name" Style="width: 100%;">
                                            <RadzenTextBox @bind-Value="NewOperation.PackageName" Placeholder="Enter full surgical name..." />
                                        </RadzenFormField>
                                    }
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="4">
                                     <RadzenFormField Text="Target Date" Style="width: 100%;">
                                        <RadzenDatePicker @bind-Value="NewOperation.ScheduledDate" DateFormat="d" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>

                            <RadzenRow Gap="1rem">
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Clinical Priority" Style="width: 100%;">
                                        <RadzenDropDown @bind-Value="NewOperation.Urgency" 
                                                       Data="@(new[] { "Low", "Medium", "High", "Critical" })" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Est. Recovery Stay (Days)" Style="width: 100%;">
                                        <RadzenNumeric @bind-Value="NewOperation.ExpectedStayDays" Min="0" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>

                            <RadzenRow Gap="1rem">
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Consumables & Inventory" Style="width: 100%;">
                                        <RadzenTextArea @bind-Value="NewOperation.RecommendedMedicines" Rows="3" Placeholder="List required drugs and pre-op kits..." />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Specialized Equipment" Style="width: 100%;">
                                        <RadzenTextArea @bind-Value="NewOperation.RecommendedEquipment" Rows="3" Placeholder="e.g., C-Arm, Laparoscopic set..." />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>

                            <RadzenFormField Text="Perioperative Instructions" Style="width: 100%;">
                                <RadzenTextArea @bind-Value="NewOperation.Notes" Rows="2" Placeholder="Document specific preparation requirements..." />
                            </RadzenFormField>

                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-4">
                                <RadzenButton Text="Discard" ButtonStyle="ButtonStyle.Light" Click="@GoBack" />
                                <RadzenButton Text="Confirm Recommendation" Icon="assignment_turned_in" ButtonStyle="ButtonStyle.Danger" 
                                             ButtonType="ButtonType.Submit" Class="rz-px-8" />
                            </RadzenStack>
                        </RadzenStack>
                    </EditForm>
                </RadzenCard>
            </RadzenColumn>

            <!-- Metadata / Analysis Sidebar -->
            <RadzenColumn Size="12" SizeLG="4">
                <RadzenStack Gap="1.5rem">
                    @if (NewOperation.PackageId > 0 && !IsCustomOperation)
                    {
                        var selectedPkg = Packages.FirstOrDefault(p => p.PackageId == NewOperation.PackageId);
                        if (selectedPkg != null)
                        {
                            <RadzenCard Class="rz-p-6 rz-background-color-info-lighter" Style="border-radius: 12px;">
                                <RadzenText Text="Package Valuation" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                                <RadzenText Text="@selectedPkg.PackageName" TextStyle="TextStyle.H5" Class="rz-mb-2 rz-color-info-dark" />
                                <RadzenText Text="@selectedPkg.Cost.ToString("C")" TextStyle="TextStyle.H4" Class="rz-color-primary rz-font-weight-bold" />
                                <RadzenText Text="@selectedPkg.Description" TextStyle="TextStyle.Body2" Class="rz-mt-4" />
                                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Text" AllowClose="false" Size="AlertSize.Small" Class="rz-mt-4 rz-p-0">
                                    Financial counseling will be triggered upon patient acceptance.
                                </RadzenAlert>
                            </RadzenCard>
                        }
                    }

                    <RadzenCard Class="rz-p-6 rz-background-color-warning-lighter" Style="border-radius: 12px;">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-mb-2">
                            <RadzenIcon Icon="lightbulb" Style="color: var(--rz-warning-dark);" />
                            <RadzenText Text="Clinical Guidance" TextStyle="TextStyle.Subtitle2" Class="rz-m-0 rz-color-warning-dark" />
                        </RadzenStack>
                        <RadzenText Text="Ensure the requested date factors in theater availability and patient clearance cycles. Urgent cases should be flagged with appropriate priority levels." 
                                   TextStyle="TextStyle.Caption" Class="rz-color-warning-dark" />
                    </RadzenCard>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

@code {
    [Parameter]
    public int PatientId { get; set; }

    [SupplyParameterFromQuery]
    public int? AppointmentId { get; set; }

    private Doctor? CurrentDoctor;
    private Patient? Patient;
    private PatientOperation NewOperation { get; set; } = new();
    private List<OperationPackage> Packages = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userClaims = authState.User;

            if (userClaims.Identity?.IsAuthenticated == true)
            {
                var userId = UserManager.GetUserId(userClaims);
                if (!string.IsNullOrEmpty(userId))
                {
                    CurrentDoctor = DoctorRepo.GetDoctorByUserId(userId);
                }
            }

            Patient = PatientRepo.GetPatientById(PatientId);
            Packages = OperationRepo.GetOperationPackages();

            NewOperation.ScheduledDate = DateTime.Today.AddDays(1);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Initialization Error", ex.Message);
        }
    }

    @inject AppointmentRepository AppointmentRepo

    <!-- ... inside code ... -->
    private bool IsCustomOperation = false;

    private void ToggleCustomOperation(ChangeEventArgs e)
    {
        IsCustomOperation = (bool)(e.Value ?? false);
        if (IsCustomOperation)
        {
            NewOperation.PackageId = null;
            NewOperation.PackageName = "";
        }
        else
        {
            NewOperation.PackageId = 0;
        }
    }

    private void SaveOperation()
    {
        try
        {
            if (CurrentDoctor == null || Patient == null) return;

            // Validation for Custom vs Package
            if (!IsCustomOperation && (NewOperation.PackageId == 0 || NewOperation.PackageId == null))
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Validation", "Please select a surgical package.");
                return;
            }
            if (IsCustomOperation && string.IsNullOrWhiteSpace(NewOperation.PackageName))
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Validation", "Please enter the procedure name.");
                return;
            }

            // Set PackageName if Package selected (for redundancy or UI display)
            if (!IsCustomOperation && NewOperation.PackageId > 0)
            {
                var pkg = Packages.FirstOrDefault(p => p.PackageId == NewOperation.PackageId);
                NewOperation.PackageName = pkg?.PackageName ?? "";
            }

            NewOperation.PatientId = PatientId;
            NewOperation.DoctorId = CurrentDoctor.DoctorId;
            NewOperation.Status = "Recommended";

            OperationRepo.CreatePatientOperation(NewOperation);

            // Mark appointment as Completed if linked
            if (AppointmentId.HasValue)
            {
                AppointmentRepo.UpdateAppointmentStatus(AppointmentId.Value, "Completed");
            }

            NotificationRepo.CreateNotification(new Notification
                {
                    PatientId = PatientId,
                    Title = "Operation Recommended",
                    Message = $"Dr. {CurrentDoctor.FullName} has recommended a procedure: {NewOperation.PackageName}. Please review.",
                    CreatedDate = DateTime.Now,
                    IsRead = false
                });

            NotificationRepo.CreateNotification(new Notification
                {
                    TargetRole = "Admin",
                    Title = "New Surgical Recommendation",
                    Message = $"Dr. {CurrentDoctor.FullName} has recommended {NewOperation.PackageName} for {Patient.FullName}. Action required.",
                    CreatedDate = DateTime.Now,
                    IsRead = false
                });

            Nav.NavigateTo("/Doctor/Dashboard?tab=patients");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Submission Error", $"Failed to recommend operation: {ex.Message}");
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/Doctor/Dashboard");
    }
}

