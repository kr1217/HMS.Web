@page "/doctor/dashboard"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Doctor")]
@inject DoctorRepository DoctorRepo
@inject AppointmentRepository AppointmentRepo
@inject DoctorShiftRepository ShiftRepo
@inject ReportRepository ReportRepo
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject NotificationService NotificationService
@using HMS.Web.Models
@using HMS.Web.DAL
@using Microsoft.AspNetCore.Components.Authorization

<PageTitle>Doctor Dashboard | Hospital Management</PageTitle>

<RadzenStack Gap="1.5rem" Class="rz-p-4 rz-p-md-6">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
        JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0.5rem">
            <RadzenText Text="@($"Welcome, Dr. {currentDoctor?.FullName ?? "Physician"}")" TextStyle="TextStyle.H4"
                Class="rz-m-0 rz-color-primary" />
            <RadzenText Text="Manage your clinical schedule, patient consultations, and diagnostic reports."
                TextStyle="TextStyle.Body1" Class="rz-color-text-secondary" />
        </RadzenStack>
        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@(currentDoctor?.Specialization ?? "General Practice")"
            IsPill="true" Style="font-size: 1rem; padding: 0.5rem 1rem;" />
    </RadzenStack>

    <RadzenRow Gap="1.5rem">
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenCard Class="rz-p-4 rz-background-color-primary-lighter"
                Style="border-radius: 12px; border-left: 6px solid var(--rz-primary);">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenIcon Icon="calendar_today" Style="font-size: 2.5rem; color: var(--rz-primary);" />
                    <RadzenStack Gap="0">
                        <RadzenText Text="Today's Sessions" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                        <RadzenText Text="@stats.AppointmentsToday.ToString()" TextStyle="TextStyle.H4"
                            Class="rz-m-0 rz-font-weight-bold" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenCard Class="rz-p-4 rz-background-color-warning-lighter"
                Style="border-radius: 12px; border-left: 6px solid var(--rz-warning);">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenIcon Icon="pending_actions" Style="font-size: 2.5rem; color: var(--rz-warning);" />
                    <RadzenStack Gap="0">
                        <RadzenText Text="Pending Approvals" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                        <RadzenText Text="@stats.PendingApprovals.ToString()" TextStyle="TextStyle.H4"
                            Class="rz-m-0 rz-font-weight-bold" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenCard Class="rz-p-4 rz-background-color-success-lighter"
                Style="border-radius: 12px; border-left: 6px solid var(--rz-success);">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenIcon Icon="group" Style="font-size: 2.5rem; color: var(--rz-success);" />
                    <RadzenStack Gap="0">
                        <RadzenText Text="Total Patients" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                        <RadzenText Text="@stats.TotalPatientsServed.ToString()" TextStyle="TextStyle.H4"
                            Class="rz-m-0 rz-font-weight-bold" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenCard Class="rz-p-4 rz-background-color-info-lighter"
                Style="border-radius: 12px; border-left: 6px solid var(--rz-info);">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenIcon Icon="account_balance_wallet" Style="font-size: 2.5rem; color: var(--rz-info);" />
                    <RadzenStack Gap="0">
                        <RadzenText Text="Monthly Accrual" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                        <RadzenText Text="@stats.MonthlyCommission.ToString("C")" TextStyle="TextStyle.H4"
                            Class="rz-m-0 rz-font-weight-bold" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow Gap="1.5rem">
        <RadzenColumn Size="12" SizeLG="8">
            <RadzenCard Class="rz-p-0" Style="overflow: hidden; border-radius: 12px;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                    Class="rz-p-4 rz-background-color-primary-darker">
                    <RadzenIcon Icon="list_alt" Style="color: white;" />
                    <RadzenText Text="Recent Encounter Schedule" TextStyle="TextStyle.H6" Class="rz-m-0"
                        Style="color: white;" />
                </RadzenStack>
                <RadzenDataGrid @ref="appointmentGrid" TItem="Appointment" Data="@appointments"
                    Count="@appointmentCount" LoadData="@LoadAppointmentsData" IsLoading="@isLoading"
                    AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true"
                    FilterMode="FilterMode.Simple" RowSelect="@OnAppointmentSelect">
                    <EmptyTemplate>
                        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
                            <RadzenIcon Icon="event_busy"
                                Style="font-size: 4rem; color: var(--rz-text-disabled-color);" />
                            <RadzenText Text="No appointment requests found in the current period."
                                TextStyle="TextStyle.Subtitle1" Class="rz-color-text-secondary" />
                        </RadzenStack>
                    </EmptyTemplate>
                    <Columns>
                        <RadzenDataGridColumn TItem="Appointment" Property="AppointmentDate" Title="Date/Time"
                            FormatString="{0:MMM dd, hh:mm tt}" Width="160px" />
                        <RadzenDataGridColumn TItem="Appointment" Property="PatientName" Title="Patient Designation" />
                        <RadzenDataGridColumn TItem="Appointment" Title="Shift Status" Width="140px">
                            <Template Context="appt">
                                @if (IsOnShift(appt))
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="During Shift" Shade="Shade.Lighter"
                                        IsPill="true" Icon="check_circle" />
                                }
                                else
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Off-Shift" Shade="Shade.Lighter"
                                        IsPill="true" Icon="warning" />
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Appointment" Title="Clinical Status" Width="120px"
                            TextAlign="TextAlign.Center">
                            <Template Context="appt">
                                <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(appt.Status)" Text="@appt.Status"
                                    IsPill="true" />
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Appointment" Title="Operations" Sortable="false" Filterable="false"
                            TextAlign="TextAlign.Right" Width="200px">
                            <Template Context="appt">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem"
                                    JustifyContent="JustifyContent.End">
                                    @if (appt.Status == "Pending")
                                    {
                                        <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small"
                                            Click="@(() => ApproveAppointment(appt))" />
                                        <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                            Click="@(() => RejectAppointment(appt))" />
                                    }
                                    @if (appt.Status == "Approved")
                                    {
                                        <RadzenButton Text="Prescribe" Icon="medication" ButtonStyle="ButtonStyle.Info"
                                            Size="ButtonSize.Small"
                                            Click="@(() => Navigation.NavigateTo($"/doctor/prescribe/{appt.PatientId}/{appt.AppointmentId}"))" />
                                        <RadzenButton Text="Surgery" Icon="biotech" ButtonStyle="ButtonStyle.Danger"
                                            Variant="Variant.Flat" Size="ButtonSize.Small"
                                            Click="@(() => Navigation.NavigateTo($"/Doctor/RecommendOperation/{appt.PatientId}?AppointmentId={appt.AppointmentId}"))" />
                                    }
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeLG="4">
            <RadzenStack Gap="1.5rem">
                <RadzenCard Style="border-radius: 12px;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Class="rz-mb-4">
                        <RadzenIcon Icon="assignment" Class="rz-color-info" />
                        <RadzenText Text="Diagnostic Action Items" TextStyle="TextStyle.H6" Class="rz-m-0" />
                    </RadzenStack>
                    <RadzenText Text="@($"{stats.PendingReports} pending reports require final observations.")"
                        TextStyle="TextStyle.Body2" Class="rz-color-text-secondary rz-mb-4" />
                    <RadzenButton Text="Review Reports" Icon="rate_review" ButtonStyle="ButtonStyle.Info"
                        Variant="Variant.Flat" Class="rz-w-100"
                        Click="@(() => Navigation.NavigateTo("/doctor/patients"))" />
                </RadzenCard>

                <RadzenCard Style="border-radius: 12px;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Class="rz-mb-4">
                        <RadzenIcon Icon="settings" Class="rz-color-secondary" />
                        <RadzenText Text="Practice Management" TextStyle="TextStyle.H6" Class="rz-m-0" />
                    </RadzenStack>
                    <RadzenStack Gap="0.75rem">
                        <RadzenButton Text="Modify Availability" Icon="schedule" ButtonStyle="ButtonStyle.Light"
                            Variant="Variant.Flat" Class="rz-w-100 rz-text-align-left"
                            Click="@(() => Navigation.NavigateTo("/doctor/shifts"))" />
                        <RadzenButton Text="Clinical Profile" Icon="account_circle" ButtonStyle="ButtonStyle.Light"
                            Variant="Variant.Flat" Class="rz-w-100 rz-text-align-left"
                            Click="@(() => Navigation.NavigateTo("/doctor/profile"))" />
                        <RadzenButton Text="Surgical Recommendations" Icon="medical_services"
                            ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Class="rz-w-100 rz-text-align-left"
                            Click="@(() => Navigation.NavigateTo("/doctor/recommendations"))" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

<RadzenComponents />

@code {
    DoctorDashboardStats stats = new();
    Doctor? currentDoctor;
    IEnumerable<Appointment> appointments = new List<Appointment>();
    RadzenDataGrid<Appointment> appointmentGrid = default!;
    int appointmentCount;
    bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            currentDoctor = DoctorRepo.GetDoctorByUserId(userId);
            if (currentDoctor != null)
            {
                stats = DoctorRepo.GetDoctorDashboardStats(currentDoctor.DoctorId);
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && appointmentGrid != null)
        {
            await appointmentGrid.Reload();
            StateHasChanged();
        }
    }

    bool IsOnShift(Appointment appt)
    {
        if (currentDoctor == null) return false;
        // Optimization: Ensure we don't call DB too many times if possible,
        // but for now, simple check
        return ShiftRepo.IsAvailableAtTime(currentDoctor.DoctorId, appt.AppointmentDate);
    }

    async Task LoadAppointmentsData(LoadDataArgs args)
    {
        // Even if currentDoctor is null initially, we shouldn't fail.
        // We'll return empty until initialized.
        if (currentDoctor == null)
        {
            appointments = new List<Appointment>();
            appointmentCount = 0;
            return;
        }

        isLoading = true;

        var skip = args.Skip ?? 0;
        var top = args.Top ?? 10;
        var orderBy = args.OrderBy;
        if (string.IsNullOrEmpty(orderBy)) orderBy = "AppointmentDate DESC";

        appointments = AppointmentRepo.GetAppointmentsByDoctorIdPaged(currentDoctor.DoctorId, skip, top, orderBy);
        appointmentCount = AppointmentRepo.GetAppointmentsByDoctorIdCount(currentDoctor.DoctorId);

        isLoading = false;
        StateHasChanged();
    }

    BadgeStyle GetStatusBadgeStyle(string status)
    {
        return status switch
        {
            "Pending" => BadgeStyle.Warning,
            "Approved" => BadgeStyle.Success,
            "Rejected" => BadgeStyle.Danger,
            "Completed" => BadgeStyle.Info,
            _ => BadgeStyle.Light
        };
    }

    async Task ApproveAppointment(Appointment appt)
    {
        try
        {
            AppointmentRepo.UpdateAppointmentStatus(appt.AppointmentId, "Approved");
            NotificationService.Notify(NotificationSeverity.Success, "Appointment Approved");
            await appointmentGrid.Reload();
            stats = DoctorRepo.GetDoctorDashboardStats(currentDoctor!.DoctorId);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Action Failed", ex.Message);
        }
    }

    async Task RejectAppointment(Appointment appt)
    {
        try
        {
            var result = await DialogService.OpenAsync<RejectAppointmentDialog>("Reject Appointment",
            new Dictionary<string, object> { { "AppointmentId", appt.AppointmentId } },
            new DialogOptions { Width = "500px", Height = "auto", Resizable = true, Draggable = true });

            if (result == true)
            {
                await appointmentGrid.Reload();
                stats = DoctorRepo.GetDoctorDashboardStats(currentDoctor!.DoctorId);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Dialog Error", ex.Message);
        }
    }

    void OnAppointmentSelect(Appointment appt)
    {
        // Potentially open details
    }
}
