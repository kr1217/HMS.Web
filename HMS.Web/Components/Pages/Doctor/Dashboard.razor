@page "/Doctor/Dashboard"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using HMS.Web.Models
@using HMS.Web.DAL
@using HMS.Web.Data
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@attribute [Authorize(Roles = "Doctor")]
@inject DoctorRepository DoctorRepo
@inject DoctorShiftRepository ShiftRepo
@inject AppointmentRepository AppointmentRepo
@inject NotificationRepository NotificationRepo
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav

<div class="container-fluid mt-4">
    @if (CurrentDoctor == null)
    {
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Complete Your Professional Profile</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Welcome, Doctor! Please complete your profile to start managing your practice.</p>
                        <EditForm Model="NewDoctor" OnValidSubmit="CreateProfile" FormName="DoctorProfileForm">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Full Name</label>
                                    <InputText @bind-Value="NewDoctor.FullName" class="form-control" placeholder="Dr. Name" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Contact Number</label>
                                    <InputText @bind-Value="NewDoctor.ContactNumber" class="form-control" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Gender</label>
                                    <InputSelect @bind-Value="NewDoctor.Gender" class="form-select">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </InputSelect>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <InputText @bind-Value="NewDoctor.Email" class="form-control" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Qualification</label>
                                    <InputText @bind-Value="NewDoctor.Qualification" class="form-control" placeholder="MBBS, FCPS, etc." />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Specialization</label>
                                    <InputText @bind-Value="NewDoctor.Specialization" class="form-control" placeholder="Cardiology, etc." />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Medical License Number</label>
                                    <InputText @bind-Value="NewDoctor.MedicalLicenseNumber" class="form-control" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Years of Experience</label>
                                    <InputNumber @bind-Value="NewDoctor.YearsOfExperience" class="form-control" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Consultation Fee</label>
                                    <InputNumber @bind-Value="NewDoctor.ConsultationFee" class="form-control" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Department</label>
                                    <InputSelect @bind-Value="NewDoctor.DepartmentId" class="form-select">
                                        <option value="0">Select Department</option>
                                        <option value="1">Cardiology</option>
                                        <option value="2">Orthopedics</option>
                                        <option value="3">Pediatrics</option>
                                        <option value="4">Neurology</option>
                                        <option value="5">Dermatology</option>
                                    </InputSelect>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary w-100">Save and Continue</button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Sidebar / Stats -->
            <div class="col-lg-3">
                <div class="card border-0 shadow-sm mb-4 bg-primary text-white text-center p-4">
                    <div class="mb-3">
                        <i class="bi bi-person-circle fs-1"></i>
                    </div>
                    <h4 class="mb-0">@CurrentDoctor.FullName</h4>
                    <p class="mb-0 small opacity-75">@CurrentDoctor.Specialization</p>
                    <hr class="bg-white opacity-25" />
                    <div class="d-flex justify-content-around">
                        <div>
                            <div class="fw-bold">@PendingAppointments.Count</div>
                            <div class="small opacity-75">Pending</div>
                        </div>
                        <div>
                            <div class="fw-bold">@TodayAppointments.Count</div>
                            <div class="small opacity-75">Today</div>
                        </div>
                    </div>
                </div>

                <div class="list-group shadow-sm border-0 mb-4">
                    <a href="/Doctor/Dashboard?tab=dashboard" class="list-group-item list-group-item-action @(ActiveTab == "dashboard" ? "active" : "")">
                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                    </a>
                    <a href="/Doctor/Dashboard?tab=shifts" class="list-group-item list-group-item-action @(ActiveTab == "shifts" ? "active" : "")">
                        <i class="bi bi-clock-history me-2"></i> My Shifts
                    </a>
                    <a href="/Doctor/Dashboard?tab=appointments" class="list-group-item list-group-item-action @(ActiveTab == "appointments" ? "active" : "")">
                        <i class="bi bi-calendar-event me-2"></i> Appointment Requests
                        @if (PendingAppointments.Any())
                        {
                            <span class="badge bg-danger rounded-pill float-end">@PendingAppointments.Count</span>
                        }
                    </a>
                    <a href="/Doctor/Dashboard?tab=patients" class="list-group-item list-group-item-action @(ActiveTab == "patients" ? "active" : "")">
                        <i class="bi bi-people me-2"></i> My Patients
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                @if (ActiveTab == "dashboard")
                {
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2 class="mb-3 fw-bold">Doctor Dashboard</h2>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm bg-info text-white p-3 mb-3">
                                <div class="small fw-bold">Active Cases</div>
                                <div class="fs-2 fw-bold">12</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm bg-success text-white p-3 mb-3">
                                <div class="small fw-bold">Completed Today</div>
                                <div class="fs-2 fw-bold">@TodayAppointments.Count(a => a.Status == "Completed")</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm bg-warning text-dark p-3 mb-3">
                                <div class="small fw-bold">Revenue Today</div>
                                <div class="fs-2 fw-bold">@((TodayAppointments.Count(a => a.Status == "Completed") * CurrentDoctor.ConsultationFee).ToString("C0"))</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Shift Overview -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-bottom-0 pt-3">
                            <h5 class="mb-0">This Week's Schedule</h5>
                        </div>
                        <div class="card-body">
                            @if (!DoctorShifts.Any())
                            {
                                <div class="text-center py-4 text-muted">
                                    <i class="bi bi-calendar-x fs-1"></i>
                                    <p class="mt-2">No shifts configured. <a href="/Doctor/Dashboard?tab=shifts">Add your shifts</a></p>
                                </div>
                            }
                            else
                            {
                                <div class="row">
                                    @foreach (var shift in DoctorShifts.Take(7))
                                    {
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-center p-2 border rounded">
                                                <div class="me-3">
                                                    <i class="bi bi-calendar-check text-primary fs-4"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-bold">@shift.DayOfWeek</div>
                                                    <div class="small text-muted">@($"{shift.StartTime.Hours:D2}:{shift.StartTime.Minutes:D2}") - @($"{shift.EndTime.Hours:D2}:{shift.EndTime.Minutes:D2}")</div>
                                                </div>
                                                @if (!string.IsNullOrEmpty(shift.ShiftType))
                                                {
                                                    <span class="badge bg-secondary">@shift.ShiftType</span>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-bottom-0 pt-3">
                            <h5 class="mb-0">Today's Schedule</h5>
                        </div>
                        <div class="card-body">
                            @if (!TodayAppointments.Any())
                            {
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-calendar-x fs-1"></i>
                                    <p class="mt-2">No appointments scheduled for today.</p>
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table align-middle">
                                        <thead>
                                            <tr>
                                                <th>Patient</th>
                                                <th>Time</th>
                                                <th>Type</th>
                                                <th>Status</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var appt in TodayAppointments)
                                            {
                                                <tr>
                                                    <td>@appt.PatientName</td>
                                                    <td>@appt.AppointmentDate.ToShortTimeString()</td>
                                                    <td>@appt.AppointmentMode</td>
                                                    <td>
                                                        <span class="badge @(appt.Status == "Approved" ? "bg-success" : "bg-primary")">@appt.Status</span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary">View</button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>
                }
                else if (ActiveTab == "shifts")
                {
                    <div class="row">
                        <div class="col-12">
                            <h2 class="mb-3 fw-bold">Manage Shifts</h2>
                        </div>
                        
                        <!-- Add Shift Form -->
                        <div class="col-md-5 mb-4">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">@(EditingShift == null ? "Add New Shift" : "Edit Shift")</h5>
                                </div>
                                <div class="card-body">
                                    <EditForm Model="NewShift" OnValidSubmit="SaveShift" FormName="ShiftForm">
                                        <DataAnnotationsValidator />
                                        <ValidationSummary class="text-danger" />

                                        <div class="mb-3">
                                            <label class="form-label">Day of Week <span class="text-danger">*</span></label>
                                            <InputSelect @bind-Value="NewShift.DayOfWeek" class="form-select">
                                                <option value="">Select Day</option>
                                                <option value="Monday">Monday</option>
                                                <option value="Tuesday">Tuesday</option>
                                                <option value="Wednesday">Wednesday</option>
                                                <option value="Thursday">Thursday</option>
                                                <option value="Friday">Friday</option>
                                                <option value="Saturday">Saturday</option>
                                                <option value="Sunday">Sunday</option>
                                            </InputSelect>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Start Time <span class="text-danger">*</span></label>
                                                <input type="time" @bind="StartTimeInput" class="form-control" required />
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">End Time <span class="text-danger">*</span></label>
                                                <input type="time" @bind="EndTimeInput" class="form-control" required />
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Shift Type</label>
                                            <InputSelect @bind-Value="NewShift.ShiftType" class="form-select">
                                                <option value="">Select Type (Optional)</option>
                                                <option value="Morning">Morning</option>
                                                <option value="Evening">Evening</option>
                                                <option value="Night">Night</option>
                                                <option value="Full Day">Full Day</option>
                                            </InputSelect>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Notes</label>
                                            <InputTextArea @bind-Value="NewShift.Notes" class="form-control" rows="2" placeholder="Optional notes..." />
                                        </div>

                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary flex-grow-1">
                                                <i class="bi bi-save me-1"></i> @(EditingShift == null ? "Add Shift" : "Update Shift")
                                            </button>
                                            @if (EditingShift != null)
                                            {
                                                <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                                            }
                                        </div>
                                    </EditForm>
                                </div>
                            </div>
                        </div>

                        <!-- Shifts List -->
                        <div class="col-md-7">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white border-bottom-0 pt-3">
                                    <h5 class="mb-0">Your Shifts</h5>
                                </div>
                                <div class="card-body">
                                    @if (!DoctorShifts.Any())
                                    {
                                        <div class="text-center py-5 text-muted">
                                            <i class="bi bi-calendar-x fs-1"></i>
                                            <p class="mt-2">No shifts added yet.</p>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="list-group">
                                            @foreach (var shift in DoctorShifts)
                                            {
                                                <div class="list-group-item">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex align-items-center mb-1">
                                                                <h6 class="mb-0 me-2">@shift.DayOfWeek</h6>
                                                                @if (!string.IsNullOrEmpty(shift.ShiftType))
                                                                {
                                                                    <span class="badge bg-info">@shift.ShiftType</span>
                                                                }
                                                            </div>
                                                            <div class="text-muted small">
                                                                <i class="bi bi-clock me-1"></i>
                                                                @FormatTime(shift.StartTime) - @FormatTime(shift.EndTime)
                                                            </div>
                                                            @if (!string.IsNullOrEmpty(shift.Notes))
                                                            {
                                                                <div class="text-muted small mt-1">
                                                                    <i class="bi bi-sticky me-1"></i>@shift.Notes
                                                                </div>
                                                            }
                                                        </div>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-primary" @onclick="() => EditShift(shift)">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger" @onclick="() => DeleteShift(shift.ShiftId)">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (ActiveTab == "appointments")
                {
                    <div class="row">
                        <div class="col-12">
                            <h2 class="mb-3 fw-bold">Appointment Requests</h2>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(StatusMessage))
                        {
                            <div class="col-12 mb-3">
                                <div class="alert @StatusMessageClass alert-dismissible fade show" role="alert">
                                    @StatusMessage
                                    <button type="button" class="btn-close" @onclick='() => StatusMessage = ""' aria-label="Close"></button>
                                </div>
                            </div>
                        }

                        @if (!PendingAppointments.Any())
                        {
                            <div class="col-12">
                                <div class="card border-0 shadow-sm p-5 text-center text-muted">
                                    <i class="bi bi-clock-history fs-1 mb-3"></i>
                                    <h5>No pending requests at the moment.</h5>
                                </div>
                            </div>
                        }
                        else
                        {
                            @foreach (var appt in PendingAppointments)
                            {
                                var isAvailable = ShiftRepo.IsAvailableAtTime(CurrentDoctor.DoctorId, appt.AppointmentDate);
                                var dayShifts = DoctorShifts.Where(s => s.DayOfWeek == appt.AppointmentDate.DayOfWeek.ToString()).ToList();
                                
                                <div class="col-md-6 mb-3">
                                    <div class="card border-0 shadow-sm h-100 @(isAvailable ? "" : "border-warning border-2")">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h5 class="mb-0 fw-bold">@appt.PatientName</h5>
                                                <span class="badge bg-warning text-dark">Pending</span>
                                            </div>
                                            <div class="mb-2 small">
                                                <i class="bi bi-calendar3 me-2 text-primary"></i> @appt.AppointmentDate.ToString("MMM dd, yyyy | hh:mm tt")
                                            </div>
                                            <div class="mb-2 small">
                                                <i class="bi bi-laptop me-2 text-primary"></i> @appt.AppointmentMode
                                            </div>
                                            <div class="mb-3">
                                                <p class="text-muted small"><strong>Reason:</strong> @appt.Reason</p>
                                            </div>

                                            <!-- Availability Check -->
                                            @if (!isAvailable)
                                            {
                                                <div class="alert alert-warning py-2 mb-3">
                                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                                    <strong>Outside shift hours!</strong>
                                                    @if (dayShifts.Any())
                                                    {
                                                        <div class="small mt-1">
                                                            Your shifts on @appt.AppointmentDate.DayOfWeek:
                                                            @foreach (var shift in dayShifts)
                                                            {
                                                                <div>• @FormatTime(shift.StartTime) - @FormatTime(shift.EndTime)</div>
                                                            }
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="small">No shifts scheduled for @appt.AppointmentDate.DayOfWeek</div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="alert alert-success py-2 mb-3">
                                                    <i class="bi bi-check-circle me-1"></i> Within your shift hours
                                                </div>
                                            }

                                            <div class="d-flex gap-2">
                                                <button class="btn btn-primary btn-sm flex-grow-1" @onclick="() => ApproveAppointment(appt)">
                                                    <i class="bi bi-check-lg me-1"></i>Approve
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" @onclick="() => ShowRejectModal(appt)">
                                                    <i class="bi bi-x-lg me-1"></i>Reject
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
                else if (ActiveTab == "patients")
                {
                    <div class="row">
                        <div class="col-12">
                            <h2 class="mb-3 fw-bold">My Patients</h2>
                        </div>
                        
                        @if (!MyPatients.Any())
                        {
                            <div class="col-12 text-center text-muted py-5">
                                <i class="bi bi-people fs-1"></i>
                                <p class="mt-2">No patients found from your appointment history.</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var patient in MyPatients)
                            {
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                                    @(string.IsNullOrEmpty(patient.PatientName) ? "?" : patient.PatientName.Substring(0, 1).ToUpper())
                                                </div>
                                                <div>
                                                    <h5 class="mb-0 fw-bold">@patient.PatientName</h5>
                                                    <div class="text-muted small">Patient ID: @patient.PatientId</div>
                                                    <div class="text-muted small">Last Visit: @patient.AppointmentDate.ToShortDateString()</div>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-primary flex-grow-1" @onclick="() => NavigateToPrescription(patient.PatientId)">
                                                    <i class="bi bi-file-medical me-2"></i>Prescribe
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Reject Appointment Modal -->
@if (ShowRejectDialog && SelectedAppointment != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reject Appointment</h5>
                    <button type="button" class="btn-close" @onclick="CloseRejectModal"></button>
                </div>
                <div class="modal-body">
                    <p>Patient: <strong>@SelectedAppointment.PatientName</strong></p>
                    <p>Requested Time: <strong>@SelectedAppointment.AppointmentDate.ToString("MMM dd, yyyy | hh:mm tt")</strong></p>
                    
                    <div class="mb-3">
                        <label class="form-label">Reason for Rejection <span class="text-danger">*</span></label>
                        <textarea @bind="RejectionMessage" class="form-control" rows="4" placeholder="Explain why you're rejecting this appointment or suggest alternative times..."></textarea>
                    </div>

                    @if (DoctorShifts.Any())
                    {
                        <div class="alert alert-info">
                            <strong>Your upcoming shifts:</strong>
                            <div class="small mt-2">
                                @foreach (var shift in DoctorShifts.Take(5))
                                {
                                    <div>• @shift.DayOfWeek: @FormatTime(shift.StartTime) - @FormatTime(shift.EndTime)</div>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseRejectModal">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmReject" disabled="@string.IsNullOrWhiteSpace(RejectionMessage)">
                        Send Rejection
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    public string? Tab { get; set; }

    private Doctor? CurrentDoctor;
    [SupplyParameterFromForm]
    private Doctor NewDoctor { get; set; } = new();
    
    [SupplyParameterFromForm]
    private DoctorShift NewShift { get; set; } = new();
    
    private DoctorShift? EditingShift;
    private ApplicationUser? User;
    private string ActiveTab = "dashboard";
    private List<Appointment> AllAppointments = new();
    private List<DoctorShift> DoctorShifts = new();
    private List<Appointment> PendingAppointments => AllAppointments.Where(a => a.Status == "Pending").ToList();
    private List<Appointment> TodayAppointments => AllAppointments.Where(a => a.AppointmentDate.Date == DateTime.Today && a.Status != "Rejected").ToList();
    private List<Appointment> MyPatients => AllAppointments
        .GroupBy(a => a.PatientId)
        .Select(g => g.OrderByDescending(a => a.AppointmentDate).First())
        .ToList();

    private DateTime StartTimeInput { get; set; } = DateTime.Today.AddHours(9);
    private DateTime EndTimeInput { get; set; } = DateTime.Today.AddHours(17);

    private bool ShowRejectDialog = false;
    private Appointment? SelectedAppointment;
    private string RejectionMessage = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userClaims = authState.User;

        if (userClaims.Identity?.IsAuthenticated == true)
        {
            var userId = UserManager.GetUserId(userClaims);
            if (!string.IsNullOrEmpty(userId))
            {
                User = await UserManager.FindByIdAsync(userId);
                CurrentDoctor = DoctorRepo.GetDoctorByUserId(userId);

                if (CurrentDoctor != null)
                {
                    LoadAppointments();
                    LoadShifts();
                }
                else
                {
                    NewDoctor ??= new Doctor();
                    NewDoctor.UserId = userId;
                    NewDoctor.Email = User?.Email ?? "";
                }
            }
        }
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(Tab))
        {
            ActiveTab = Tab;
        }
        
        // Ensure models are never null to prevent EditForm errors
        NewDoctor ??= new();
        NewShift ??= new();
    }

    private void LoadAppointments()
    {
        if (CurrentDoctor != null)
        {
            AllAppointments = AppointmentRepo.GetAppointmentsByDoctorId(CurrentDoctor.DoctorId);
        }
    }

    private void LoadShifts()
    {
        if (CurrentDoctor != null)
        {
            DoctorShifts = ShiftRepo.GetShiftsByDoctorId(CurrentDoctor.DoctorId);
        }
    }

    private async Task CreateProfile()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            
            if (string.IsNullOrEmpty(userId)) 
            {
                StatusMessage = "User ID not found.";
                StatusMessageClass = "alert-danger";
                return;
            }
            if (string.IsNullOrWhiteSpace(NewDoctor.FullName))
            {
                StatusMessage = "Full Name is required.";
                StatusMessageClass = "alert-danger";
                return;
            }
            if (NewDoctor.DepartmentId == 0)
            {
                StatusMessage = "Please select a department.";
                StatusMessageClass = "alert-danger";
                return;
            }
            
            NewDoctor.UserId = userId;
            NewDoctor.IsActive = true;
            NewDoctor.CreatedAt = DateTime.Now;
            NewDoctor.HospitalJoiningDate = DateTime.Now;
            NewDoctor.IsAvailable = true;
            
            DoctorRepo.CreateDoctor(NewDoctor);
            CurrentDoctor = DoctorRepo.GetDoctorByUserId(userId);
            
            if (CurrentDoctor != null)
            {
                LoadAppointments();
                LoadShifts();
                // Refresh full page or just state?
                StatusMessage = "Profile created successfully!";
                StatusMessageClass = "alert-success";
            }
            else 
            {
                StatusMessage = "Profile created but could not be loaded.";
                StatusMessageClass = "alert-warning";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating profile: {ex}");
            StatusMessage = $"Error creating profile: {ex.Message}";
            StatusMessageClass = "alert-danger";
        }
        StateHasChanged();
    }

    private void SaveShift()
    {
        if (CurrentDoctor == null) return;
        if (string.IsNullOrWhiteSpace(NewShift.DayOfWeek)) return;

        NewShift.StartTime = StartTimeInput.TimeOfDay;
        NewShift.EndTime = EndTimeInput.TimeOfDay;
        NewShift.DoctorId = CurrentDoctor.DoctorId;
        NewShift.IsActive = true;
        NewShift.CreatedAt = DateTime.Now;

        if (EditingShift != null)
        {
            NewShift.ShiftId = EditingShift.ShiftId;
            ShiftRepo.UpdateShift(NewShift);
            EditingShift = null;
        }
        else
        {
            ShiftRepo.CreateShift(NewShift);
        }

        LoadShifts();
        NewShift = new DoctorShift();
        StartTimeInput = DateTime.Today.AddHours(9);
        EndTimeInput = DateTime.Today.AddHours(17);
    }

    private void EditShift(DoctorShift shift)
    {
        EditingShift = shift;
        NewShift = new DoctorShift
        {
            ShiftId = shift.ShiftId,
            DoctorId = shift.DoctorId,
            DayOfWeek = shift.DayOfWeek,
            StartTime = shift.StartTime,
            EndTime = shift.EndTime,
            ShiftType = shift.ShiftType,
            Notes = shift.Notes,
            IsActive = shift.IsActive
        };
        StartTimeInput = DateTime.Today.Add(shift.StartTime);
        EndTimeInput = DateTime.Today.Add(shift.EndTime);
        ActiveTab = "shifts";
    }

    private void CancelEdit()
    {
        EditingShift = null;
        NewShift = new DoctorShift();
        StartTimeInput = DateTime.Today.AddHours(9);
        EndTimeInput = DateTime.Today.AddHours(17);
    }

    private void DeleteShift(int shiftId)
    {
        ShiftRepo.DeleteShift(shiftId);
        LoadShifts();
    }

    private string StatusMessage = "";
    private string StatusMessageClass = "";

    private async Task ApproveAppointment(Appointment appt)
    {
        try
        {
            AppointmentRepo.UpdateAppointmentStatus(appt.AppointmentId, "Approved");
            
            try 
            {
                NotificationRepo.CreateNotification(new Notification
                {
                    PatientId = appt.PatientId,
                    DoctorId = CurrentDoctor?.DoctorId,
                    Title = "Appointment Approved",
                    Message = $"Your appointment with Dr. {CurrentDoctor?.FullName} on {appt.AppointmentDate:f} has been approved.",
                    CreatedDate = DateTime.Now,
                    IsRead = false
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Notification failed: {ex.Message}");
            }

            StatusMessage = $"Appointment for {appt.PatientName} has been approved.";
            StatusMessageClass = "alert-success";
            
            LoadAppointments();
            await InvokeAsync(StateHasChanged);

            // Auto-clear message
            _ = Task.Run(async () =>
            {
                await Task.Delay(5000);
                StatusMessage = "";
                await InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error approving appointment: {ex.Message}";
            StatusMessageClass = "alert-danger";
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ShowRejectModal(Appointment appt)
    {
        SelectedAppointment = appt;
        RejectionMessage = "";
        ShowRejectDialog = true;
    }

    private void CloseRejectModal()
    {
        ShowRejectDialog = false;
        SelectedAppointment = null;
        RejectionMessage = "";
    }

    private async Task ConfirmReject()
    {
        if (SelectedAppointment == null || string.IsNullOrWhiteSpace(RejectionMessage)) return;

        try
        {
            var patientName = SelectedAppointment.PatientName;
            AppointmentRepo.UpdateAppointmentStatus(SelectedAppointment.AppointmentId, "Rejected", rejectionReason: RejectionMessage);
            
            try
            {
                NotificationRepo.CreateNotification(new Notification
                {
                    PatientId = SelectedAppointment.PatientId,
                    DoctorId = CurrentDoctor?.DoctorId,
                    Title = "Appointment Rejected",
                    Message = $"Your appointment request for {SelectedAppointment.AppointmentDate:f} was rejected. Reason: {RejectionMessage}",
                    CreatedDate = DateTime.Now,
                    IsRead = false
                });
            }
            catch (Exception ex)
            {
                 Console.WriteLine($"Notification failed: {ex.Message}");
            }

            StatusMessage = $"Appointment for {patientName} has been rejected.";
            StatusMessageClass = "alert-warning";

            LoadAppointments();
            CloseRejectModal();
            await InvokeAsync(StateHasChanged);

            // Auto-clear message
            _ = Task.Run(async () =>
            {
                await Task.Delay(5000);
                StatusMessage = "";
                await InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error rejecting appointment: {ex.Message}";
            StatusMessageClass = "alert-danger";
            await InvokeAsync(StateHasChanged);
        }
    }

    private string FormatTime(TimeSpan time)
    {
        return DateTime.Today.Add(time).ToString("hh:mm tt");
    }

    private void NavigateToPrescription(int patientId)
    {
        Nav.NavigateTo($"/Doctor/Prescribe/{patientId}");
    }
}
