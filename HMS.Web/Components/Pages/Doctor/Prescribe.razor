@*
 * FILE: Prescribe.razor
 * PURPOSE: Doctor-facing component for clinical management.
 * COMMUNICATES WITH: DoctorRepository, AppointmentRepository, PrescriptionRepository, NotificationRepository
*@
@page "/Doctor/Prescribe/{PatientId:int}"
@using Microsoft.AspNetCore.Authorization
@using HMS.Web.Models
@using HMS.Web.DAL
@using HMS.Web.Data
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using System.Text.Json
@attribute [Authorize(Roles = "Doctor")]
@rendermode InteractiveServer
@inject DoctorRepository DoctorRepo
@inject AppointmentRepository AppointmentRepo
@inject PrescriptionRepository PrescriptionRepo
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav
@inject NotificationRepository NotificationRepo
@inject NotificationService NotificationService
@*
    COMPONENT: Prescription Management
    PURPOSE: Interface for creating and signing digital prescriptions.
    OPTIMIZATION: [Client-Side Validation] Ensures all medications are valid before submission to prevent server errors.
*@

<RadzenStack Class="rz-p-4" Gap="2rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0">
            <RadzenText Text="Clinical Prescription Management" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
            @if (!string.IsNullOrEmpty(PatientName))
            {
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                    <RadzenText Text="@($"Patient: {PatientName}")" TextStyle="TextStyle.Subtitle2" Class="rz-m-0" />
                    <RadzenBadge Text="@($"#PAT-{PatientId}")" BadgeStyle="BadgeStyle.Light" IsPill="true" />
                </RadzenStack>
            }
        </RadzenStack>
        <RadzenButton Icon="arrow_back" Text="Dashboard" ButtonStyle="ButtonStyle.Light" Click="@GoBack" Variant="Variant.Flat" />
    </RadzenStack>

    @if (CurrentDoctor == null)
    {
        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
            <RadzenText Text="Authenticating clinician session..." TextStyle="TextStyle.Caption" />
        </RadzenStack>
    }
    else
    {
        <RadzenRow Gap="2rem">
            <RadzenColumn Size="12" SizeLG="8">
                <RadzenStack Gap="1.5rem">
                    <!-- Medications Section -->
                    <RadzenCard Class="rz-p-4 rz-shadow-2" Style="border-radius: 12px;">
                        <RadzenText Text="Medication Regimen" TextStyle="TextStyle.H6" Class="rz-mb-4 rz-color-primary" />
                        
                        <!-- Add Medicine Row -->
                        <RadzenRow Gap="1rem" Class="rz-mb-4 rz-p-4 rz-background-color-base-100 rz-border-radius-2">
                            <RadzenColumn Size="12" SizeMD="3">
                                <RadzenFormField Text="Medicine Name" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="NewMed.Name" MaxLength="100" />
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="2">
                                <RadzenFormField Text="Dosage" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="NewMed.Dosage" Placeholder="500mg" />
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="2">
                                <RadzenFormField Text="Frequency" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="NewMed.Frequency" Placeholder="1-0-1" />
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="2">
                                <RadzenFormField Text="Duration" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="NewMed.Duration" Placeholder="5 days" />
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="2">
                                <RadzenFormField Text="Instructions" Style="width: 100%;">
                                    <RadzenTextBox @bind-Value="NewMed.Instructions" Placeholder="After meal" />
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="1" Class="rz-display-flex rz-align-items-center rz-justify-content-center">
                                <RadzenButton Icon="add" ButtonStyle="ButtonStyle.Primary" Click="@AddMedicine" Disabled="@string.IsNullOrWhiteSpace(NewMed.Name)" Tooltip="Add to list" />
                            </RadzenColumn>
                        </RadzenRow>

                        <!-- Medications Grid -->
                        <RadzenDataGrid Data="@MedicationsList" TItem="PrescriptionMedication" Class="rz-border-none" EmptyText="No medications added to this prescription yet.">
                            <Columns>
                                <RadzenDataGridColumn TItem="PrescriptionMedication" Property="Name" Title="Medicine" Width="200px">
                                    <Template Context="med">
                                        <RadzenText Text="@med.Name" TextStyle="TextStyle.Subtitle2" Class="rz-m-0 rz-color-primary" />
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="PrescriptionMedication" Property="Dosage" Title="Dosage" />
                                <RadzenDataGridColumn TItem="PrescriptionMedication" Property="Frequency" Title="Freq" />
                                <RadzenDataGridColumn TItem="PrescriptionMedication" Property="Duration" Title="Period" />
                                <RadzenDataGridColumn TItem="PrescriptionMedication" Title="Instructions">
                                    <Template Context="med">
                                        <RadzenText Text="@med.Instructions" TextStyle="TextStyle.Caption" Style="white-space: normal;" />
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="PrescriptionMedication" Title="Action" Width="70px" TextAlign="TextAlign.Center">
                                    <Template Context="med">
                                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" Variant="Variant.Text" Click="@(() => RemoveMedicine(med))" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    </RadzenCard>

                    <!-- Additional Details -->
                    <RadzenCard Class="rz-p-4 rz-shadow-2" Style="border-radius: 12px;">
                        <RadzenText Text="Clinical Notes & Diagnosis" TextStyle="TextStyle.H6" Class="rz-mb-4 rz-color-primary" />
                        <RadzenFormField Text="Observation details / Clinical remarks" Style="width: 100%;">
                            <RadzenTextArea @bind-Value="PrescriptionDetails" Rows="4" Placeholder="Document symptoms, findings, and clinical advice..." />
                        </RadzenFormField>
                    </RadzenCard>

                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem">
                        <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@GoBack" />
                        <RadzenButton Text="Finalize & Sign" Icon="border_color" ButtonStyle="ButtonStyle.Primary" Click="@SavePrescription" Class="rz-px-8" />
                    </RadzenStack>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Clase="rz-mt-4">
                            @ErrorMessage
                        </RadzenAlert>
                    }
                </RadzenStack>
            </RadzenColumn>

            <!-- Patient History -->
            <RadzenColumn Size="12" SizeLG="4">
                <RadzenCard Class="rz-p-4 rz-background-color-base-100" Style="border-radius: 12px; height: 100%;">
                    <RadzenText Text="Clinical Timeline" TextStyle="TextStyle.H6" Class="rz-mb-4" />
                    @if (PatientAppointments.Any())
                    {
                        <RadzenStack Gap="1rem">
                            @foreach (var appt in PatientAppointments.OrderByDescending(a => a.AppointmentDate).Take(10))
                            {
                                <RadzenCard Class="rz-p-3 rz-shadow-1" Style="border-radius: 8px;">
                                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                        <RadzenText Text="@appt.AppointmentDate.ToString("MMM dd, yyyy")" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                                        <RadzenBadge Text="@appt.Status" BadgeStyle="@(appt.Status == "Completed" ? BadgeStyle.Success : BadgeStyle.Info)" Shade="Shade.Lighter" />
                                    </RadzenStack>
                                    <RadzenText Text="@appt.Reason" TextStyle="TextStyle.Body2" Class="rz-mt-2 rz-color-text-secondary" Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" />
                                </RadzenCard>
                            }
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenStack AlignItems="AlignItems.Center" Class="rz-py-12">
                            <RadzenIcon Icon="event_busy" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                            <RadzenText Text="No prior appointment history discovered." TextStyle="TextStyle.Caption" Class="rz-text-align-center" />
                        </RadzenStack>
                    }
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

@code {
    [Parameter]
    public int PatientId { get; set; }

    [SupplyParameterFromQuery]
    public int? AppointmentId { get; set; }

    private Doctor? CurrentDoctor;
    private string PatientName = "";
    private List<Appointment> PatientAppointments = new();

    private PrescriptionMedication NewMed = new();
    private List<PrescriptionMedication> MedicationsList = new();
    private string PrescriptionDetails = "";
    private string ErrorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userClaims = authState.User;

            if (userClaims.Identity?.IsAuthenticated == true)
            {
                var userId = UserManager.GetUserId(userClaims);
                if (!string.IsNullOrEmpty(userId))
                {
                    CurrentDoctor = DoctorRepo.GetDoctorByUserId(userId);
                }
            }

            if (CurrentDoctor != null)
            {
                PatientAppointments = AppointmentRepo.GetAppointmentsByPatientId(PatientId);
                var firstAppt = PatientAppointments.FirstOrDefault();
                if (firstAppt != null)
                {
                    PatientName = firstAppt.PatientName;
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Initialization Error", ex.Message);
        }
    }

    private void AddMedicine()
    {
        if (!string.IsNullOrWhiteSpace(NewMed.Name))
        {
            MedicationsList.Add(new PrescriptionMedication
                {
                    Name = NewMed.Name,
                    Dosage = NewMed.Dosage,
                    Frequency = NewMed.Frequency,
                    Duration = NewMed.Duration,
                    Instructions = NewMed.Instructions
                });
            NewMed = new PrescriptionMedication();
        }
    }

    private void RemoveMedicine(PrescriptionMedication item)
    {
        MedicationsList.Remove(item);
    }

    private void SavePrescription()
    {
        try
        {
            ErrorMessage = "";

            // Auto-add if user typed in medicine but didn't click Add
            if (!string.IsNullOrWhiteSpace(NewMed.Name))
            {
                AddMedicine();
            }

            if (!MedicationsList.Any() && string.IsNullOrWhiteSpace(PrescriptionDetails))
            {
                ErrorMessage = "Please add at least one medication or enter diagnosis/notes.";
                return;
            }

            if (CurrentDoctor == null) return;

            var prescription = new Prescription
                {
                    PatientId = PatientId,
                    DoctorId = CurrentDoctor.DoctorId,
                    AppointmentId = AppointmentId,
                    PrescribedDate = DateTime.Now,
                    Details = PrescriptionDetails,
                    Medications = JsonSerializer.Serialize(MedicationsList),
                    IsLocked = true,
                    DigitalSignature = $"Digitally Signed by Dr. {CurrentDoctor.FullName} ({CurrentDoctor.MedicalLicenseNumber}) on {DateTime.Now:yyyy-MM-dd HH:mm:ss}"
                };

            PrescriptionRepo.CreatePrescription(prescription);

            // Mark appointment as Completed if linked
            if (AppointmentId.HasValue)
            {
                 AppointmentRepo.UpdateAppointmentStatus(AppointmentId.Value, "Completed");
            }

            NotificationRepo.CreateNotification(new Notification
            {
                PatientId = PatientId,
                Title = "New Prescription",
                Message = $"Dr. {CurrentDoctor.FullName} has issued a new prescription for you.",
                CreatedDate = DateTime.Now,
                IsRead = false
            });

            Nav.NavigateTo("/Doctor/Dashboard?tab=patients");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Submission Error", $"Failed to save prescription: {ex.Message}");
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/Doctor/Dashboard");
    }
}

