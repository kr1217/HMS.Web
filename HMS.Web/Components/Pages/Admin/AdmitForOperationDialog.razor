@using HMS.Web.Models
@using HMS.Web.DAL
@inject FacilityRepository FacilityRepo
@inject OperationRepository OperationRepo
@inject NotificationRepository NotificationRepo
@inject BillingRepository BillingRepo
@inject FinanceRepository FinanceRepo
@inject DialogService DialogService
@inject NotificationService NotificationService

<RadzenStack Gap="1.5rem" Class="rz-p-2">
    <!-- Clinical Context Overview -->
    <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="clinical_notes">
        <RadzenStack Gap="0.5rem">
            <RadzenText Text="Clinical Recommendation Overview" TextStyle="TextStyle.Subtitle2" Class="rz-font-weight-bold" />
            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenText Text="@($"Procedure: {Operation.PackageName}")" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                    <RadzenText Text="@($"Consultation Findings: {Operation.Notes}")" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenText Text="@($"Medication Protocol: {Operation.RecommendedMedicines}")" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                    <RadzenText Text="@($"Resource Requirements: {Operation.RecommendedEquipment}")" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>
    </RadzenAlert>

    <RadzenTemplateForm TItem="Admission" Data="@CurrentAdmission" Submit="ConfirmAdmission">
        <RadzenStack Gap="1.5rem">
            <!-- Approved Estimations -->
            <RadzenCard Class="rz-shadow-2">
                <RadzenText Text="Agreed Clinical Estimations" TextStyle="TextStyle.Subtitle2" Class="rz-color-primary rz-border-bottom rz-pb-2 rz-mb-4" />
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.25rem">
                            <RadzenLabel Text="Surgical Base Cost" TextStyle="TextStyle.Caption" />
                            <RadzenNumeric @bind-Value="AgreedOpCost" Class="rz-w-100" Format="C" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.25rem">
                            <RadzenLabel Text="Medicine Allocation" TextStyle="TextStyle.Caption" />
                            <RadzenNumeric @bind-Value="AgreedMedCost" Class="rz-w-100" Format="C" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.25rem">
                            <RadzenLabel Text="Infrastructure/Eq" TextStyle="TextStyle.Caption" />
                            <RadzenNumeric @bind-Value="AgreedEqCost" Class="rz-w-100" Format="C" />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
                <RadzenText Text="These estimations serve as the fiscal baseline for finalized billing audits." TextStyle="TextStyle.Overline" Class="rz-color-text-secondary rz-mt-2" />
            </RadzenCard>

            <!-- Finance Workflow -->
            <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="account_balance">
                <RadzenStack Gap="0.25rem">
                    <RadzenText Text="Fiscal Advance Required" TextStyle="TextStyle.Subtitle2" Class="rz-font-weight-bold" />
                    <RadzenText Text="A financial deposit request will be dispatched to the Teller. Procedural finalization depends on fiscal clearance." TextStyle="TextStyle.Caption" />
                </RadzenStack>
            </RadzenAlert>

            <!-- Resource Orchestration -->
            <RadzenCard Class="rz-shadow-3">
                <RadzenText Text="Resource & Theater Orchestration" TextStyle="TextStyle.Subtitle2" Class="rz-color-primary rz-border-bottom rz-pb-2 rz-mb-4" />
                <RadzenRow Gap="1.5rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Orchestrated Start Time" TextStyle="TextStyle.Subtitle2" />
                            <RadzenDatePicker @bind-Value="ScheduledTime" ShowTime="true" HourFormat="12" DateFormat="MM/dd/yyyy h:mm tt" 
                                            Change="@(args => OnTheaterChange())" Class="rz-w-100" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Estimated Duration (Minutes)" TextStyle="TextStyle.Subtitle2" />
                            <RadzenNumeric TValue="int" @bind-Value="DurationMinutes" Min="15" Step="15" 
                                         Change="@(args => OnTheaterChange())" Class="rz-w-100" />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenStack Gap="0.5rem" Class="rz-mt-4">
                    <RadzenLabel Text="Operation Theater Designation" TextStyle="TextStyle.Subtitle2" />
                    <RadzenDropDown Data="@Theaters" TextProperty="TheaterName" ValueProperty="TheaterId"
                                    @bind-Value="SelectedTheaterId" Change="@OnTheaterChange" Class="rz-w-100" 
                                    Placeholder="Select sterile theater..." />
                    
                    @if (ConflictCount > 0)
                    {
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem" Class="rz-color-warning">
                            <RadzenIcon Icon="warning" Size="16px" />
                            <RadzenText Text="Operational Overlap: Theater is occupied during this window." TextStyle="TextStyle.Caption" />
                        </RadzenStack>
                    }
                    else if (SelectedTheaterId != null)
                    {
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem" Class="rz-color-success">
                            <RadzenIcon Icon="check_circle" Size="16px" />
                            <RadzenText Text="Resources Available" TextStyle="TextStyle.Caption" />
                        </RadzenStack>
                    }
                </RadzenStack>
            </RadzenCard>

            <RadzenAlert AlertStyle="AlertStyle.Light" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="bed">
                Specific clinical ward and bed assignment will be orchestrated post-procedural transfer.
            </RadzenAlert>

            <!-- Actions -->
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-6">
                @if (ConflictCount > 0)
                {
                    <RadzenButton Text="Waitlist Procedure" ButtonStyle="ButtonStyle.Warning" Icon="hourglass_empty" Click="@AddToWaitlist" />
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-ms-2">
                        <RadzenCheckBox @bind-Value="AllowForceSchedule" Name="Force" />
                        <RadzenLabel Text="Overbook Theater" Component="Force" TextStyle="TextStyle.Caption" />
                    </RadzenStack>
                }
                <RadzenButton Text="Discard" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" />
                <RadzenButton ButtonType="ButtonType.Submit" Text="Confirm & Disburse Request" ButtonStyle="ButtonStyle.Success"
                            Icon="check_circle" Disabled="@(ConflictCount > 0 && !AllowForceSchedule)" />
            </RadzenStack>
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenStack>

@code {
    [Parameter] public PatientOperation Operation { get; set; }

    List<OperationTheater> Theaters = new List<OperationTheater>();
    int? SelectedTheaterId;
    int ConflictCount = 0;
    bool AllowForceSchedule = false;

    decimal DepositAmount = 0;
    string PaymentMethod = "Cash";
    bool IsDepositPaid = false;

    Admission CurrentAdmission = new Admission();
    List<Ward> Wards = new List<Ward>();
    List<Bed> AvailableBeds = new List<Bed>();
    int SelectedWardId;

    decimal AgreedOpCost;
    decimal AgreedMedCost;
    decimal AgreedEqCost;
    
    DateTime ScheduledTime = DateTime.Now;
    int DurationMinutes = 60;

    protected override void OnInitialized()
    {
        Wards = FacilityRepo.GetWards();
        Theaters = FacilityRepo.GetTheaters();
        CurrentAdmission.PatientId = Operation.PatientId;
        CurrentAdmission.AdmissionDate = DateTime.Now;

        AgreedOpCost = 5000;
        AgreedMedCost = 500;
        AgreedEqCost = 1000;
        CurrentAdmission.DailyRate = 500;
        DepositAmount = AgreedOpCost * 0.5m;
        
        // Init ScheduledTime from Operation.ScheduledDate if set, else Now
        ScheduledTime = Operation.ScheduledDate > DateTime.MinValue ? Operation.ScheduledDate : DateTime.Now.Date.AddHours(9); // Default 9 AM
    }

    void OnTheaterChange()
    {
        ConflictCount = 0;
        AllowForceSchedule = false;
        
        if (SelectedTheaterId != null)
        {
            var dayOps = OperationRepo.GetOperationsByTheaterAndDate(SelectedTheaterId.Value, ScheduledTime);
            
            // Check for actual time overlap
            var myStart = ScheduledTime;
            var myEnd = ScheduledTime.AddMinutes(DurationMinutes);

            foreach(var op in dayOps)
            {
                // Skip self if editing
                if (op.OperationId == Operation.OperationId) continue;

                var opStart = op.ScheduledDate;
                var opEnd = op.ScheduledDate.AddMinutes(op.DurationMinutes);

                // Overlap formula: (StartA < EndB) and (EndA > StartB)
                if (myStart < opEnd && myEnd > opStart)
                {
                    ConflictCount++;
                }
            }
        }
    }

    void AddToWaitlist()
    {
         OperationRepo.UpdateOperationStatusAndCosts(Operation.OperationId, "Waitlist", AgreedOpCost, AgreedMedCost, AgreedEqCost, SelectedTheaterId);
         NotificationService.Notify(NotificationSeverity.Info, "Waitlisted", "Operation added to waitlist.");
         DialogService.Close(true);
    }

    void ConfirmAdmission()
    {
        if (SelectedTheaterId == null)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Theater Required", "Please specify a surgical theater.");
            return;
        }

        string newStatus = "Advance Payment Requested"; 
        
        var tellerNotif = new Notification
        {
            TargetRole = "Teller",
            Title = "Advance Payment Required",
            Message = $"Patient {Operation.PatientName} is scheduled for {Operation.PackageName}. Please collect advance payment.",
            CreatedDate = DateTime.Now,
            IsRead = false
        };
        NotificationRepo.CreateNotification(tellerNotif);
        
        NotificationService.Notify(NotificationSeverity.Info, "Notification Dispatched", "Financial orchestration initiated with Teller.");

        OperationRepo.UpdateOperationStatusAndCosts(Operation.OperationId, newStatus, AgreedOpCost, AgreedMedCost,
        AgreedEqCost, SelectedTheaterId, ScheduledTime, DurationMinutes);

        var doctorNotif = new Notification
        {
            DoctorId = Operation.DoctorId,
            Title = "Surgery Scheduled (Pending)",
            Message = $"Surgery for {Operation.PatientName} tentatively scheduled. Waiting for deposit.",
            CreatedDate = DateTime.Now,
            IsRead = false
        };
        NotificationRepo.CreateNotification(doctorNotif);

        DialogService.Close(true);
    }
}
