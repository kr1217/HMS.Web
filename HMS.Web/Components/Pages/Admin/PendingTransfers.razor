@page "/admin/pending-transfers"
@layout HMS.Web.Components.Layout.AdminLayout
@rendermode InteractiveServer
@using HMS.Web.Models
@using HMS.Web.DAL
@inject OperationRepository OperationRepo
@inject FacilityRepository FacilityRepo
@inject DialogService DialogService
@inject NotificationService NotificationService
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Post-Op Handover | Admin Control</PageTitle>

<div class="container-fluid p-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-primary mb-0"><i class="bi bi-person-up me-2"></i>Post-Op Handover</h2>
                <p class="text-muted">High-priority patients waiting for ward assignment after surgery.</p>
            </div>
            <RadzenButton Icon="refresh" Text="Refresh List" Click="LoadPending" ButtonStyle="ButtonStyle.Light" />
        </div>
    </div>

    @if (!PendingPatients.Any())
    {
        <RadzenCard Class="rz-p-10 text-center">
            <RadzenIcon Icon="done_all" Style="font-size: 4rem; color: #28a745; margin-bottom: 20px;" />
            <h3>All clear!</h3>
            <p class="text-muted">There are no patients currently waiting for post-operative transfer.</p>
        </RadzenCard>
    }
    else
    {
        <div class="row">
            @foreach (var op in PendingPatients)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <RadzenCard Class="shadow-sm border-0 border-top border-5 border-success position-relative h-100">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="badge bg-success">Surgery Completed</div>
                            <div class="small text-muted">@op.EndDate.ToString("hh:mm tt")</div>
                        </div>

                        <h5 class="mb-1"><strong>@op.PatientName</strong></h5>
                        <div class="mb-3">
                            <div class="small"><i class="bi bi-hospital me-1"></i> Theater: @op.TheaterName</div>
                            <div class="small"><i class="bi bi-person me-1"></i> Surgeon: @op.DoctorName</div>
                            <div class="small fw-bold text-primary mt-1"><i class="bi bi-bookmark-star me-1"></i> Procedure:
                                @op.PackageName</div>
                        </div>

                        <RadzenButton Text="Assign Ward & Bed" Icon="bed" ButtonStyle="ButtonStyle.Primary" Class="w-100"
                            Click="@(() => OpenAdmissionDialog(op))" />
                    </RadzenCard>
                </div>
            }
        </div>
    }
</div>

@code {
    List<PatientOperation> PendingPatients = new();

    protected override void OnInitialized()
    {
        LoadPending();
    }

    void LoadPending()
    {
        PendingPatients = OperationRepo.GetOperationsReadyForTransfer();
    }

    async Task OpenAdmissionDialog(PatientOperation op)
    {
        var result = await DialogService.OpenAsync<AdmissionDialog>($"Post-Op Transfer: {op.PatientName}",
        new Dictionary<string, object> {
{ "PatientId", op.PatientId },
{ "OperationId", op.OperationId }
            },
        new DialogOptions { Width = "600px" });

        if (result == true)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Transferred", "Patient admitted for recovery.");
            LoadPending();
        }
    }
}
