@*
 * FILE: PendingTransfers.razor
 * PURPOSE: Administrative interface for hospital operations.
 * COMMUNICATES WITH: OperationRepository, FacilityRepository
*@
@page "/admin/pending-transfers"
@layout HMS.Web.Components.Layout.AdminLayout
@rendermode InteractiveServer
@using HMS.Web.Models
@using HMS.Web.DAL
@inject OperationRepository OperationRepo
@inject FacilityRepository FacilityRepo
@inject DialogService DialogService
@inject NotificationService NotificationService
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Post-Op Handover | Admin Control</PageTitle>

<RadzenStack Class="rz-p-4 rz-p-md-6" Gap="2rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
        JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0.5rem">
            <RadzenText Text="Post-Operative Handover Control" TextStyle="TextStyle.H4"
                Class="rz-m-0 rz-color-primary" />
            <RadzenText Text="Critical oversight of patients awaiting ward assignment and recovery stabilization."
                TextStyle="TextStyle.Body2" Class="rz-color-text-secondary" />
        </RadzenStack>
        <RadzenButton Icon="refresh" Text="Re-sync Status" ButtonStyle="ButtonStyle.Light" Click="@LoadPending"
            Variant="Variant.Flat" />
    </RadzenStack>

    @if (!PendingPatients.Any())
    {
        <RadzenCard Class="rz-p-12 rz-text-align-center rz-background-color-base-100" Style="border-radius: 20px;">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1.5rem">
                <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center"
                    Style="width: 120px; height: 120px; border-radius: 60px; background: var(--rz-success-lighter);">
                    <RadzenIcon Icon="task_alt" Style="font-size: 5rem; color: var(--rz-success);" />
                </RadzenStack>
                <RadzenStack Gap="0.5rem">
                    <RadzenText Text="Clinical Status: Nominal" TextStyle="TextStyle.H5"
                        Class="rz-m-0 rz-color-success-dark" />
                    <RadzenText Text="No patients currently categorized as 'Awaiting Post-Op Transfer'."
                        TextStyle="TextStyle.Body1" Class="rz-color-text-secondary" />
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenRow Gap="2rem">
            @foreach (var op in PendingPatients)
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                    <RadzenCard Class="rz-p-0 rz-shadow-4" Style="border-radius: 12px; overflow: hidden; height: 100%;">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween"
                            AlignItems="AlignItems.Center" Class="rz-p-3 rz-background-color-success-lighter">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenIcon Icon="check_circle" Style="color: var(--rz-success-dark);" />
                                <RadzenText Text="Surgery Concluded" TextStyle="TextStyle.Caption"
                                    Class="rz-m-0 rz-color-success-dark rz-font-weight-bold" />
                            </RadzenStack>
                            <RadzenText Text="@op.EndDate.ToString("hh:mm tt")" TextStyle="TextStyle.Caption"
                                Class="rz-m-0 rz-color-success-dark" />
                        </RadzenStack>

                        <RadzenStack Class="rz-p-5" Gap="1.5rem">
                            <RadzenStack Gap="0.25rem">
                                <RadzenText Text="@op.PatientName" TextStyle="TextStyle.H6" Class="rz-m-0 rz-color-primary" />
                                <RadzenText Text="@($"#{op.PackageName}")" TextStyle="TextStyle.Overline"
                                    Class="rz-m-0 rz-color-text-secondary" />
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                    <RadzenIcon Icon="meeting_room" Style="color: var(--rz-text-disabled-color);" />
                                    <RadzenText Text="@($"Theater: {op.TheaterName}")" TextStyle="TextStyle.Body2"
                                        Class="rz-m-0" />
                                </RadzenStack>
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                    <RadzenIcon Icon="medical_services" Style="color: var(--rz-text-disabled-color);" />
                                    <RadzenText Text="@($"Lead Surgeon: {op.DoctorName}")" TextStyle="TextStyle.Body2"
                                        Class="rz-m-0" />
                                </RadzenStack>
                            </RadzenStack>
                            <RadzenButton Text="Authorize Transfer" Icon="king_bed" ButtonStyle="ButtonStyle.Primary"
                                Class="rz-w-100" Click="@(() => OpenAdmissionDialog(op))" />
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>
    }
</RadzenStack>

@code {
    List<PatientOperation> PendingPatients = new();

    protected override void OnInitialized()
    {
        LoadPending();
    }

    void LoadPending()
    {
        PendingPatients = OperationRepo.GetOperationsReadyForTransfer();
    }

    async Task OpenAdmissionDialog(PatientOperation op)
    {
        try
        {
            Console.WriteLine($"Opening admission dialog for patient {op.PatientId}, operation {op.OperationId}");

            var result = await DialogService.OpenAsync<AdmissionDialog>($"Post-Op Transfer: {op.PatientName}",
            new Dictionary<string, object> {
{ "PatientId", op.PatientId },
{ "OperationId", op.OperationId }
                },
            new DialogOptions { Width = "700px", Height = "auto", Resizable = true, Draggable = true });

            Console.WriteLine($"Dialog result: {result}");

            if (result == true)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Transferred", "Patient admitted for recovery.");
                LoadPending();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR opening admission dialog: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            NotificationService.Notify(NotificationSeverity.Error, "Dialog Error", $"Failed to open dialog: {ex.Message}");
        }
    }
}

