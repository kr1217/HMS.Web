@*
 * FILE: DischargeDialog.razor
 * PURPOSE: Administrative interface for hospital operations.
 * COMMUNICATES WITH: FacilityRepository, BillingRepository, FinanceRepository, NotificationRepository, OperationRepository
*@
@using Microsoft.AspNetCore.Components.Authorization
@inject FacilityRepository FacilityRepo
@inject BillingRepository BillingRepo
@inject FinanceRepository FinanceRepo
@inject AuthenticationStateProvider AuthProvider
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NotificationRepository NotificationRepo

<RadzenStack Gap="1.5rem" Class="rz-p-2">
    <RadzenCard Class="rz-shadow-2 rz-p-0" Style="overflow: hidden; border-radius: 12px;">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
            Class="rz-p-4 rz-background-color-base-100 rz-border-bottom">
            <RadzenIcon Icon="assignment" Style="color: var(--rz-primary);" />
            <RadzenText Text="Discharge Summary & Audit Setup" TextStyle="TextStyle.Subtitle1"
                Class="rz-m-0 rz-font-weight-bold" />
        </RadzenStack>

        <RadzenStack Gap="1.5rem" Class="rz-p-6">
            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText Text="PATIENT DATA" TextStyle="TextStyle.Caption"
                            Class="rz-color-text-secondary rz-font-weight-bold" />
                        <RadzenText Text="@Admission.PatientName" TextStyle="TextStyle.Subtitle2"
                            Class="rz-m-0 rz-font-weight-bold" />
                        <RadzenText
                            Text="@($"{Admission.WardName} | Room {Admission.BedNumber} ({Admission.RoomTypeName})")"
                            TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6" Class="rz-text-align-center rz-text-align-md-right">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText Text="TEMPORAL DATA" TextStyle="TextStyle.Caption"
                            Class="rz-color-text-secondary rz-font-weight-bold" />
                        <RadzenText Text="@($"Admitted: {Admission.AdmissionDate:MMM dd, yyyy}")"
                            TextStyle="TextStyle.Caption" />
                        <RadzenText Text="@($"Proposed Discharge: {DateTime.Now:MMM dd, yyyy}")"
                            TextStyle="TextStyle.Caption" />
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>
    </RadzenCard>

    <RadzenCard Class="rz-shadow-3">
        <RadzenStack Gap="1.5rem">
            <RadzenText Text="Billing Audit Context" TextStyle="TextStyle.H6" Class="rz-m-0 rz-color-primary" />

            <RadzenDataGrid Data="@Items" TItem="BillItem" Density="Density.Compact" Class="rz-border-radius-1">
                <Columns>
                    <RadzenDataGridColumn TItem="BillItem" Property="Category" Title="Category" Width="130px">
                        <Template Context="item">
                            <RadzenBadge Text="@item.Category" IsPill="true" BadgeStyle="BadgeStyle.Secondary"
                                Shade="Shade.Lighter" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="BillItem" Property="Description" Title="Line Item Description" />
                    <RadzenDataGridColumn TItem="BillItem" Property="Amount" Title="Amount" Width="120px"
                        TextAlign="TextAlign.Right">
                        <Template Context="item">
                            <RadzenText Text="@item.Amount.ToString("C")" TextStyle="TextStyle.Body2"
                                Class="rz-font-weight-bold" />
                        </Template>
                        <FooterTemplate>
                            <RadzenText Text="@TotalAmount.ToString("C")" TextStyle="TextStyle.Subtitle2"
                                Class="rz-font-weight-black rz-color-danger" />
                        </FooterTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="BillItem" Title="" Width="50px" TextAlign="TextAlign.Center">
                        <Template Context="item">
                            @if (item.Category != "Room Charges")
                            {
                                <RadzenButton Icon="delete" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Danger"
                                    Variant="Variant.Flat" Click="@(() => RemoveItem(item))" />
                            }
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

            <RadzenCard Variant="Variant.Flat" Class="rz-background-color-base-100 rz-p-4"
                Style="border: 1px solid var(--rz-border-color-light);">
                <RadzenRow AlignItems="AlignItems.End" Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenStack Gap="0.25rem">
                            <RadzenLabel Text="Category" TextStyle="TextStyle.Caption" />
                            <RadzenDropDown @bind-Value="newItemCategory" Data="@categories" Class="rz-w-100" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.25rem">
                            <RadzenLabel Text="Description" TextStyle="TextStyle.Caption" />
                            <RadzenTextBox @bind-Value="newItemDesc" Class="rz-w-100"
                                Placeholder="Specify service..." />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenStack Gap="0.25rem">
                            <RadzenLabel Text="Amount" TextStyle="TextStyle.Caption" />
                            <RadzenNumeric @bind-Value="newItemAmount" Class="rz-w-100" Format="C" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="2">
                        <RadzenButton Text="Add" Icon="add" ButtonStyle="ButtonStyle.Secondary" Class="rz-w-100"
                            Click="@AddItem" />
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>
        </RadzenStack>
    </RadzenCard>

    <RadzenStack Gap="0.5rem">
        <RadzenLabel Text="Clinical Discharge Notes" TextStyle="TextStyle.Subtitle2" />
        <RadzenTextArea @bind-Value="notes" Rows="2" Class="rz-w-100"
            Placeholder="Provide final clinical summary or follow-up instructions..." />
    </RadzenStack>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-4">
        <RadzenButton Text="Finalize & Send Bill" Icon="account_balance_wallet" ButtonStyle="ButtonStyle.Primary"
            Click="@ConfirmDischarge" />
        <RadzenButton Text="Discard" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public Admission Admission { get; set; } = default!;

    string notes = "";
    List<BillItem> Items = new List<BillItem>();

    // Add Item Form
    string newItemCategory = "Services";
    string newItemDesc = "";
    decimal newItemAmount = 0;
    List<string> categories = new List<string> { "Doctor Fees", "Medicines", "Lab Tests", "Services", "Procedures" };

    decimal TotalAmount => Items.Sum(i => i.Amount);
    int DurationDays => (DateTime.Now - Admission.AdmissionDate).Days == 0 ? 1 : (DateTime.Now -
    Admission.AdmissionDate).Days;

    @inject OperationRepository OperationRepo

    // ... inside code ...
    protected override void OnInitialized()
    {
        // Calculate Room Rent automatically
        Items.Add(new BillItem
            {
                Category = "Room Charges",
                Description = $"Room Rent for {DurationDays} days @ {Admission.DailyRate:C}/day",
                Amount = DurationDays * Admission.DailyRate
            });

        // Load Operations & Recommendations for billing
        var ops = OperationRepo.GetPatientOperations(Admission.PatientId);

        foreach (var op in ops.Where(o => o.Status == "Completed" || o.Status == "Scheduled" || o.Status == "Recommended"))
        {
            // Add Procedure Cost
            Items.Add(new BillItem
                {
                    Category = "Procedures",
                    Description = $"Operation: {op.PackageName}",
                    Amount = op.AgreedOperationCost ?? 0 // Use Agreed Cost if set
                });

            // Add Recommended Items
            if (!string.IsNullOrEmpty(op.RecommendedMedicines))
            {
                string medDesc = $"Rec: {op.RecommendedMedicines}";
                if (medDesc.Length > 250) medDesc = medDesc.Substring(0, 247) + "...";
                Items.Add(new BillItem
                    {
                        Category = "Medicines",
                        Description = medDesc,
                        Amount = op.AgreedMedicineCost ?? 0
                    });
            }

            if (!string.IsNullOrEmpty(op.RecommendedEquipment))
            {
                string eqDesc = $"Rec Eq: {op.RecommendedEquipment}";
                if (eqDesc.Length > 250) eqDesc = eqDesc.Substring(0, 247) + "...";
                Items.Add(new BillItem
                    {
                        Category = "Services",
                        Description = eqDesc,
                        Amount = op.AgreedEquipmentCost ?? 0
                    });
            }
        }
    }

    void AddItem()
    {
        if (newItemAmount > 0 && !string.IsNullOrWhiteSpace(newItemDesc))
        {
            Items.Add(new BillItem
                {
                    Category = newItemCategory,
                    Description = newItemDesc,
                    Amount = newItemAmount
                });
            newItemDesc = "";
            newItemAmount = 0;
        }
    }

    void RemoveItem(BillItem item)
    {
        Items.Remove(item);
    }

    async Task ConfirmDischarge()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        // Fallback for Admin testing if no claim found
        if (string.IsNullOrEmpty(userId))
        {
            userId = user.Identity?.Name;
        }

        if (string.IsNullOrEmpty(userId))
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "User identity not found. Cannot create bill.");
            return;
        }

        // Create Detailed Bill
        var bill = new Bill
            {
                PatientId = Admission.PatientId,
                TotalAmount = TotalAmount,
                PaidAmount = 0,
                Status = "Pending",
                BillDate = DateTime.Now,
                CreatedBy = userId,
                AdmissionId = Admission.AdmissionId,
                Items = Items
            };

        BillingRepo.CreateComprehensiveBill(bill);

        // Notify Patient
        NotificationRepo.CreateNotification(new Notification
            {
                PatientId = Admission.PatientId,
                Title = "Bill Generated",
                Message = $"A new bill of {TotalAmount:C} has been generated for your recent stay. Please view details in 'My Bills'.",
                CreatedDate = DateTime.Now,
                IsRead = false
            });

        NotificationService.Notify(NotificationSeverity.Success, "Bill Generated", "Bill sent to Teller. Patient notified.");
        DialogService.Close(true);
    }
}

