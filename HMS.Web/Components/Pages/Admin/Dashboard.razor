@page "/admin/dashboard"
@layout HMS.Web.Components.Layout.AdminLayout
@rendermode InteractiveServer
@using Radzen.Blazor
@attribute [Authorize(Roles = "Admin")]
@inject NotificationService NotificationService
@inject FinanceRepository FinanceRepo

<PageTitle>Admin Dashboard | Hospital Control</PageTitle>

<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-primary">Admin Control Center</h2>
        <p class="text-muted">Overview of hospital operations, financials, and resources.</p>
    </div>
</div>

<div class="row">
    <!-- Financial Pulse -->
    <div class="col-md-3">
        <RadzenCard Class="rz-p-4 mb-4" Style="min-height: 140px; display: flex; align-items: center;">
            <div class="d-flex flex-row align-items-center w-100">
                <RadzenIcon Icon="payments" Class="rz-mr-2" Style="font-size: 3rem; color: #28a745;" />
                <div class="ms-3">
                    <h6 class="mb-0 text-muted">Today's Revenue</h6>
                    <h3 class="mb-0">@stats.TodayRevenue.ToString("C")</h3>
                </div>
            </div>
        </RadzenCard>
    </div>

    <!-- Occupancy -->
    <div class="col-md-3">
        <RadzenCard Class="rz-p-4 mb-4" Style="min-height: 140px; display: flex; align-items: center;">
            <div class="d-flex flex-row align-items-center w-100">
                <RadzenIcon Icon="bed" Class="rz-mr-2" Style="font-size: 3rem; color: #007bff;" />
                <div class="ms-3">
                    <h6 class="mb-0 text-muted">Bed Occupancy</h6>
                    <h3 class="mb-0">@stats.OccupiedBeds / @stats.TotalBeds</h3>
                </div>
            </div>
        </RadzenCard>
    </div>

    <!-- Staff Active -->
    <div class="col-md-3">
        <RadzenCard Class="rz-p-4 mb-4" Style="min-height: 140px; display: flex; align-items: center;">
            <div class="d-flex flex-row align-items-center w-100">
                <RadzenIcon Icon="people" Class="rz-mr-2" Style="font-size: 3rem; color: #dc3545;" />
                <div class="ms-3">
                    <h6 class="mb-0 text-muted">Staff On Shift</h6>
                    <h3 class="mb-0">@stats.StaffOnShift</h3>
                </div>
            </div>
        </RadzenCard>
    </div>

    <!-- Operations -->
    <div class="col-md-3">
        <RadzenCard Class="rz-p-4 mb-4" Style="min-height: 140px; display: flex; align-items: center;">
            <div class="d-flex flex-row align-items-center w-100">
                <RadzenIcon Icon="local_hospital" Class="rz-mr-2" Style="font-size: 3rem; color: #ffc107;" />
                <div class="ms-3">
                    <h6 class="mb-0 text-muted">Surgeries Today</h6>
                    <h3 class="mb-0">@stats.SurgeriesToday</h3>
                </div>
            </div>
        </RadzenCard>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-7">
        <RadzenCard Class="shadow-sm border-0 h-100">
            <h5 class="mb-3 text-primary"><i class="bi bi-broadcast me-2"></i>Live Surgical Control</h5>
            
            @if (!ReadyToStart.Any() && !InProgress.Any() && !ReadyForTransfer.Any())
            {
                <div class="alert alert-light border text-center py-4">
                    <i class="bi bi-check2-circle fs-3 text-muted"></i>
                    <p class="mb-0 mt-2">All theaters are currently quiet.</p>
                </div>
            }

            @foreach (var op in InProgress)
            {
                <div class="card mb-3 border-warning border-start-5">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1 fw-bold">@op.PatientName - <span class="text-danger">IN SURGERY</span></h6>
                                <div class="small text-muted">Theater: @op.TheaterName | Surgeon: @op.DoctorName</div>
                            </div>
                            <div class="text-end">
                                <div class="badge bg-warning text-dark fs-6">
                                    <i class="bi bi-stopwatch me-1"></i>
                                    @GetRemainingTime(op)
                                </div>
                                <div class="small mt-1 text-muted">Est. Done: @op.EndDate.ToString("hh:mm tt")</div>
                            </div>
                        </div>
                        @if (IsOverdue(op))
                        {
                            <div class="alert alert-danger py-1 px-2 mt-2 mb-0 small animate__animated animate__pulse animate__infinite">
                                <i class="bi bi-exclamation-triangle-fill"></i> OPERATION OVERDUE - Please check status with OT Staff.
                            </div>
                        }
                    </div>
                </div>
            }

            @foreach (var op in ReadyForTransfer)
            {
                <div class="alert alert-success d-flex justify-content-between align-items-center py-3 mb-3">
                    <span>
                        <i class="bi bi-truck me-2"></i>
                        <strong>@op.PatientName</strong> finished surgery! Needs a bed.
                    </span>
                    <RadzenButton Text="Assign Bed" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Success" 
                                  Click="@(() => OpenTransferDialog(op))" />
                </div>
            }

            @foreach (var op in ReadyToStart)
            {
                <div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-2">
                    <span>
                        <i class="bi bi-clock-fill me-2"></i>
                        <strong>@op.PatientName</strong> paid deposit. Waiting to start.
                    </span>
                    <RadzenButton Text="Details" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Info" 
                                  Click="@(() => Navigation.NavigateTo("admin/ot-schedule"))" />
                </div>
            }
        </RadzenCard>
    </div>

    <div class="col-md-5">
        <RadzenCard Class="shadow-sm border-0 mb-4 h-100">
            <h5 class="mb-3 text-secondary"><i class="bi bi-door-closed me-2"></i>Theater Occupancy</h5>
            <div class="row row-cols-2 g-3">
                @foreach (var ot in Theaters)
                {
                    var active = InProgress.FirstOrDefault(o => o.TheaterId == ot.TheaterId);
                    <div class="col">
                        <div class="p-3 border rounded text-center @(active != null ? "bg-danger-subtle border-danger" : "bg-success-subtle border-success")">
                            <div class="fw-bold">@ot.TheaterName</div>
                            <div class="small">@(active != null ? "RUNNING" : "AVAILABLE")</div>
                            @if (active != null)
                            {
                                <div class="mt-2 fw-bold text-danger">@GetRemainingTime(active)</div>
                            }
                        </div>
                    </div>
                }
            </div>
            
            <div class="mt-4 pt-3 border-top">
                <h6 class="mb-3">Quick Actions</h6>
                <div class="d-grid gap-2">
                    <RadzenButton Text="View Full OT Schedule" Icon="calendar_month" ButtonStyle="ButtonStyle.Primary"
                        Click="@(() => Navigation.NavigateTo("admin/ot-schedule"))" />
                    <RadzenButton Text="Post-Op Handover" Icon="transfer_within_a_station" ButtonStyle="ButtonStyle.Success"
                        Click="@(() => Navigation.NavigateTo("admin/pending-transfers"))" />
                    <RadzenButton Text="Register New Staff" Icon="person_add" ButtonStyle="ButtonStyle.Light"
                        Click="@(() => Navigation.NavigateTo("admin/staff"))" />
                </div>
            </div>
        </RadzenCard>
    </div>
</div>

@inject OperationRepository OperationRepo
@inject NavigationManager Navigation
@inject DialogService DialogService

@inject FacilityRepository FacilityRepo
@implements IDisposable

@code {
    DashboardStats stats = new();
    List<PatientOperation> ReadyToStart = new();
    List<PatientOperation> InProgress = new();
    List<PatientOperation> ReadyForTransfer = new();
    List<OperationTheater> Theaters = new();
    System.Threading.Timer? dataRefreshTimer;
    System.Threading.Timer? uiTickTimer;

    protected override void OnInitialized()
    {
        LoadDashboardData();
        
        // Refresh DATA every 15 seconds (expensive)
        dataRefreshTimer = new System.Threading.Timer(_ => InvokeAsync(async () => { 
            LoadDashboardData(); 
            await InvokeAsync(StateHasChanged); 
        }), null, 15000, 15000);

        // Tick UI every 1 second (cheap - just for countdowns)
        uiTickTimer = new System.Threading.Timer(_ => InvokeAsync(async () => { 
            await InvokeAsync(StateHasChanged); 
        }), null, 1000, 1000);
    }

    void LoadDashboardData()
    {
        stats = FinanceRepo.GetDashboardStats();
        ReadyToStart = OperationRepo.GetOperationsByStatus("Scheduled");
        InProgress = OperationRepo.GetOperationsByStatus("Running");
        ReadyForTransfer = OperationRepo.GetOperationsReadyForTransfer();
        Theaters = FacilityRepo.GetTheaters();
    }

    string GetRemainingTime(PatientOperation op)
    {
        var remaining = op.EndDate - DateTime.Now;
        if (remaining.TotalSeconds <= 0) return "00:00:00";
        return $"{(int)remaining.TotalHours:D2}:{remaining.Minutes:D2}:{remaining.Seconds:D2}";
    }

    bool IsOverdue(PatientOperation op) => DateTime.Now > op.EndDate;

    async Task OpenTransferDialog(PatientOperation op)
    {
        var result = await DialogService.OpenAsync<AdmissionDialog>($"Post-Op Transfer: {op.PatientName}",
        new Dictionary<string, object> { 
            { "PatientId", op.PatientId },
            { "OperationId", op.OperationId }
        },
        new DialogOptions { Width = "600px" });

        if (result == true)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Transferred", "Patient admitted for recovery.");
            LoadDashboardData();
        }
    }

    public void Dispose() 
    {
        dataRefreshTimer?.Dispose();
        uiTickTimer?.Dispose();
    }
}
