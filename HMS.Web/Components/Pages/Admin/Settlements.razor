@page "/admin/settlements"
@layout HMS.Web.Components.Layout.AdminLayout
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject DoctorRepository DoctorRepo
@inject FinanceRepository FinanceRepo
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Doctor Settlements | Admin</PageTitle>

<RadzenStack Class="rz-p-4" Gap="2rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
        JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0">
            <RadzenText Text="Physician Compensation & Settlements" TextStyle="TextStyle.H4"
                Class="rz-m-0 rz-color-primary" />
            <RadzenText Text="Manage doctor payouts, commission rates, and financial history."
                TextStyle="TextStyle.Body2" Class="rz-m-0 rz-color-text-secondary" />
        </RadzenStack>
        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center"
            Class="rz-p-4 rz-background-color-info-lighter rz-border-radius-2">
            <RadzenStack Gap="0">
                <RadzenText Text="Active Period" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                <RadzenText Text="@($"{periodStart:MMM dd} - {periodEnd:MMM dd, yyyy}")" TextStyle="TextStyle.Subtitle2"
                    Class="rz-m-0" />
            </RadzenStack>
            <RadzenButton Icon="date_range" ButtonStyle="ButtonStyle.Info" Variant="Variant.Flat"
                Click="@ShowSettlementDialog" />
        </RadzenStack>
    </RadzenStack>

    <RadzenTabs RenderMode="TabRenderMode.Client">
        <Tabs>
            <RadzenTabsItem Text="Pending Payouts" Icon="account_balance_wallet">
                <RadzenCard Class="rz-p-0 rz-shadow-2" Style="overflow: hidden; border-radius: 12px; margin-top: 1rem;">
                    <RadzenDataGrid Data="@doctors" TItem="Doctor" AllowFiltering="true" AllowPaging="true"
                        PageSize="10" Class="rz-border-none">
                        <Columns>
                            <RadzenDataGridColumn TItem="Doctor" Property="DoctorId" Title="ID" Width="80px" />
                            <RadzenDataGridColumn TItem="Doctor" Property="FullName" Title="Doctor Name">
                                <Template Context="doctor">
                                    <RadzenText Text="@doctor.FullName" TextStyle="TextStyle.Subtitle2"
                                        Class="rz-m-0 rz-color-primary" />
                                    <RadzenText Text="@doctor.Specialization" TextStyle="TextStyle.Caption" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Doctor" Property="DepartmentName" Title="Department" />
                            <RadzenDataGridColumn TItem="Doctor" Property="CommissionRate" Title="Commission Rate"
                                Width="150px">
                                <Template Context="data">
                                    <RadzenBadge Text="@($"{data.CommissionRate:0.0}%")" BadgeStyle="BadgeStyle.Info"
                                        Shade="Shade.Lighter" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Doctor" Title="Action" Sortable="false" Filterable="false"
                                Width="150px" TextAlign="TextAlign.Right">
                                <Template Context="data">
                                    <RadzenButton Text="Execute" Icon="payments" ButtonStyle="ButtonStyle.Success"
                                        Size="ButtonSize.Small" Click="@(() => ProcessSettlement(data))" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenCard>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Settlement History" Icon="history">
                <RadzenStack Gap="1.5rem" Class="rz-pt-4">
                    <RadzenCard Class="rz-p-4 rz-background-color-base-100">
                        <RadzenText Text="Select Practitioner" TextStyle="TextStyle.Subtitle2" Class="rz-mb-2" />
                        <RadzenDropDown @bind-Value="selectedDoctorId" Data="@doctors" TextProperty="FullName"
                            ValueProperty="DoctorId" Placeholder="Choose a doctor to view archive..."
                            Change="@LoadPaymentHistory" Style="width: 100%; max-width: 400px;" />
                    </RadzenCard>

                    @if (paymentHistory.Any())
                    {
                        <RadzenCard Class="rz-p-0 rz-shadow-2" Style="overflow: hidden; border-radius: 12px;">
                            <RadzenDataGrid Data="@paymentHistory" TItem="DoctorPayment" AllowPaging="true" PageSize="10"
                                Class="rz-border-none">
                                <Columns>
                                    <RadzenDataGridColumn TItem="DoctorPayment" Property="PaymentDate" Title="Date"
                                        FormatString="{0:d}" Width="120px" />
                                    <RadzenDataGridColumn TItem="DoctorPayment" Title="Range" Width="200px">
                                        <Template Context="data">
                                            <RadzenText Text="@($"{data.PeriodStart:MMM dd} - {data.PeriodEnd:MMM dd}")"
                                                TextStyle="TextStyle.Body2" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="DoctorPayment" Property="Amount" Title="Payout Amount">
                                        <Template Context="data">
                                            <RadzenText Text="@data.Amount.ToString("C")" TextStyle="TextStyle.Subtitle1"
                                                Class="rz-color-success rz-font-weight-bold" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="DoctorPayment" Property="Status" Title="Status"
                                        Width="120px">
                                        <Template Context="data">
                                            <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@data.Status"
                                                Shade="Shade.Lighter" IsPill="true" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        </RadzenCard>
                    }
                    else if (selectedDoctorId.HasValue)
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter"
                            Title="No Archive Found">
                            This practitioner has no recorded settlement history.
                        </RadzenAlert>
                    }
                </RadzenStack>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
</RadzenStack>

@code {
    List<Doctor> doctors = new();
    List<DoctorPayment> paymentHistory = new();
    int? selectedDoctorId;

    protected override void OnInitialized()
    {
        LoadDoctors();
    }

    void LoadDoctors()
    {
        doctors = DoctorRepo.GetDoctors();
    }

    void LoadPaymentHistory()
    {
        if (selectedDoctorId.HasValue)
        {
            paymentHistory = FinanceRepo.GetDoctorPayments(selectedDoctorId.Value);
        }
    }

    async Task ShowSettlementDialog()
    {
        await DialogService.OpenAsync("Settlement Period", ds =>
    @<RadzenStack Gap="1.5rem" Class="rz-p-4">
        <RadzenStack Gap="1rem">
            <RadzenStack Gap="0.5rem">
                <RadzenLabel Text="Period Start" />
                <RadzenDatePicker @bind-Value="periodStart" Class="rz-w-100" />
            </RadzenStack>
            <RadzenStack Gap="0.5rem">
                <RadzenLabel Text="Period End" />
                <RadzenDatePicker @bind-Value="periodEnd" Class="rz-w-100" />
            </RadzenStack>
        </RadzenStack>
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
            <RadzenButton Text="Close" ButtonStyle="ButtonStyle.Light" Click="() => ds.Close()" />
        </RadzenStack>
    </RadzenStack>
            , new DialogOptions { Width = "400px" });
    }

    DateTime periodStart = DateTime.Now.AddMonths(-1);
    DateTime periodEnd = DateTime.Now;

    async Task ProcessSettlement(Doctor doctor)
    {
        var amount = FinanceRepo.CalculateDoctorSettlement(doctor.DoctorId, periodStart, periodEnd);

        if (amount == 0)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "No Earnings",
                $"Dr. {doctor.FullName} has no completed appointments in this period.");
            return;
        }

        var result = await DialogService.OpenAsync($"Settle Payment for Dr. {doctor.FullName}", ds =>
    @<RadzenStack Gap="1.5rem" Class="rz-p-4">
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.Caption" Class="rz-m-0">
                    <strong>Period:</strong> @periodStart.ToShortDateString() to @periodEnd.ToShortDateString()
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" Class="rz-m-0">
                    <strong>Commission Rate:</strong> @doctor.CommissionRate%
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Subtitle1" Class="rz-m-0">
                    <strong>Calculated Amount:</strong> <span
                        style="color: var(--rz-success); font-weight: bold;">@amount.ToString("C")</span>
                </RadzenText>
            </RadzenStack>
        </RadzenAlert>
        <RadzenStack Gap="0.5rem">
            <RadzenLabel Text="Payment Notes" />
            <RadzenTextArea @bind-Value="paymentNotes" Class="rz-w-100" Rows="3" Placeholder="Optional notes..." />
        </RadzenStack>
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem">
            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="() => ds.Close(false)" />
            <RadzenButton Text="Process Payment" ButtonStyle="ButtonStyle.Success" Click="() => ds.Close(true)" />
        </RadzenStack>
    </RadzenStack>
, new DialogOptions { Width = "500px" });

        if (result == true)
        {
            var payment = new DoctorPayment
                {
                    DoctorId = doctor.DoctorId,
                    Amount = amount,
                    PeriodStart = periodStart,
                    PeriodEnd = periodEnd,
                    Notes = paymentNotes
                };

            FinanceRepo.ProcessDoctorPayment(payment);
            NotificationService.Notify(NotificationSeverity.Success, "Payment Processed",
            $"Settlement of {amount:C} processed for Dr. {doctor.FullName}");
        }
    }

    string paymentNotes = "";
}
