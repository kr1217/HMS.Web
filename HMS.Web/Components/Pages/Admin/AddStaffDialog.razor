@using HMS.Web.Models
@using HMS.Web.DAL
@using Microsoft.AspNetCore.Identity
@using HMS.Web.Data
@using Radzen.Blazor
@inject StaffRepository StaffRepo
@inject UserManager<ApplicationUser> UserManager
@inject DialogService DialogService
@inject NotificationService NotificationService

<RadzenTemplateForm TItem="Staff" Data="@model" Submit="@HandleValidSubmit">
    <RadzenStack Gap="1.5rem" Class="rz-p-2">
        <RadzenCard Class="rz-shadow-2">
            <RadzenStack Gap="1.5rem">
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Personnel Full Name" Component="FullName" TextStyle="TextStyle.Subtitle2" />
                            <RadzenTextBox @bind-Value="model.FullName" Name="FullName" Class="rz-w-100" Placeholder="Enter legal name..." />
                            <RadzenRequiredValidator Component="FullName" Text="Full name is mandatory" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Institutional Email (Login ID)" Component="Email" TextStyle="TextStyle.Subtitle2" />
                            <RadzenTextBox @bind-Value="model.Email" Name="Email" Class="rz-w-100" Disabled="@IsEdit" Placeholder="institutional@hms.com" />
                            <RadzenRequiredValidator Component="Email" Text="Email identifier is required" />
                            <RadzenEmailValidator Component="Email" Text="Invalid clinical email format" />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Institutional Role" Component="Role" TextStyle="TextStyle.Subtitle2" />
                            <RadzenDropDown @bind-Value="model.Role" Data="@roles" Class="rz-w-100" Name="Role" Placeholder="Select registry role..." />
                            <RadzenRequiredValidator Component="Role" Text="Role assignment is mandatory" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Clinical Department" Component="Dept" TextStyle="TextStyle.Subtitle2" />
                            <RadzenDropDown @bind-Value="model.Department" Data="@departments" Class="rz-w-100" Name="Dept" Placeholder="Assigned department..." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Remuneration (Salary)" Component="Salary" TextStyle="TextStyle.Subtitle2" />
                            <RadzenNumeric @bind-Value="model.Salary" Name="Salary" Class="rz-w-100" Format="C" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Shift Orbit" TextStyle="TextStyle.Subtitle2" />
                            <RadzenDropDown @bind-Value="model.Shift" Data="@shifts" Class="rz-w-100" Placeholder="Standard shift..." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Contact Number" TextStyle="TextStyle.Subtitle2" />
                            <RadzenTextBox @bind-Value="model.PhoneNumber" Class="rz-w-100" Placeholder="+1 (555) 000-0000" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-pt-md-8">
                            <RadzenCheckBox @bind-Value="model.IsActive" Name="Active" />
                            <RadzenLabel Text="Authorize Account Access" Component="Active" TextStyle="TextStyle.Body2" />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>
        </RadzenCard>

        @if (!IsEdit)
        {
            <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="security">
                The institutional credentials will be initialized with the default security key: <strong>Hospital@@123</strong>
            </RadzenAlert>
        }

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-4">
            <RadzenButton ButtonType="ButtonType.Submit" Text="Synchronize Registry" ButtonStyle="ButtonStyle.Primary" Icon="save" />
            <RadzenButton Text="Discard" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public Staff StaffModel { get; set; }
    [Parameter] public bool IsEdit { get; set; } = false;

    private Staff model = new();
    private List<string> roles = new() { "Admin", "Nurse", "Receptionist", "Pharmacist", "Doctor", "Teller" };
    private List<string> departments = new() { "Cardiology", "Neurology", "General", "Orthopedics", "Administration",
"Pharmacy", "Finance" };
    private List<string> shifts = new() { "Morning", "Evening", "Night" };

    protected override void OnInitialized()
    {
        if (IsEdit && StaffModel != null)
        {
            model = new Staff
                {
                    StaffId = StaffModel.StaffId,
                    UserId = StaffModel.UserId,
                    FullName = StaffModel.FullName,
                    Email = StaffModel.Email,
                    Role = StaffModel.Role,
                    Department = StaffModel.Department,
                    Shift = StaffModel.Shift,
                    Salary = StaffModel.Salary,
                    IsActive = StaffModel.IsActive,
                    PhoneNumber = StaffModel.PhoneNumber
                };
        }
        else
        {
            model.IsActive = true;
            model.Role = "Nurse";
            model.Department = "General";
            model.Shift = "Morning";
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            if (IsEdit)
            {
                StaffRepo.UpdateStaff(model);
                NotificationService.Notify(NotificationSeverity.Success, "Registry Updated", "Staff record synchronized successfully.");
                DialogService.Close(true);
            }
            else
            {
                // 1. Create Identity User
                var user = new ApplicationUser { UserName = model.Email, Email = model.Email, EmailConfirmed = true };
                var result = await UserManager.CreateAsync(user, "Hospital@123");

                if (result.Succeeded)
                {
                    // 2. Assign Role
                    await UserManager.AddToRoleAsync(user, model.Role);

                    // 3. Create Staff
                    model.UserId = user.Id;
                    StaffRepo.CreateStaff(model);
                    NotificationService.Notify(NotificationSeverity.Success, "Personnel Enrolled", "New staff account provisioned and enrolled.");
                    DialogService.Close(true);
                }
                else
                {
                    foreach (var error in result.Errors)
                    {
                        NotificationService.Notify(NotificationSeverity.Error, "Credential Error", error.Description);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "System Error", ex.Message);
        }
    }
}
