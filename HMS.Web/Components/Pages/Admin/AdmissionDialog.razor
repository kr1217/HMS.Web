@using HMS.Web.Models
@using HMS.Web.DAL
@using Radzen
@using Radzen.Blazor
@inject FacilityRepository FacilityRepo
@inject PatientRepository PatientRepo
@inject OperationRepository OperationRepo
@inject DoctorRepository DoctorRepo
@inject DialogService DialogService
@inject NotificationService NotificationService

<RadzenTemplateForm TItem="Admission" Data="@model" Submit="@OnSubmit">
    <RadzenStack Gap="1.5rem" Class="rz-p-2">
        @if (!string.IsNullOrEmpty(RecommendedWardName))
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false"
                Icon="medical_information">
                <RadzenStack Gap="0.25rem">
                    <RadzenText Text="Post-Procedural Recovery Protocol" TextStyle="TextStyle.Subtitle2"
                        Class="rz-font-weight-bold" />
                    <RadzenText
                        Text="@($"Patient has been transferred from surgical orchestrations. Recommended ward: {RecommendedWardName}")"
                        TextStyle="TextStyle.Caption" />
                </RadzenStack>
            </RadzenAlert>
        }

        <RadzenCard Class="rz-shadow-2">
            <RadzenStack Gap="1.5rem">
                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Text="Subject Admission" Component="PatientId" TextStyle="TextStyle.Subtitle2" />
                    <RadzenDropDown Name="PatientId" Data="@patients" TextProperty="FullName" ValueProperty="PatientId"
                        @bind-Value="model.PatientId" Style="width: 100%;" AllowFiltering="true"
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        Placeholder="Search patient identity..." />
                    <RadzenRequiredValidator Component="PatientId" Text="Clinical subject is mandatory" />
                </RadzenStack>

                <RadzenRow Gap="1.5rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Clinical Ward" Component="WardId" TextStyle="TextStyle.Subtitle2" />
                            <RadzenDropDown Name="WardId" Data="@wards" TextProperty="WardName" ValueProperty="WardId"
                                @bind-Value="selectedWardId" Style="width: 100%;" Change="@(args => OnWardChange())"
                                Placeholder="Select clinical area...">
                                <Template Context="ward">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                                        JustifyContent="JustifyContent.SpaceBetween">
                                        <RadzenText Text="@ward.WardName" TextStyle="TextStyle.Body2" Class="rz-m-0" />
                                        @if (!string.IsNullOrEmpty(SpecialtyKeyword) &&
                                        ward.WardName.Contains(SpecialtyKeyword, StringComparison.OrdinalIgnoreCase))
                                        {
                                            <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Specialty Opt" IsPill="true"
                                                Shade="Shade.Lighter" />
                                        }
                                    </RadzenStack>
                                </Template>
                            </RadzenDropDown>
                        </RadzenStack>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Facility Room" Component="RoomId" TextStyle="TextStyle.Subtitle2" />
                            <RadzenDropDown Name="RoomId" Data="@filteredRooms" TextProperty="RoomNumber"
                                ValueProperty="RoomId" @bind-Value="selectedRoomId" Style="width: 100%;"
                                Change="@(args => OnRoomChange())" Disabled="@(selectedWardId == 0)"
                                Placeholder="Select room..." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Text="Inventory Bed Assignment" Component="BedId" TextStyle="TextStyle.Subtitle2" />
                    <RadzenDropDown Name="BedId" Data="@filteredBeds" ValueProperty="BedId" @bind-Value="model.BedId"
                        Style="width: 100%;" Disabled="@(selectedRoomId == 0)" Placeholder="Assign serial bed...">
                        <Template Context="bed">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem"
                                AlignItems="AlignItems.Center">
                                <RadzenIcon Icon="bed" Size="16px" />
                                <RadzenText Text="@($"{bed.BedNumber} ({bed.Status})")" TextStyle="TextStyle.Body2"
                                    Class="rz-m-0" />
                            </RadzenStack>
                        </Template>
                    </RadzenDropDown>
                    <RadzenRequiredValidator Component="BedId" Text="Bed assignment is mandatory for inventory audit"
                        DefaultValue="0" />
                </RadzenStack>

                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Text="Clinical Admission Observations" TextStyle="TextStyle.Subtitle2" />
                    <RadzenTextArea @bind-Value="model.Notes" Rows="3" Class="rz-w-100"
                        Placeholder="Document preliminary clinical observations or ward prerequisites..." />
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem"
            Class="rz-mt-4">
            <RadzenButton ButtonType="ButtonType.Submit" Text="Authorize Admission" ButtonStyle="ButtonStyle.Success"
                Icon="check_circle" />
            <RadzenButton Text="Discard" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public Admission? AdmissionModel { get; set; }
    [Parameter] public int? PatientId { get; set; }
    [Parameter] public int? OperationId { get; set; }

    Admission model = new Admission();
    List<Patient> patients = new();
    List<Ward> wards = new();
    List<Room> filteredRooms = new();
    List<Bed> filteredBeds = new();

    int selectedWardId = 0;
    int selectedRoomId = 0;
    string? SpecialtyKeyword;
    string? RecommendedWardName;

    protected override void OnInitialized()
    {
        // OPTIMIZATION: Only load what we need
        if (PatientId.HasValue)
        {
            var patient = PatientRepo.GetPatientById(PatientId.Value);
            if (patient != null)
            {
                patients = new List<Patient> { patient };
                model.PatientId = PatientId.Value;
            }
        }
        else
        {
            // Only load patients if drop-down is needed
            // To prevent lag, we only load the top 100 or something if it's too much.
            // But since this is a search dropdown, Radzen already handles filtering if configured.
            patients = PatientRepo.GetAllPatients();
        }

        // Only load available wards (usually a small list)
        wards = FacilityRepo.GetWards();

        if (PatientId.HasValue)
        {
            DetectSpecialtyNeeds();
        }
    }

    void DetectSpecialtyNeeds()
    {
        // Find latest completed operation for this patient to suggest correct ward
        var latestOp = OperationRepo.GetOperationsByStatus("Completed")
        .Where(o => o.PatientId == model.PatientId)
        .OrderByDescending(o => o.OperationId)
        .FirstOrDefault();

        if (latestOp != null)
        {
            var doctor = DoctorRepo.GetDoctorById(latestOp.DoctorId);
            SpecialtyKeyword = doctor?.DepartmentName;

            if (string.IsNullOrEmpty(SpecialtyKeyword))
            {
                SpecialtyKeyword = doctor?.Specialization?.Split(' ')[0];
            }

            if (!string.IsNullOrEmpty(SpecialtyKeyword))
            {
                var bestWard = wards.FirstOrDefault(w => w.WardName.Contains(SpecialtyKeyword, StringComparison.OrdinalIgnoreCase));

                if (bestWard != null)
                {
                    // Check if ward has available beds (optimized query)
                    var wardRooms = FacilityRepo.GetRoomsByWard(bestWard.WardId);
                    bool hasBeds = false;

                    foreach (var room in wardRooms)
                    {
                        if (FacilityRepo.GetAvailableBedsByRoom(room.RoomId).Any())
                        {
                            hasBeds = true;
                            break;
                        }
                    }

                    if (hasBeds)
                    {
                        RecommendedWardName = bestWard.WardName;
                        // STRICT ENFORCEMENT: Lock to this ward if beds are available
                        wards = new List<Ward> { bestWard };
                        selectedWardId = bestWard.WardId;
                        OnWardChange();
                    }
                    else
                    {
                        RecommendedWardName = $"{bestWard.WardName} (FULL) - Using General Fallback";

                        wards = wards.OrderByDescending(w => w.WardName.Contains(SpecialtyKeyword, StringComparison.OrdinalIgnoreCase))
                        .ThenByDescending(w => w.WardName.Contains("General", StringComparison.OrdinalIgnoreCase))
                        .ToList();

                        var generalWard = wards.FirstOrDefault(w => w.WardName.Contains("General", StringComparison.OrdinalIgnoreCase));
                        if (generalWard != null)
                        {
                            selectedWardId = generalWard.WardId;
                            OnWardChange();
                        }
                    }
                }
            }
        }
    }

    void OnWardChange()
    {
        // PERFORMANCE OPTIMIZATION: Load rooms only for selected ward
        filteredRooms = FacilityRepo.GetRoomsByWard(selectedWardId);
        selectedRoomId = 0;
        filteredBeds.Clear();
        model.BedId = 0;
    }

    void OnRoomChange()
    {
        // PERFORMANCE OPTIMIZATION: Load beds only for selected room
        filteredBeds = FacilityRepo.GetAvailableBedsByRoom(selectedRoomId);
        model.BedId = 0;
    }

    async Task OnSubmit(Admission args)
    {
        try
        {
            if (args.PatientId == 0 || args.BedId == 0)
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Validation Error", "Please select both patient and bed.");
                return;
            }

            FacilityRepo.AdmitPatient(args);

            if (OperationId.HasValue)
            {
                OperationRepo.MarkOperationAsTransferred(OperationId.Value);
            }
            else
            {
                var latestOp = OperationRepo.GetOperationsReadyForTransfer()
                .OrderByDescending(o => o.OperationId)
                .FirstOrDefault(o => o.PatientId == args.PatientId);

                if (latestOp != null)
                {
                    OperationRepo.MarkOperationAsTransferred(latestOp.OperationId);
                }
            }

            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Admission Error", ex.Message);
        }
    }
}