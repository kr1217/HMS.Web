@*
 * FILE: OTSchedule.razor
 * PURPOSE: Administrative interface for hospital operations.
 * COMMUNICATES WITH: OperationRepository, FacilityRepository
*@
@page "/admin/ot-schedule"
@using HMS.Web.Models
@using HMS.Web.DAL
@inject OperationRepository OperationRepo
@inject FacilityRepository FacilityRepo
@inject DialogService DialogService
@inject NotificationService NotificationService
@layout HMS.Web.Components.Layout.AdminLayout

<RadzenStack Class="rz-p-4 rz-p-md-6" Gap="2rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
        JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0.5rem">
            <RadzenText Text="Operation Theater Scheduling" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
            <RadzenText Text="Coordinate surgical suites and monitor procedure timelines in real-time."
                TextStyle="TextStyle.Body2" Class="rz-color-text-secondary" />
        </RadzenStack>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
            <RadzenDatePicker @bind-Value="CurrentDate" DateFormat="MMMM dd, yyyy" Change="@OnDateChange" />
            <RadzenButton Icon="refresh" ButtonStyle="ButtonStyle.Light" Click="@LoadData" IsPill="true" />
        </RadzenStack>
    </RadzenStack>

    @if (Theaters == null)
    {
        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
            <RadzenText Text="Synchronizing theater status..." TextStyle="TextStyle.Caption" />
        </RadzenStack>
    }
    else
    {
        <RadzenCard Class="rz-p-0 rz-shadow-4" Style="overflow: hidden; border-radius: 12px;">
            <RadzenScheduler @ref="scheduler" SlotRender="@OnSlotRender" AppointmentRender="@OnAppointmentRender"
                AppointmentSelect="@OnAppointmentSelect" Style="height: 700px;" TItem="PatientOperation" Data="@Operations"
                StartProperty="ScheduledDate" EndProperty="EndDate" TextProperty="PatientName" SelectedIndex="2">
                <RadzenDayView />
                <RadzenWeekView />
                <RadzenMonthView />
            </RadzenScheduler>
        </RadzenCard>
    }
</RadzenStack>

@code {
    RadzenScheduler<PatientOperation> scheduler;
    DateTime CurrentDate = DateTime.Now;
    List<OperationTheater> Theaters;
    List<PatientOperation> Operations;

    protected override void OnInitialized()
    {
        Theaters = FacilityRepo.GetTheaters();
        LoadData();
    }

    void OnDateChange(DateTime? value)
    {
        if (value.HasValue)
        {
            CurrentDate = value.Value;
            LoadData();
        }
    }

    void LoadData()
    {
        Operations = OperationRepo.GetAllScheduledOperations();
    }

    async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<PatientOperation> args)
    {
        var result = await DialogService.OpenAsync<ManageOperationDialog>("Manage Operation",
        new Dictionary<string, object> { { "Operation", args.Data } },
        new DialogOptions() { Width = "600px", Height = "500px" });

        if (result == true)
        {
            LoadData();
            await scheduler.Reload();
        }
    }

    void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        if (args.View.Text == "Month" && args.Start.Date == DateTime.Today)
        {
            args.Attributes["style"] = "background: rgba(255,220,40,.2);";
        }
    }

    void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<PatientOperation> args)
    {
        // Custom Styling based on Status / Delay

        if (args.Data.Status == "Running")
        {
            if (DateTime.Now > args.Data.EndDate)
            {
                args.Attributes["style"] = "background: var(--rz-danger); color: white;"; // Red for Overdue
            }
            else
            {
                args.Attributes["style"] = "background: var(--rz-warning); color: black;"; // Yellow for Running
            }
        }
        else if (args.Data.Status == "Completed")
        {
            args.Attributes["style"] = "background: var(--rz-success); color: white;"; // Green
        }
    }
}

