@page "/Admin/OperationRequests"
@using HMS.Web.Models
@using HMS.Web.DAL
@using Microsoft.AspNetCore.Authorization
@layout HMS.Web.Components.Layout.AdminLayout
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject OperationRepository OperationRepo
@inject FacilityRepository FacilityRepo
@inject DialogService DialogService
@inject NotificationService NotificationService

<RadzenStack Class="rz-p-4" Gap="2rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
        JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0">
            <RadzenText Text="Surgical Candidate Review" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
            <RadzenText Text="Process surgical admissions and validate deposit status." TextStyle="TextStyle.Body2"
                Class="rz-m-0 rz-color-text-secondary" />
        </RadzenStack>
        <RadzenIcon Icon="assignment_ind" Style="font-size: 3rem; color: var(--rz-primary-light);" />
    </RadzenStack>

    <RadzenCard Class="rz-p-0 rz-shadow-2" Style="overflow: hidden; border-radius: 12px;">
        <RadzenDataGrid @ref="grid" TItem="PatientOperation" Count="@count" Data="@Requests" LoadData="@LoadData"
            IsLoading="@isLoading" AllowPaging="true" PageSize="10" AllowSorting="true" Class="rz-border-none"
            FilterMode="FilterMode.Simple" AllowFiltering="true">
            <EmptyTemplate>
                <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
                    <RadzenIcon Icon="medical_services"
                        Style="font-size: 5rem; color: var(--rz-text-disabled-color);" />
                    <RadzenText Text="No pending surgical candidates found." TextStyle="TextStyle.H6"
                        Class="rz-color-text-secondary rz-m-0" />
                    <RadzenText
                        Text="Once a doctor recommends surgery and payment is cleared, candidates will appear here."
                        TextStyle="TextStyle.Body2" Class="rz-color-text-secondary" />
                </RadzenStack>
            </EmptyTemplate>
            <Columns>
                <RadzenDataGridColumn TItem="PatientOperation" Property="ScheduledDate" Title="Date" Width="120px">
                    <Template Context="op">
                        <RadzenText Text="@op.ScheduledDate.ToString("MMM dd, yyyy")" TextStyle="TextStyle.Body2" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PatientOperation" Property="PatientName" Title="Patient">
                    <Template Context="op">
                        <RadzenStack Gap="0">
                            <RadzenText Text="@op.PatientName" TextStyle="TextStyle.Subtitle2"
                                Class="rz-m-0 rz-color-primary" />
                            <RadzenText Text="@($"ID: #PAT-{op.PatientId}")" TextStyle="TextStyle.Caption" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PatientOperation" Property="DoctorName" Title="Surgeon" />
                <RadzenDataGridColumn TItem="PatientOperation" Property="PackageName" Title="Operation" />
                <RadzenDataGridColumn TItem="PatientOperation" Property="Urgency" Title="Urgency" Width="100px">
                    <Template Context="op">
                        <RadzenBadge Text="@op.Urgency" BadgeStyle="@GetUrgencyBadgeStyle(op.Urgency)" IsPill="true" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PatientOperation" Property="Status" Title="Status" Width="150px">
                    <Template Context="op">
                        <RadzenBadge
                            Text="@(op.Status == "Pending Deposit" || op.Status == "Advance Payment Requested" ? "WAITING PAYMENT" : op.Status)"
                            BadgeStyle="@(op.Status == "Pending Deposit" || op.Status == "Advance Payment Requested" ? BadgeStyle.Warning : BadgeStyle.Info)"
                            Shade="Shade.Lighter" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PatientOperation" Title="Action" Width="180px" TextAlign="TextAlign.Right"
                    Sortable="false" Filterable="false">
                    <Template Context="op">
                        @if (op.Status == "Pending Deposit" || op.Status == "Advance Payment Requested")
                        {
                            <RadzenButton Text="Waiting Teller" Icon="hourglass_empty" ButtonStyle="ButtonStyle.Light"
                                Size="ButtonSize.Small" Disabled="true" />
                        }
                        else
                        {
                            <RadzenButton Text="Authorize" Icon="assignment_turned_in" ButtonStyle="ButtonStyle.Primary"
                                Size="ButtonSize.Small" Click="@(() => OpenAdmitDialog(op))" />
                        }
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </RadzenCard>
</RadzenStack>

@code {
    RadzenDataGrid<PatientOperation> grid = default!;
    IEnumerable<PatientOperation> Requests = new List<PatientOperation>();
    int count;
    bool isLoading = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && grid != null)
        {
            await grid.Reload();
            StateHasChanged();
        }
    }

    async Task LoadData(LoadDataArgs args)
    {
        isLoading = true;

        var skip = args.Skip ?? 0;
        var take = args.Top ?? 10;
        var orderBy = args.OrderBy;
        if (string.IsNullOrEmpty(orderBy)) orderBy = "ScheduledDate DESC";

        Requests = OperationRepo.GetPendingOperationsPaged(skip, take, orderBy);
        count = OperationRepo.GetPendingOperationsCount();

        isLoading = false;
        StateHasChanged();
    }

    BadgeStyle GetUrgencyBadgeStyle(string urgency)
    {
        return urgency switch
        {
            "Critical" => BadgeStyle.Danger,
            "High" => BadgeStyle.Warning,
            "Medium" => BadgeStyle.Info,
            _ => BadgeStyle.Secondary
        };
    }

    async Task OpenAdmitDialog(PatientOperation op)
    {
        var result = await DialogService.OpenAsync<AdmitForOperationDialog>($"Admit for Surgery - {op.PatientName}",
        new Dictionary<string, object> { { "Operation", op } },
        new DialogOptions { Width = "700px", Height = "600px" });

        if (result == true)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Patient admitted and operation approved.");
            await grid.Reload();
        }
    }
}
