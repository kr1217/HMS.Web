@*
 * FILE: Dashboard.razor
 * PURPOSE: Operational theater staff interface.
 * COMMUNICATES WITH: OperationRepository, FacilityRepository, NotificationRepository
*@
@page "/ot-staff/dashboard"
@using HMS.Web.Models
@using HMS.Web.DAL
@rendermode InteractiveServer
@attribute [Authorize(Roles = "OTStaff,Admin")]
@inject OperationRepository OperationRepo
@inject FacilityRepository FacilityRepo
@inject NotificationService NotificationService
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject NotificationRepository NotificationRepo
@implements IDisposable

<PageTitle>OT Staff Dashboard | Hospital Management</PageTitle>

<RadzenStack Class="rz-p-4 rz-p-md-6" Gap="2rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0.5rem">
            <RadzenText Text="Surgical Operations Command" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
            <RadzenText Text="Manage live surgeries, theater allocations, and clinical handovers." TextStyle="TextStyle.Body2" Class="rz-color-text-secondary" />
        </RadzenStack>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1.5rem">
            <HMS.Web.Components.Shared.NotificationBell TargetRole="OTStaff" />
            <RadzenStack Gap="0" AlignItems="AlignItems.End">
                <RadzenBadge Text="Role: OT Staff" BadgeStyle="BadgeStyle.Primary" IsPill="true" />
                <RadzenText Text="@DateTime.Now.ToString("dd MMM yyyy HH:mm")" TextStyle="TextStyle.Caption" />
            </RadzenStack>
        </RadzenStack>
    </RadzenStack>

    <RadzenRow Gap="2rem">
        <!-- Live Operations -->
        <RadzenColumn Size="12" SizeLG="8">
            <RadzenCard Class="rz-p-0 rz-shadow-4" Style="overflow: hidden; border-radius: 12px;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-p-4 rz-background-color-base-100">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="play_circle" Style="color: var(--rz-secondary);" />
                        <RadzenText Text="Surgical Registry" TextStyle="TextStyle.H6" Class="rz-m-0" />
                    </RadzenStack>
                    <RadzenButton Icon="refresh" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="LoadData" Variant="Variant.Flat" />
                </RadzenStack>

                <RadzenDataGrid @ref="grid" TItem="PatientOperation" Data="@Operations" AllowPaging="true" PageSize="10"
                    Class="rz-border-none">
                    <EmptyTemplate>
                        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
                            <RadzenIcon Icon="event_busy" Style="font-size: 5rem; color: var(--rz-text-disabled-color);" />
                            <RadzenText Text="Surgical Registry is currently clear." TextStyle="TextStyle.H6" Class="rz-color-text-secondary rz-m-0" />
                            <RadzenText Text="No active or scheduled operations are pending at this moment." TextStyle="TextStyle.Body2" Class="rz-color-text-secondary" />
                        </RadzenStack>
                    </EmptyTemplate>
                    <Columns>
                        <RadzenDataGridColumn TItem="PatientOperation" Property="PatientName" Title="Patient" Width="200px">
                           <Template Context="op">
                               <RadzenText Text="@op.PatientName" TextStyle="TextStyle.Subtitle2" Class="rz-m-0" />
                           </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="PatientOperation" Property="TheaterName" Title="Theater" Width="150px" />
                        <RadzenDataGridColumn TItem="PatientOperation" Title="Status" Width="130px">
                            <Template Context="op">
                                <RadzenBadge BadgeStyle="@GetStatusBadge(op.Status)" Text="@op.Status" IsPill="true" Shade="Shade.Lighter" />
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="PatientOperation" Title="Timing & Progress" Width="220px">
                            <Template Context="op">
                                @if (op.Status == "Running" && op.ActualStartTime.HasValue)
                                {
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenText Text="@($"Started: {op.ActualStartTime.Value:hh:mm tt}")" TextStyle="TextStyle.Caption" Class="rz-color-warning rz-font-weight-bold" />
                                        <RadzenText Text="@($"Sched. End: {op.EndDate:hh:mm tt}")" TextStyle="TextStyle.Overline" />
                                        <RadzenText Text="@($"{GetRemainingTime(op)} remaining")" TextStyle="TextStyle.Body2" 
                                                    Class="rz-color-danger rz-font-weight-bold" Style="animation: rz-pulse 1.5s infinite;" />
                                    </RadzenStack>
                                }
                                else
                                {
                                    <RadzenText Text="@($"Sched: {op.ScheduledDate:hh:mm tt}")" TextStyle="TextStyle.Body2" Class="rz-color-text-secondary" />
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="PatientOperation" Title="Clinical Actions" Width="180px">
                            <Template Context="op">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                    @if (op.Status == "Scheduled")
                                    {
                                        <RadzenButton Text="Start Surgery" Icon="play_arrow" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                                    Click="@(() => StartOperation(op))" Class="rz-w-100" />
                                    }
                                    else if (op.Status == "Running")
                                    {
                                        <RadzenButton Text="Complete Case" Icon="done_all" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" 
                                                    Click="@(() => CompleteOperation(op))" Class="rz-w-100" />
                                    }
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
        </RadzenColumn>

        <!-- Theater Status Sidebar -->
        <RadzenColumn Size="12" SizeLG="4">
            <RadzenStack Gap="1.5rem">
                <RadzenCard Class="rz-shadow-2 rz-background-color-base-100">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-mb-4">
                        <RadzenIcon Icon="suite" />
                        <RadzenText Text="Theater Availability" TextStyle="TextStyle.H6" Class="rz-m-0" />
                    </RadzenStack>
                    <RadzenStack Gap="1rem">
                        @foreach (var ot in Theaters)
                        {
                            var activeOp = Operations.FirstOrDefault(o => o.TheaterId == ot.TheaterId && o.Status == "Running");
                            <RadzenCard Class="rz-p-3" Style="border: 1px solid var(--rz-base-200);">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenStack Gap="0">
                                        <RadzenText Text="@ot.TheaterName" TextStyle="TextStyle.Subtitle1" Class="rz-m-0 rz-font-weight-bold" />
                                        <RadzenText Text="@(activeOp != null ? $"Occupied: {activeOp.PatientName}" : "Ready for use")" 
                                                    TextStyle="TextStyle.Caption" 
                                                    Class="@(activeOp != null ? "rz-color-danger" : "rz-color-success")" />
                                    </RadzenStack>
                                    <RadzenIcon Icon="circle" Style="@($"font-size: 12px; color: {(activeOp != null ? "var(--rz-danger)" : "var(--rz-success)")};")" />
                                </RadzenStack>
                            </RadzenCard>
                        }
                    </RadzenStack>
                </RadzenCard>

                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false">
                    <RadzenStack Gap="0.5rem">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="info" />
                            <RadzenText Text="Clinical Guidelines" TextStyle="TextStyle.Subtitle2" Class="rz-m-0" />
                        </RadzenStack>
                        <RadzenText TextStyle="TextStyle.Caption">
                            <ul style="margin: 0; padding-left: 1.25rem;">
                                <li>Mark surgery as started when patient enters.</li>
                                <li>Verify completion triggers post-op handover.</li>
                                <li>Statuses sync with Admin Dashboard live.</li>
                            </ul>
                        </RadzenText>
                    </RadzenStack>
                </RadzenAlert>
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

<RadzenComponents />

<style>
    .rz-background-color-info-lighter { background-color: #e3f2fd; }
    .shadow-xs { box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); }
    @@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .rz-spin { animation: spin 2s linear infinite; }
</style>

@code {
    RadzenDataGrid<PatientOperation> grid = default!;
    List<PatientOperation> Operations = new();
    List<OperationTheater> Theaters = new();
    System.Threading.Timer? dataRefreshTimer;
    System.Threading.Timer? uiTickTimer;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && grid != null)
        {
            await grid.Reload();
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        LoadData();
        
        // Refresh DATA every 30 seconds (expensive)
        dataRefreshTimer = new System.Threading.Timer(_ => InvokeAsync(async () => { 
            LoadData(); 
            await InvokeAsync(StateHasChanged); 
        }), null, 30000, 30000);

        // Tick UI every 1 second (cheap - for countdowns)
        uiTickTimer = new System.Threading.Timer(_ => InvokeAsync(async () => { 
            await InvokeAsync(StateHasChanged); 
        }), null, 1000, 1000);
    }

    void LoadData()
    {
        Operations = OperationRepo.GetAllScheduledOperations();
        Theaters = FacilityRepo.GetTheaters();
    }

    string GetRemainingTime(PatientOperation op)
    {
        var remaining = op.EndDate - DateTime.Now;
        if (remaining.TotalSeconds <= 0) return "00:00:00";
        return $"{(int)remaining.TotalHours:D2}:{remaining.Minutes:D2}:{remaining.Seconds:D2}";
    }

    async Task StartOperation(PatientOperation op)
    {
        var result = await DialogService.OpenAsync<StartSurgeryDialog>("Start Surgery",
            new Dictionary<string, object> { { "Operation", op } },
            new DialogOptions { Width = "500px" });

        if (result == true)
        {
            OperationRepo.UpdateOperationStatusAndCosts(op.OperationId, "Running", op.AgreedOperationCost, op.AgreedMedicineCost, op.AgreedEquipmentCost, op.TheaterId, actualStartTime: DateTime.Now, doctorId: op.DoctorId);

            if (op.TheaterId.HasValue)
            {
                FacilityRepo.UpdateTheaterStatus(op.TheaterId.Value, "Occupied");
            }

            NotificationService.Notify(NotificationSeverity.Info, "Surgery Commenced", $"{op.PatientName}'s surgery is now in progress.");
            LoadData();
        }
    }

    async Task CompleteOperation(PatientOperation op)
    {
        OperationRepo.UpdateOperationStatusAndCosts(op.OperationId, "Completed", op.AgreedOperationCost, op.AgreedMedicineCost, op.AgreedEquipmentCost, op.TheaterId);

        if (op.TheaterId.HasValue)
        {
            FacilityRepo.UpdateTheaterStatus(op.TheaterId.Value, "Available");
        }

        NotificationService.Notify(NotificationSeverity.Success, "Surgery Complete", $"{op.PatientName} has completed their procedure.");
        
        // Create formal notification for Admin
        NotificationRepo.CreateNotification(new Notification {
            Title = "Surgery Completed - Handover Required",
            Message = $"Operation for {op.PatientName} has concluded in {op.TheaterName}. Patient is ready for ward assignment.",
            TargetRole = "Admin",
            CreatedDate = DateTime.Now,
            IsRead = false
        });

        LoadData();
    }

    BadgeStyle GetStatusBadge(string status) => status switch
    {
        "Scheduled" => BadgeStyle.Info,
        "Running" => BadgeStyle.Warning,
        "Completed" => BadgeStyle.Success,
        _ => BadgeStyle.Light
    };

    public void Dispose()
    {
        dataRefreshTimer?.Dispose();
        uiTickTimer?.Dispose();
    }
}

