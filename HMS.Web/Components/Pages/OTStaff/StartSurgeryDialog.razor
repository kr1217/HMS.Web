@using HMS.Web.Models
@using HMS.Web.DAL
@inject FacilityRepository FacilityRepo
@inject DoctorRepository DoctorRepo
@inject OperationRepository OperationRepo
@inject DialogService DialogService

<RadzenCard Class="rz-p-6 rz-shadow-0">
    <RadzenStack Gap="1.5rem">
        <RadzenStack Gap="0.5rem" Class="rz-mb-4">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="play_circle" Style="color: var(--rz-primary); font-size: 1.5rem;" />
                <RadzenText Text="Commence Surgical Procedure" TextStyle="TextStyle.H6" Class="rz-m-0 rz-color-primary" />
            </RadzenStack>
            <RadzenText Text="@($"Confirm theater assignment and clinical leadership for {Operation.PatientName}.")" 
                        TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
        </RadzenStack>

        <RadzenTemplateForm TItem="PatientOperation" Data="@Operation" Submit="OnSubmit">
            <RadzenStack Gap="1.5rem">
                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Text="Designated Operation Theater" Component="TheaterId" TextStyle="TextStyle.Subtitle2" />
                    <RadzenDropDown @bind-Value="Operation.TheaterId" Data="@AvailableTheaters" TextProperty="TheaterName"
                                    ValueProperty="TheaterId" Placeholder="Select sterilized theater..." Style="width: 100%"
                                    Name="TheaterId" />
                    <RadzenRequiredValidator Component="TheaterId" Text="Theater assignment is clinically mandatory" />
                </RadzenStack>

                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Text="Attending Lead Surgeon" Component="DoctorId" TextStyle="TextStyle.Subtitle2" />
                    <RadzenDropDown @bind-Value="Operation.DoctorId" Data="@Doctors" TextProperty="FullName"
                                    ValueProperty="DoctorId" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    FilterOperator="StringFilterOperator.Contains" AllowFiltering="true" Placeholder="Assign lead surgeon..."
                                    Style="width: 100%" Name="DoctorId" />
                    <RadzenRequiredValidator Component="DoctorId" Text="Surgeon assignment is clinically mandatory" />
                </RadzenStack>

                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-6">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" />
                    <RadzenButton Text="Initiate Surgery" Icon="play_arrow" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" />
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenStack>
</RadzenCard>

@code {
    [Parameter] public PatientOperation Operation { get; set; } = new();

    List<OperationTheater> AvailableTheaters = new();
    List<Doctor> Doctors = new();

    protected override void OnInitialized()
    {
        // Get all theaters, but maybe highlight the ones that are available
        AvailableTheaters = FacilityRepo.GetTheaters().Where(t => t.Status == "Available" || t.TheaterId ==
        Operation.TheaterId).ToList();
        Doctors = DoctorRepo.GetDoctors();
    }

    void OnSubmit(PatientOperation op)
    {
        DialogService.Close(true);
    }
}
