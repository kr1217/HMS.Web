@*
 * FILE: Support.razor
 * PURPOSE: Patient-facing component for self-service portal.
 * COMMUNICATES WITH: SupportRepository, PatientRepository
*@
@page "/patient/support"
@using HMS.Web.DAL
@using HMS.Web.Models
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject SupportRepository SupportRepo
@inject PatientRepository PatientRepo
@inject AuthenticationStateProvider AuthStateProvider
@inject NotificationService NotificationService
@*
COMPONENT: Support & Inquiry Center
PURPOSE: Allows patients to submit support tickets and track their resolution status.
OPTIMIZATION: [Contextual Submission] Automatically links new tickets to the logged-in patient's record.
*@

<RadzenStack Class="rz-p-4 rz-p-md-6" Gap="2rem">
    <RadzenStack Gap="0.5rem">
        <RadzenText Text="Support Center" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
        <RadzenText Text="Submit inquiries, report issues, and communicate with our administrative team."
            TextStyle="TextStyle.Body1" Class="rz-color-text-secondary" />
    </RadzenStack>

    <RadzenRow Gap="2rem">
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard Class="rz-shadow-3 rz-p-6">
                <RadzenText Text="Open a New Ticket" TextStyle="TextStyle.H6" Class="rz-mb-4" />
                <EditForm Model="newTicket" OnValidSubmit="HandleSubmit">
                    <RadzenStack Gap="1.5rem">
                        <RadzenFormField Text="Issue Subject" Style="width: 100%;">
                            <RadzenTextBox @bind-Value="newTicket.Subject" Placeholder="Briefly specify the topic..." />
                        </RadzenFormField>

                        <RadzenFormField Text="Detailed Message" Style="width: 100%;">
                            <RadzenTextArea @bind-Value="newTicket.Message" Rows="4"
                                Placeholder="Provide detailed information regarding your request..." />
                        </RadzenFormField>

                        <RadzenButton Text="Submit Ticket" Icon="send" ButtonType="ButtonType.Submit"
                            ButtonStyle="ButtonStyle.Primary" Class="rz-w-100 rz-mt-2" />
                    </RadzenStack>
                </EditForm>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="8">
            <RadzenCard Class="rz-shadow-2 rz-p-0" Style="overflow: hidden; border-radius: 12px;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                    Class="rz-p-4 rz-background-color-base-100">
                    <RadzenIcon Icon="history" Style="color: var(--rz-primary);" />
                    <RadzenText Text="Your Support History" TextStyle="TextStyle.Subtitle1"
                        Class="rz-m-0 rz-font-weight-bold" />
                </RadzenStack>

                <RadzenStack Gap="0" Class="rz-p-4">
                    @if (tickets == null)
                    {
                        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
                            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="width: 150px;" />
                            <RadzenText Text="Synchronizing ticket history..." TextStyle="TextStyle.Caption" />
                        </RadzenStack>
                    }
                    else if (!tickets.Any())
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter"
                            AllowClose="false" Icon="info_outline">
                            No active or archived support tickets found.
                        </RadzenAlert>
                    }
                    else
                    {
                        <RadzenStack Gap="1rem">
                            @foreach (var tick in tickets.OrderByDescending(t => t.CreatedDate))
                            {
                                <RadzenCard Class="rz-p-4 rz-variant-flat rz-background-color-base-100"
                                    Style="border-left: 4px solid var(--rz-primary-light);">
                                    <RadzenStack Gap="1rem">
                                        <RadzenStack Orientation="Orientation.Horizontal"
                                            JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                            <RadzenStack Gap="0">
                                                <RadzenText Text="@tick.Subject" TextStyle="TextStyle.Subtitle2"
                                                    Class="rz-m-0" />
                                                <RadzenText Text="@tick.CreatedDate.ToString("MMM dd, yyyy")"
                                                    TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
                                            </RadzenStack>
                                            <RadzenBadge Text="@tick.Status" BadgeStyle="BadgeStyle.Secondary"
                                                Shade="Shade.Lighter" IsPill="true" />
                                        </RadzenStack>

                                        <RadzenText Text="@tick.Message" TextStyle="TextStyle.Body2" />

                                        @if (!string.IsNullOrEmpty(tick.Response))
                                        {
                                            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter"
                                                AllowClose="false" Size="AlertSize.Small">
                                                <RadzenStack Gap="0.25rem">
                                                    <RadzenText Text="Official Response" TextStyle="TextStyle.Caption"
                                                        Class="rz-font-weight-bold" />
                                                    <RadzenText Text="@tick.Response" TextStyle="TextStyle.Body2" />
                                                </RadzenStack>
                                            </RadzenAlert>
                                        }
                                    </RadzenStack>
                                </RadzenCard>
                            }
                        </RadzenStack>
                    }
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private SupportTicket newTicket = new SupportTicket();
    private List<SupportTicket>? tickets;
    private Patient? patient;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var authState = await AuthenticationStateTask;
            var user = authState.User;

            if (user.Identity.IsAuthenticated)
            {
                var userId = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                if (userId != null)
                {
                    patient = PatientRepo.GetPatientByUserId(userId);
                    if (patient != null)
                    {
                        tickets = SupportRepo.GetTicketsByPatientId(patient.PatientId);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Data Error", ex.Message);
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            if (patient != null)
            {
                newTicket.PatientId = patient.PatientId;
                SupportRepo.CreateTicket(newTicket);
                newTicket = new SupportTicket(); // Reset
                await LoadData(); // Refresh list
                NotificationService.Notify(NotificationSeverity.Success, "Ticket Submitted", "Your support request has been received.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Submission Error", $"Failed to submit ticket: {ex.Message}");
        }
    }
}

