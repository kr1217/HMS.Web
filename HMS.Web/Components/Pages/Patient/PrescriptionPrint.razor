@page "/patient/prescription/print/{PrescriptionId:int}"
@using HMS.Web.Models
@using HMS.Web.DAL
@using System.Text.Json
@layout EmptyLayout
@inject PrescriptionRepository PrescriptionRepo
@inject PatientRepository PatientRepo
@inject IJSRuntime JS

<!DOCTYPE html>
<html>

<head>
    <title>Prescription Print</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        body {
            padding: 20px;
        }

        @@media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>

<body>
    @if (Prescription == null)
    {
        <div class="alert alert-danger">Prescription not found.</div>
    }
    else
    {
        <div class="container">
            <div class="text-center mb-5 border-bottom pb-3">
                <h2 class="fw-bold">Hospital Management System</h2>
                <h5 class="text-muted">Prescription Slip</h5>
            </div>

            <div class="row mb-4">
                <div class="col-6">
                    <h5 class="fw-bold">Patient Details</h5>
                    <p class="mb-1"><strong>Name:</strong> @PatientName</p>
                    <p class="mb-1"><strong>Patient ID:</strong> @Prescription.PatientId</p>
                </div>
                <div class="col-6 text-end">
                    <h5 class="fw-bold">Prescription Details</h5>
                    <p class="mb-1"><strong>Date:</strong> @Prescription.PrescribedDate.ToShortDateString()</p>
                    <p class="mb-1"><strong>Doctor:</strong> Dr. @Prescription.DoctorName</p>
                    <p class="mb-1"><strong>ID:</strong> #@Prescription.PrescriptionId</p>
                </div>
            </div>

            <div class="card mb-4 border-0">
                <div class="card-body p-0">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Medications</h5>
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>Medicine</th>
                                <th>Dosage</th>
                                <th>Frequency</th>
                                <th>Duration</th>
                                <th>Instructions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var med in Medications)
                            {
                                <tr>
                                    <td><strong>@med.Name</strong></td>
                                    <td>@med.Dosage</td>
                                    <td>@med.Frequency</td>
                                    <td>@med.Duration</td>
                                    <td>@med.Instructions</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Prescription.Details))
            {
                <div class="mb-5">
                    <h5 class="fw-bold mb-2 border-bottom pb-2">Doctor's Notes / Diagnosis</h5>
                    <p>@Prescription.Details</p>
                </div>
            }

            <div class="row mt-5 pt-5">
                <div class="col-6">
                    <p class="text-muted small">Generated on @DateTime.Now.ToString("f")</p>
                </div>
                <div class="col-6 text-end">
                    <div class="border-top border-dark d-inline-block pt-2 px-5" style="width: 200px;">
                        Signature
                    </div>
                </div>
            </div>

            <div class="text-center mt-4 no-print">
                <button class="btn btn-primary" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print this Page
                </button>
            </div>
        </div>
    }
</body>

</html>

@code {
    [Parameter]
    public int PrescriptionId { get; set; }

    private Prescription? Prescription;
    private string PatientName = "";
    private List<PrescriptionMedication> Medications = new();

    protected override void OnInitialized()
    {
        Prescription = PrescriptionRepo.GetPrescriptionById(PrescriptionId);
        if (Prescription != null)
        {
            var patient = PatientRepo.GetPatientById(Prescription.PatientId);
            if (patient != null)
            {
                PatientName = patient.FullName;
            }

            if (!string.IsNullOrEmpty(Prescription.Medications))
            {
                try
                {
                    var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                    Medications = JsonSerializer.Deserialize<List<PrescriptionMedication>>(Prescription.Medications, options) ?? new
                    List<PrescriptionMedication>();
                }
                catch { }
            }
        }
    }
}
