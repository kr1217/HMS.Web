@*
 * FILE: Dashboard.razor
 * PURPOSE: Patient-facing component for self-service portal.
 * COMMUNICATES WITH: PatientRepository, AppointmentRepository
*@
@page "/patient/dashboard"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using HMS.Web.DAL
@using HMS.Web.Models
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject PatientRepository PatientRepo
@inject AppointmentRepository ApptRepo
@inject NavigationManager Nav
@inject NotificationService NotificationService
@attribute [Authorize]
@*
    COMPONENT: Patient Dashboard
    PURPOSE: Primary landing page for patients, aggregating health status, appointments, and profile management.
    OPTIMIZATION: [Lazy Profile Creation] Allows users to browse basic info but prompts for detailed profile completion only when necessary.
*@


<RadzenStack Class="rz-p-2 rz-p-md-4" Gap="2rem">
    <RadzenRow AlignItems="AlignItems.Center">
        <RadzenColumn Size="12" SizeMD="8">
            <RadzenText Text="Patient Portal" TextStyle="TextStyle.H3" Class="rz-color-primary rz-mb-1" />
            @if (CurrentPatient != null)
            {
                <RadzenText Text="@($"Welcome back, {CurrentPatient.FullName}")" TextStyle="TextStyle.Subtitle1"
                    Class="rz-color-text-secondary" />
            }
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="4" Class="rz-text-align-right">
            @if (CurrentPatient != null)
            {
                <RadzenButton Text="Book Appointment" Icon="calendar_month" ButtonStyle="ButtonStyle.Primary"
                    Click="@(() => Nav.NavigateTo("patient/appointments"))" />
            }
        </RadzenColumn>
    </RadzenRow>

    @if (IsLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 400px;">
            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
            <RadzenText Text="Retrieving your health records..." TextStyle="TextStyle.Caption" />
        </RadzenStack>
    }
    else if (CurrentPatient == null)
    {
        <RadzenCard Class="rz-p-6 rz-shadow-4" Style="border-radius: 16px;">
            <RadzenStack AlignItems="AlignItems.Center" Class="rz-mb-6">
                <RadzenIcon Icon="assignment_ind" Style="font-size: 4rem; color: var(--rz-primary);" />
                <RadzenText Text="Complete Health Profile" TextStyle="TextStyle.H4" />
                <RadzenText Text="We need a few details to provide you with the best healthcare experience."
                    TextStyle="TextStyle.Body2" />
            </RadzenStack>

            <EditForm Model="NewPatient" OnValidSubmit="CreateProfile" FormName="CreateProfileForm">
                <DataAnnotationsValidator />

                <RadzenTabs RenderMode="TabRenderMode.Client">
                    <Tabs>
                        <RadzenTabsItem Text="Identity & Contact" Icon="person">
                            <RadzenRow Gap="1rem" Class="rz-p-4">
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Full Name" Component="FullName" Style="width: 100%;">
                                        <RadzenTextBox Name="FullName" @bind-Value="NewPatient.FullName" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Contact Number" Component="Contact" Style="width: 100%;">
                                        <RadzenTextBox Name="Contact" @bind-Value="NewPatient.ContactNumber" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenFormField Text="Gender" Component="Gender" Style="width: 100%;">
                                        <RadzenDropDown Name="Gender" @bind-Value="NewPatient.Gender"
                                            Data="@(new[] { "Male", "Female", "Other" })" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenFormField Text="National ID (CNIC)" Component="CNIC" Style="width: 100%;">
                                        <RadzenTextBox Name="CNIC" @bind-Value="NewPatient.CNIC" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenFormField Text="Blood Group" Component="Blood" Style="width: 100%;">
                                        <RadzenDropDown Name="Blood" @bind-Value="NewPatient.BloodGroup"
                                            Data="@(new[] { "A+", "A-", "B+", "B-", "AB+", "AB-", "O+", "O-" })" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>
                        </RadzenTabsItem>
                        <RadzenTabsItem Text="Emergency & Health" Icon="emergency">
                            <RadzenRow Gap="1rem" Class="rz-p-4">
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Emergency Contact Name" Style="width: 100%;">
                                        <RadzenTextBox @bind-Value="NewPatient.EmergencyContactName" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Emergency Contact Phone" Style="width: 100%;">
                                        <RadzenTextBox @bind-Value="NewPatient.EmergencyContactNumber" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12">
                                    <RadzenFormField Text="Health Allergies" Style="width: 100%;">
                                        <RadzenTextArea @bind-Value="NewPatient.Allergies" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>
                        </RadzenTabsItem>
                    </Tabs>
                </RadzenTabs>

                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem"
                    Class="rz-mt-6">
                    @if (IsEditing)
                    {
                        <RadzenButton Text="Discard" ButtonStyle="ButtonStyle.Light" Click="CancelEdit" />
                    }
                    <RadzenButton Text="@(IsEditing ? "Update Profile" : "Register Profile")" ButtonType="ButtonType.Submit"
                        ButtonStyle="ButtonStyle.Primary" />
                </RadzenStack>
            </EditForm>
        </RadzenCard>
    }
    else
    {
        <RadzenRow Gap="2rem">
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenCard Class="rz-p-0 rz-shadow-3" Style="border-radius: 12px; overflow: hidden;">
                    <RadzenStack Class="rz-background-color-primary" Style="height: 100px;" />
                    <RadzenStack Class="rz-px-4 rz-pb-4" Style="margin-top: -50px;" AlignItems="AlignItems.Center">
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center"
                            Style="width: 100px; height: 100px; background: white; border-radius: 50%; box-shadow: var(--rz-shadow-2);">
                            <RadzenIcon Icon="person" Style="font-size: 4rem; color: var(--rz-primary);" />
                        </RadzenStack>
                        <RadzenText Text="@CurrentPatient.FullName" TextStyle="TextStyle.H5" Class="rz-m-0" />
                        <RadzenBadge Text="Verified Patient" BadgeStyle="BadgeStyle.Success" IsPill="true" />
                    </RadzenStack>

                    <RadzenStack Class="rz-p-4">
                        <RadzenStack Gap="1rem" Class="rz-mt-6">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="2">
                                <RadzenIcon Icon="contact_phone" Class="rz-color-text-secondary" />
                                <RadzenText Text="@CurrentPatient.ContactNumber" TextStyle="TextStyle.Body2" />
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="2">
                                <RadzenIcon Icon="bloodtype" Class="rz-color-danger" />
                                <RadzenText Text="@CurrentPatient.BloodGroup" TextStyle="TextStyle.Body2"
                                    Class="rz-color-danger rz-font-weight-bold" />
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="2">
                                <RadzenIcon Icon="home" Class="rz-color-text-secondary" />
                                <RadzenText Text="@CurrentPatient.Address" TextStyle="TextStyle.Body2" />
                            </RadzenStack>
                        </RadzenStack>

                        <RadzenButton Text="Update Details" Icon="edit" ButtonStyle="ButtonStyle.Base"
                            Variant="Variant.Text" Class="rz-w-100 rz-mt-4" Click="EditProfile" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="8">
                <RadzenRow Gap="1rem" Class="rz-mb-4">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenCard Class="rz-p-4 rz-display-flex rz-align-center"
                            Style="background: var(--rz-info-lighter);">
                            <RadzenIcon Icon="event_upcoming" Style="font-size: 3rem; color: var(--rz-info);"
                                Class="rz-mr-4" />
                            <RadzenStack>
                                <RadzenText Text="Upcoming Events" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                                <RadzenText
                                    Text="@DashboardAppointments.Count(a => a.AppointmentDate >= DateTime.Now).ToString()"
                                    TextStyle="TextStyle.H4" Class="rz-m-0 rz-font-weight-bold" />
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenCard Class="rz-p-4 rz-display-flex rz-align-center"
                            Style="background: var(--rz-success-lighter);">
                            <RadzenIcon Icon="receipt_long" Style="font-size: 3rem; color: var(--rz-success);"
                                Class="rz-mr-4" />
                            <RadzenStack>
                                <RadzenText Text="Active Prescriptions" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                                <RadzenText Text="3" TextStyle="TextStyle.H4" Class="rz-m-0 rz-font-weight-bold" />
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenCard Class="rz-shadow-2">
                    <RadzenText Text="Recent Activities" TextStyle="TextStyle.H6" Class="rz-mb-4" />
                    <RadzenStack Gap="1rem">
                        @foreach (var appt in DashboardAppointments.OrderByDescending(x => x.AppointmentDate).Take(3))
                        {
                            <RadzenCard Class="rz-p-4 rz-variant-flat rz-background-color-base-100"
                                Style="border-left: 4px solid var(--rz-primary);">
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenStack Gap="0">
                                        <RadzenText Text="@appt.DoctorName" TextStyle="TextStyle.Subtitle2" Class="rz-m-0" />
                                        <RadzenText Text="@appt.Reason" TextStyle="TextStyle.Caption" />
                                    </RadzenStack>
                                    <RadzenStack AlignItems="AlignItems.End" Gap="0">
                                        <RadzenText Text="@appt.AppointmentDate.ToString("MMM dd, yyyy")"
                                            TextStyle="TextStyle.Subtitle2" Class="rz-m-0" />
                                        <RadzenBadge Text="@appt.Status"
                                            BadgeStyle="@(appt.Status == "Approved" ? BadgeStyle.Success : BadgeStyle.Info)" />
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenCard>
                        }
                    </RadzenStack>
                    <RadzenButton Text="View All History" Variant="Variant.Text" Class="rz-mt-4"
                        Click="@(() => Nav.NavigateTo("patient/appointments"))" />
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

@code {
    private bool IsLoading = true;
    private Patient? CurrentPatient;
    [SupplyParameterFromForm]
    private Patient NewPatient { get; set; } = default!;
    private List<Appointment> DashboardAppointments = new();
    private string? UserId;
    private bool IsEditing = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Simulate a small delay to ensure loading state is visible (optional) or just run
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated ?? false)
            {
                NewPatient ??= new();
                UserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (UserId != null)
                {
                    // In a real app, use async DB calls. Here we wrap sync in Task for UI responsiveness if needed, but sync is fine.
                    CurrentPatient = PatientRepo.GetPatientByUserId(UserId);
                    if (CurrentPatient == null && string.IsNullOrEmpty(NewPatient.UserId))
                    {
                        NewPatient.UserId = UserId;
                    }

                    if (CurrentPatient != null)
                    {
                        DashboardAppointments = ApptRepo.GetAppointmentsByPatientId(CurrentPatient.PatientId);
                    }
                }
            }
        }
        catch (Exception ex)
        {
             NotificationService.Notify(NotificationSeverity.Error, "System Error", ex.Message);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void EditProfile()
    {
        if (CurrentPatient != null)
        {
            NewPatient = new Patient
                {
                    PatientId = CurrentPatient.PatientId,
                    UserId = CurrentPatient.UserId,
                    FullName = CurrentPatient.FullName,
                    ContactNumber = CurrentPatient.ContactNumber,
                    Gender = CurrentPatient.Gender,
                    Address = CurrentPatient.Address,
                    DateOfBirth = CurrentPatient.DateOfBirth,
                    CNIC = CurrentPatient.CNIC,
                    BloodGroup = CurrentPatient.BloodGroup,
                    MaritalStatus = CurrentPatient.MaritalStatus,
                    EmergencyContactName = CurrentPatient.EmergencyContactName,
                    EmergencyContactNumber = CurrentPatient.EmergencyContactNumber,
                    RelationshipToEmergencyContact = CurrentPatient.RelationshipToEmergencyContact,
                    Allergies = CurrentPatient.Allergies,
                    ChronicDiseases = CurrentPatient.ChronicDiseases,
                    CurrentMedications = CurrentPatient.CurrentMedications,
                    DisabilityStatus = CurrentPatient.DisabilityStatus,
                    RegistrationDate = CurrentPatient.RegistrationDate,
                    IsActive = CurrentPatient.IsActive,
                    Email = CurrentPatient.Email,
                    City = CurrentPatient.City,
                    Country = CurrentPatient.Country,
                    LastVisitDate = CurrentPatient.LastVisitDate,
                    PrimaryDoctorId = CurrentPatient.PrimaryDoctorId
                };
            IsEditing = true;
            CurrentPatient = null; // Force show form
        }
    }

    private void CancelEdit()
    {
        IsEditing = false;
        if (UserId != null)
        {
            CurrentPatient = PatientRepo.GetPatientByUserId(UserId);
        }
    }

    private void CreateProfile()
    {
        try
        {
            if (UserId != null)
            {
                if (IsEditing)
                {
                    PatientRepo.UpdatePatient(NewPatient);
                    IsEditing = false;
                }
                else
                {
                    NewPatient.UserId = UserId;
                    PatientRepo.CreatePatient(NewPatient);
                }
                CurrentPatient = PatientRepo.GetPatientByUserId(UserId);
                // Refresh
                NotificationService.Notify(NotificationSeverity.Success, "Profile Updated", "Your clinical profile has been successfully updated.");
            }
        }
        catch (Exception ex)
        {
             NotificationService.Notify(NotificationSeverity.Error, "Profile Error", $"Failed to update profile: {ex.Message}");
        }
    }
}

