@*
 * FILE: Appointments.razor
 * PURPOSE: Patient-facing component for self-service portal.
 * COMMUNICATES WITH: PatientRepository, AppointmentRepository, NotificationRepository
*@
@page "/patient/appointments"
@using Microsoft.AspNetCore.Authorization
@using HMS.Web.DAL
@using HMS.Web.Models
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject PatientRepository PatientRepo
@inject AppointmentRepository ApptRepo
@inject NotificationRepository NotificationRepo
@inject NavigationManager Nav
@inject NotificationService NotificationService
@attribute [Authorize]
@*
    COMPONENT: Appointment Booking Center
    PURPOSE: Enables patients to find doctors and schedule consultations using a streamlined workflow.
    OPTIMIZATION: [Smart Filtering] Pre-filters doctor lists by department for quicker booking.
*@
@rendermode InteractiveServer

<RadzenStack Class="rz-p-4 rz-p-md-6" Gap="2rem">
    <RadzenStack Gap="0.5rem">
        <RadzenText Text="Appointment Center" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
        <RadzenText Text="Schedule clinical consultations and manage your upcoming healthcare timeline."
            TextStyle="TextStyle.Body1" Class="rz-color-text-secondary" />
    </RadzenStack>

    @if (IsLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
            <RadzenText Text="Synchronizing with hospital registry..." TextStyle="TextStyle.Caption" />
        </RadzenStack>
    }
    else if (CurrentPatient == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false"
            Icon="info">
            Please
            <RadzenLink Text="complete your profile" Path="patient/dashboard" /> first to access appointment services.
        </RadzenAlert>
    }
    else
    {
        <RadzenRow Gap="2rem">
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard Class="rz-shadow-3 rz-p-6">
                    <RadzenText Text="Book New Appointment" TextStyle="TextStyle.H6" Class="rz-mb-4" />
                    <EditForm Model="NewAppointment" OnValidSubmit="BookAppointment" FormName="BookApptForm">
                        <DataAnnotationsValidator />
                        <RadzenStack Gap="1.5rem">
                            <RadzenFormField Text="Consulting Specialist" Style="width: 100%;">
                                <RadzenDropDown @bind-Value="NewAppointment.DoctorId" Data="@Doctors"
                                    TextProperty="FullName" ValueProperty="DoctorId" Placeholder="Choose a doctor...">
                                    <Template Context="doc">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                                            JustifyContent="JustifyContent.SpaceBetween" Class="rz-w-100">
                                            <RadzenText Text="@($"{doc.FullName} ({doc.DepartmentName})")"
                                                TextStyle="TextStyle.Body2" />
                                            <RadzenBadge Text="@doc.ConsultationFee.ToString("C")"
                                                BadgeStyle="BadgeStyle.Info" Shade="Shade.Lighter" />
                                        </RadzenStack>
                                    </Template>
                                </RadzenDropDown>
                            </RadzenFormField>

                            <RadzenFormField Text="Preferred Date & Time" Style="width: 100%;">
                                <RadzenDatePicker @bind-Value="NewAppointment.AppointmentDate" ShowTime="true"
                                    DateFormat="MMM dd, yyyy HH:mm" />
                            </RadzenFormField>

                            <RadzenFormField Text="Consultation Mode" Style="width: 100%;">
                                <RadzenDropDown @bind-Value="NewAppointment.AppointmentMode"
                                    Data="@(new[] { "Physical", "Online" })" />
                            </RadzenFormField>

                            <RadzenFormField Text="Reason for Visit" Style="width: 100%;">
                                <RadzenTextArea @bind-Value="NewAppointment.Reason"
                                    Placeholder="Briefly describe your health concern..." />
                            </RadzenFormField>

                            <RadzenButton Text="Initialize Booking" Icon="calendar_today" ButtonType="ButtonType.Submit"
                                ButtonStyle="ButtonStyle.Primary" Class="rz-w-100 rz-mt-2" />
                        </RadzenStack>
                    </EditForm>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard Class="rz-shadow-2 rz-p-0" Style="overflow: hidden; border-radius: 12px;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                        Class="rz-p-4 rz-background-color-base-100">
                        <RadzenIcon Icon="event_note" Style="color: var(--rz-primary);" />
                        <RadzenText Text="Your Appointment Registry" TextStyle="TextStyle.Subtitle1"
                            Class="rz-m-0 rz-font-weight-bold" />
                    </RadzenStack>

                    <RadzenStack Gap="0" Class="rz-p-4">
                        @if (AppointmentList.Count == 0)
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter"
                                AllowClose="false" Icon="info_outline">
                                No archived or upcoming appointments found.
                            </RadzenAlert>
                        }
                        else
                        {
                            <RadzenStack Gap="1rem">
                                @foreach (var appt in AppointmentList.OrderByDescending(a => a.AppointmentDate))
                                {
                                    <RadzenCard Class="rz-p-4 rz-variant-flat rz-background-color-base-100"
                                        Style="border-left: 4px solid var(--rz-primary-light);">
                                        <RadzenStack Orientation="Orientation.Horizontal"
                                            JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                            <RadzenStack Gap="0.25rem">
                                                <RadzenText Text="@appt.DoctorName" TextStyle="TextStyle.Subtitle2"
                                                    Class="rz-m-0" />
                                                <RadzenText
                                                    Text="@($"{appt.AppointmentDate:MMM dd, yyyy HH:mm} - {appt.AppointmentMode}")"
                                                    TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
                                                @if (!string.IsNullOrEmpty(appt.Reason))
                                                {
                                                    <RadzenText Text="@appt.Reason" TextStyle="TextStyle.Body2" Class="rz-mt-1" />
                                                }
                                            </RadzenStack>
                                            <RadzenBadge Text="@appt.Status" BadgeStyle="@GetStatusBadge(appt.Status)" IsPill="true"
                                                Shade="Shade.Lighter" />
                                        </RadzenStack>
                                    </RadzenCard>
                                }
                            </RadzenStack>
                        }
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

@code {
    private bool IsLoading = true;
    private Patient? CurrentPatient;
    private Appointment NewAppointment = new Appointment
        {
            AppointmentDate = DateTime.Now.AddDays(1),
            AppointmentMode =
        "Physical"
        };
    private List<Appointment> AppointmentList = new();
    private List<Doctor> Doctors = new();
    private string? UserId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated ?? false)
            {
                UserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (UserId != null)
                {
                    CurrentPatient = PatientRepo.GetPatientByUserId(UserId);
                    if (CurrentPatient != null)
                    {
                        AppointmentList = ApptRepo.GetAppointmentsByPatientId(CurrentPatient.PatientId);
                        Doctors = ApptRepo.GetDoctors();
                    }
                }
            }
        }
        catch (Exception ex)
        {
             NotificationService.Notify(NotificationSeverity.Error, "System Error", ex.Message);
        }
        finally
        {
             IsLoading = false;
        }
    }

    private void BookAppointment()
    {
        try
        {
            if (NewAppointment.DoctorId == 0) return; // Validation

            NewAppointment.PatientId = CurrentPatient!.PatientId;
            ApptRepo.CreateAppointment(NewAppointment);

            // Notify Doctor
            NotificationRepo.CreateNotification(new Notification
                {
                    DoctorId = NewAppointment.DoctorId,
                    TargetRole = "Doctor",
                    Title = "New Appointment Request",
                    Message = $"You have a new appointment request from {CurrentPatient.FullName} for {NewAppointment.AppointmentDate:f}.",
                    CreatedDate = DateTime.Now,
                    IsRead = false
                });

            // Refresh
            AppointmentList = ApptRepo.GetAppointmentsByPatientId(CurrentPatient.PatientId);
            NewAppointment = new Appointment { AppointmentDate = DateTime.Now.AddDays(1), AppointmentMode = "Physical" }; // Reset
            
            NotificationService.Notify(NotificationSeverity.Success, "Booking Confirmed", "Your appointment request has been sent for approval.");
        }
        catch (Exception ex)
        {
             NotificationService.Notify(NotificationSeverity.Error, "Booking Error", $"Failed to book appointment: {ex.Message}");
        }
    }

    private BadgeStyle GetStatusBadge(string status)
    {
        return status switch
        {
            "Confirmed" => BadgeStyle.Success,
            "Approved" => BadgeStyle.Success,
            "Pending" => BadgeStyle.Warning,
            "Cancelled" => BadgeStyle.Danger,
            "Rejected" => BadgeStyle.Danger,
            _ => BadgeStyle.Secondary
        };
    }
}

