@page "/patient/reports"
@using Microsoft.AspNetCore.Authorization
@using HMS.Web.DAL
@using HMS.Web.Models
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject PatientRepository PatientRepo
@inject ReportRepository ReportRepo
@attribute [Authorize]
@rendermode InteractiveServer

<RadzenStack Class="rz-p-4 rz-p-md-6" Gap="2rem">
    <RadzenStack Gap="0.5rem">
        <RadzenText Text="Medical Reports" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
        <RadzenText Text="Secure access to your laboratory results, diagnostic scans, and clinical summaries." TextStyle="TextStyle.Body1" Class="rz-color-text-secondary" />
    </RadzenStack>

    @if (IsLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
            <RadzenText Text="Synchronizing records..." TextStyle="TextStyle.Caption" />
        </RadzenStack>
    }
    else if (CurrentPatient == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="info">
            Please <RadzenLink Text="complete your profile" Path="patient/dashboard" /> first to view your medical reports.
        </RadzenAlert>
    }
    else
    {
        @if (ReportList.Count == 0)
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="folder_open">
                No diagnostic reports have been uploaded to your profile yet.
            </RadzenAlert>
        }
        else
        {
            <RadzenCard Class="rz-p-0 rz-shadow-4" Style="overflow: hidden; border-radius: 12px;">
                <RadzenDataGrid Data="@ReportList" TItem="Report" AllowPaging="true" PageSize="10" AllowSorting="true" Class="rz-border-none">
                    <Columns>
                        <RadzenDataGridColumn TItem="Report" Property="ReportDate" Title="Date" Width="150px">
                            <Template Context="report">
                                <RadzenText Text="@report.ReportDate.ToString("MMM dd, yyyy")" TextStyle="TextStyle.Body2" />
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Report" Property="ReportName" Title="Report Specification" />
                        <RadzenDataGridColumn TItem="Report" Property="ReportType" Title="Category" Width="150px">
                            <Template Context="report">
                                <RadzenBadge Text="@report.ReportType" IsPill="true" BadgeStyle="BadgeStyle.Info" Shade="Shade.Lighter" />
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Report" Property="Status" Title="Status" Width="120px">
                            <Template Context="report">
                                <RadzenBadge Text="@report.Status" IsPill="true" BadgeStyle="BadgeStyle.Success" Shade="Shade.Lighter" />
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Report" Title="Action" Width="150px" TextAlign="TextAlign.Right">
                            <Template Context="report">
                                <RadzenButton Icon="download" Text="Get File" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Variant="Variant.Flat" 
                                              Click="@(() => DownloadReport(report))" Path="@report.FilePath" Target="_blank" Component="a" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
        }
    }
</RadzenStack>

@code {
    private bool IsLoading = true;
    private Patient? CurrentPatient;
    private List<Report> ReportList = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated ?? false)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userId != null)
            {
                CurrentPatient = PatientRepo.GetPatientByUserId(userId);
                if (CurrentPatient != null)
                {
                    ReportList = ReportRepo.GetReportsByPatientId(CurrentPatient.PatientId);
                }
            }
        }
        IsLoading = false;
    }

    private void DownloadReport(Report report)
    {
        // Logic to download
        // For now, simple alert or console
    }
}
