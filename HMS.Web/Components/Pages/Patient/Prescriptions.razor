@*
 * FILE: Prescriptions.razor
 * PURPOSE: Patient-facing component for self-service portal.
 * COMMUNICATES WITH: PatientRepository, PrescriptionRepository
*@
@page "/patient/prescriptions"
@using Microsoft.AspNetCore.Authorization
@using HMS.Web.DAL
@using HMS.Web.Models
@using System.Security.Claims
@using System.Text.Json
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject PatientRepository PatientRepo
@inject PrescriptionRepository PrescriptionRepo
@inject IJSRuntime JS
@inject DialogService DialogService
@inject NotificationService NotificationService
@*
COMPONENT: Prescription Digital Archive
PURPOSE: Secure storage for patients to view and manage their medication history.
OPTIMIZATION: [JSON Deserialization] Robust parsing of medication lists stored as JSON in the database.
*@
@attribute [Authorize]
@rendermode InteractiveServer

<RadzenStack Class="rz-p-4 rz-p-md-6" Gap="2rem">
    <RadzenStack Gap="0.5rem">
        <RadzenText Text="My Prescriptions" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
        <RadzenText Text="Access your clinical medications, verify dosages, and download digitized records."
            TextStyle="TextStyle.Body1" Class="rz-color-text-secondary" />
    </RadzenStack>

    @if (IsLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
            <RadzenText Text="Synchronizing clinical records..." TextStyle="TextStyle.Caption" />
        </RadzenStack>
    }
    else if (CurrentPatient == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false"
            Icon="info">
            Please
            <RadzenLink Text="complete your profile" Path="patient/dashboard" /> first to view your digital prescriptions.
        </RadzenAlert>
    }
    else
    {
        <RadzenRow Gap="1.5rem">
            @foreach (var script in PrescriptionList)
            {
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenCard Class="rz-p-4 h-100 rz-shadow-2">
                        <RadzenStack Gap="1.5rem">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween"
                                AlignItems="AlignItems.Start">
                                <RadzenStack Gap="0">
                                    <RadzenText Text="@($"Dr. {script.DoctorName}")" TextStyle="TextStyle.H6"
                                        Class="rz-m-0 rz-color-primary" />
                                    <RadzenText Text="@script.PrescribedDate.ToString("MMM dd, yyyy")"
                                        TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
                                </RadzenStack>
                                <RadzenBadge Text="Prescribed" BadgeStyle="BadgeStyle.Success" Shade="Shade.Lighter"
                                    IsPill="true" />
                            </RadzenStack>

                            <RadzenText Text="@script.Details" TextStyle="TextStyle.Body2"
                                Class="rz-color-text-secondary rz-text-truncate" Style="max-height: 3em;" />

                            <RadzenButton Text="View & Download" Icon="description" ButtonStyle="ButtonStyle.Info"
                                Variant="Variant.Flat" Click="@(() => ViewPrescription(script))" Class="rz-w-100" />
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            }
            @if (PrescriptionList.Count == 0)
            {
                <RadzenColumn Size="12">
                    <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false"
                        Icon="medication">
                        No digital prescriptions have been issued to your profile yet.
                    </RadzenAlert>
                </RadzenColumn>
            }
        </RadzenRow>
    }
</RadzenStack>

@code {

    private bool IsLoading = true;
    private Patient? CurrentPatient;
    private List<Prescription> PrescriptionList = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated ?? false)
            {
                var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (userId != null)
                {
                    CurrentPatient = PatientRepo.GetPatientByUserId(userId);
                    if (CurrentPatient != null)
                    {
                        PrescriptionList = PrescriptionRepo.GetPrescriptionsByPatientId(CurrentPatient.PatientId);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "System Error", ex.Message);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task ViewPrescription(Prescription script)
    {
        try
        {
            await DialogService.OpenAsync("Prescription Details", ds =>
    @<RadzenStack Gap="1.5rem" Class="rz-p-4">
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween"
            AlignItems="AlignItems.Center" Class="rz-border-bottom rz-pb-4">
            <RadzenStack Gap="0">
                <RadzenText Text="@($"Dr. {script.DoctorName}")" TextStyle="TextStyle.Subtitle1"
                    Class="rz-m-0 rz-font-weight-bold" />
                <RadzenText Text="@script.PrescribedDate.ToString("MMMM dd, yyyy")" TextStyle="TextStyle.Caption"
                    Class="rz-color-text-secondary" />
            </RadzenStack>
            <RadzenStack AlignItems="AlignItems.End" Gap="0">
                <RadzenText Text="Patient" TextStyle="TextStyle.Caption" Class="rz-m-0" />
                <RadzenText Text="@CurrentPatient?.FullName" TextStyle="TextStyle.Subtitle2" />
            </RadzenStack>
        </RadzenStack>

        <RadzenText Text="Medications" TextStyle="TextStyle.Subtitle2" Class="rz-font-weight-bold" />
        <RadzenDataGrid Data="@GetMedications(script.Medications)" TItem="PrescriptionMedication" Density="Density.Compact"
            Class="rz-border-radius-1">
            <Columns>
                <RadzenDataGridColumn TItem="PrescriptionMedication" Property="Name" Title="Medicine" />
                <RadzenDataGridColumn TItem="PrescriptionMedication" Property="Dosage" Title="Dosage" Width="100px" />
                <RadzenDataGridColumn TItem="PrescriptionMedication" Property="Frequency" Title="Freq" Width="100px" />
                <RadzenDataGridColumn TItem="PrescriptionMedication" Property="Duration" Title="Dur" Width="100px" />
            </Columns>
        </RadzenDataGrid>

        @if (!string.IsNullOrEmpty(script.Details))
    {
        <RadzenStack Gap="0.5rem">
            <RadzenText Text="Clinical Notes" TextStyle="TextStyle.Subtitle2" Class="rz-font-weight-bold" />
            <RadzenAlert AlertStyle="AlertStyle.Light" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false"
                Size="AlertSize.Small">
                @script.Details
            </RadzenAlert>
        </RadzenStack>
    }

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-4">
            <RadzenButton Text="Close" ButtonStyle="ButtonStyle.Light" Click="() => ds.Close()" />
            <RadzenButton Text="Print / Download" Icon="print" ButtonStyle="ButtonStyle.Primary"
                Click="@(() => JS.InvokeVoidAsync("open", $"/patient/prescription/print/{script.PrescriptionId}", "_blank"))" />
        </RadzenStack>
    </RadzenStack>
, new DialogOptions { Width = "700px" });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Data Error", $"Failed to load prescription: {ex.Message}");
        }
    }

    private List<PrescriptionMedication> GetMedications(string json)
    {
        if (string.IsNullOrEmpty(json)) return new List<PrescriptionMedication>();
        try
        {
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            return JsonSerializer.Deserialize<List<PrescriptionMedication>>(json, options) ?? new List<PrescriptionMedication>();
        }
        catch
        {
            return new List<PrescriptionMedication>();
        }
    }
}

