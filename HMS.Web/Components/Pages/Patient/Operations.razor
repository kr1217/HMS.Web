@page "/patient/operations"
@using HMS.Web.DAL
@using HMS.Web.Models
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject OperationRepository OpRepo
@inject PatientRepository PatientRepo
@inject AuthenticationStateProvider AuthStateProvider

<RadzenStack Class="rz-p-4 rz-p-md-6" Gap="2rem">
    <RadzenStack Gap="0.5rem">
        <RadzenText Text="Zero-Movement Operation Experience" TextStyle="TextStyle.H4" Class="rz-m-0 rz-color-primary" />
        <RadzenText Text="Transparent packages. No hidden costs. Everything included." TextStyle="TextStyle.Body1" Class="rz-color-text-secondary" />
    </RadzenStack>

    @if (myOperations != null && myOperations.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="medical_services">
            <RadzenStack Gap="1rem">
                <RadzenText Text="Your Scheduled Operations" TextStyle="TextStyle.Subtitle1" Class="rz-m-0 rz-font-weight-bold" />
                <RadzenStack Gap="0.5rem">
                    @foreach (var op in myOperations)
                    {
                        <RadzenCard Class="rz-p-3 rz-shadow-1">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenStack Gap="0">
                                    <RadzenText Text="@op.PackageName" TextStyle="TextStyle.Subtitle2" Class="rz-m-0" />
                                    <RadzenText Text="@($"Scheduled: {op.ScheduledDate:MMM dd, yyyy}")" TextStyle="TextStyle.Caption" />
                                    @if (!string.IsNullOrEmpty(op.Notes))
                                    {
                                        <RadzenText Text="@op.Notes" TextStyle="TextStyle.Body2" Class="rz-mt-2" />
                                    }
                                </RadzenStack>
                                <RadzenBadge Text="@op.Status" IsPill="true" BadgeStyle="BadgeStyle.Warning" />
                            </RadzenStack>
                        </RadzenCard>
                    }
                </RadzenStack>
            </RadzenStack>
        </RadzenAlert>
    }

    <RadzenText Text="Available Surgical Packages" TextStyle="TextStyle.H5" Class="rz-mt-4" />

    @if (packages == null)
    {
        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-12">
            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
            <RadzenText Text="Fetching surgical packages..." TextStyle="TextStyle.Caption" />
        </RadzenStack>
    }
    else
    {
        <RadzenRow Gap="1.5rem">
            @foreach (var pkg in packages)
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                    <RadzenCard Class="rz-p-4 h-100 rz-shadow-2" Style="display: flex; flex-direction: column; justify-content: space-between;">
                        <RadzenStack Gap="1rem">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText Text="@pkg.PackageName" TextStyle="TextStyle.H6" Class="rz-m-0 rz-color-primary" />
                                <RadzenBadge Text="@pkg.Cost.ToString("C")" BadgeStyle="BadgeStyle.Success" Shade="Shade.Lighter" />
                            </RadzenStack>
                            <RadzenText Text="@pkg.Description" TextStyle="TextStyle.Body2" Class="rz-color-text-secondary" />
                        </RadzenStack>
                        <RadzenButton Text="View Details" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Text" Icon="info" Class="rz-mt-4 rz-align-self-start" />
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>
    }
</RadzenStack>

@code {
    private List<OperationPackage>? packages;
    private List<PatientOperation>? myOperations;
    private Patient? patient;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        packages = OpRepo.GetOperationPackages();

        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var userId = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (userId != null)
            {
                patient = PatientRepo.GetPatientByUserId(userId);
                if (patient != null)
                {
                    myOperations = OpRepo.GetPatientOperations(patient.PatientId);
                }
            }
        }
    }
}
