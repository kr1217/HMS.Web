@using HMS.Web.Models
@using HMS.Web.DAL
@inject FinanceRepository FinanceRepo
@inject BillingRepository BillingRepo
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime

<RadzenStack Gap="1.5rem">
    <!-- Detailed Bill View -->
    <RadzenCard Class="rz-p-0" Style="overflow: hidden; border-radius: 12px;">
        <RadzenAccordion>
            <Items>
                <RadzenAccordionItem Text="View Detailed Bill Audit" Icon="receipt_long">
                    <RadzenStack Gap="1.5rem" Class="rz-p-4" id="printable-bill">
                        <RadzenAlert AlertStyle="AlertStyle.Light" Variant="Variant.Flat" Shade="Shade.Lighter"
                            AllowClose="false" Class="rz-text-align-center rz-p-6"
                            Style="border: 1px solid var(--rz-border-color-light);">
                            <RadzenStack Gap="0.5rem">
                                <RadzenText Text="TOTAL AMOUNT" TextStyle="TextStyle.Caption"
                                    Class="rz-color-text-secondary rz-m-0" />
                                <RadzenText Text="@BillAmount.ToString("C")" TextStyle="TextStyle.H2"
                                    Class="rz-m-0 rz-font-weight-bold" />
                                @if (DueAmount > 0)
                                {
                                    <RadzenText Text="@($"Balance Due: {DueAmount:C}")" TextStyle="TextStyle.Subtitle2"
                                        Class="rz-color-danger rz-font-weight-bold" />
                                }
                            </RadzenStack>
                        </RadzenAlert>

                        <RadzenStack Gap="0.5rem">
                            <RadzenText Text="Internal Itemized Audit" TextStyle="TextStyle.Subtitle2"
                                Class="rz-font-weight-bold rz-border-bottom rz-pb-1" />
                            <RadzenDataGrid Data="@BillItems" TItem="BillItem" Density="Density.Compact"
                                Class="rz-border-none">
                                <Columns>
                                    <RadzenDataGridColumn TItem="BillItem" Title="Description">
                                        <Template Context="item">
                                            <RadzenStack Orientation="Orientation.Horizontal"
                                                AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenBadge Text="@item.Category" BadgeStyle="BadgeStyle.Secondary"
                                                    IsPill="true" Shade="Shade.Lighter" />
                                                <RadzenText Text="@item.Description" TextStyle="TextStyle.Body2" />
                                            </RadzenStack>
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="BillItem" Title="Amount" Width="120px"
                                        TextAlign="TextAlign.Right">
                                        <Template Context="item">
                                            <RadzenText Text="@item.Amount.ToString("C")" TextStyle="TextStyle.Body2" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        </RadzenStack>
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End"
                        Class="rz-p-4">
                        <RadzenButton Text="Print Bill" Icon="print" Size="ButtonSize.Small"
                            ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" Click="@PrintBill" />
                    </RadzenStack>
                </RadzenAccordionItem>
            </Items>
        </RadzenAccordion>
    </RadzenCard>

    <!-- Payment Form -->
    <RadzenTemplateForm Data="@paymentModel" Submit="@(async (Payment args) => await SubmitPayment(args))">
        <RadzenStack Gap="1.5rem">
            <RadzenCard Class="rz-shadow-2">
                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="6" Class="rz-text-align-center rz-text-align-md-left">
                        <RadzenStack Gap="0">
                            <RadzenText Text="Total Bill Amount" TextStyle="TextStyle.Caption"
                                Class="rz-color-text-secondary" />
                            <RadzenText Text="@BillAmount.ToString("C")" TextStyle="TextStyle.H5"
                                Class="rz-font-weight-bold" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6" Class="rz-text-align-center rz-text-align-md-right">
                        <RadzenStack Gap="0">
                            <RadzenText Text="Amount Due" TextStyle="TextStyle.Caption"
                                Class="rz-color-text-secondary" />
                            <RadzenText Text="@DueAmount.ToString("C")" TextStyle="TextStyle.H5"
                                Class="rz-color-danger rz-font-weight-bold" />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>

            <RadzenStack Gap="1rem">
                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Component="Amount" Text="Amount Received" TextStyle="TextStyle.Subtitle2" />
                    <RadzenNumeric @bind-Value="paymentModel.Amount" Name="Amount" Class="rz-w-100" Max="@DueAmount"
                        Format="C" />
                    <RadzenRequiredValidator Component="Amount" Text="Amount is required" />
                    <RadzenCompareValidator Value="@(0.01m)" Component="Amount" Text="Amount must be greater than 0"
                        Operator="CompareOperator.GreaterThanEqual" />
                </RadzenStack>

                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Component="PaymentMethod" Text="Payment Method" TextStyle="TextStyle.Subtitle2" />
                    <RadzenDropDown @bind-Value="paymentModel.PaymentMethod" Data="@paymentMethods" Name="PaymentMethod"
                        Class="rz-w-100" />
                    <RadzenRequiredValidator Component="PaymentMethod" Text="Method is required" />
                </RadzenStack>

                @if (paymentModel.PaymentMethod != "Cash")
                {
                    <RadzenStack Gap="0.5rem">
                        <RadzenLabel Component="ReferenceNumber" Text="Reference Number / Transaction ID"
                            TextStyle="TextStyle.Subtitle2" />
                        <RadzenTextBox @bind-Value="paymentModel.ReferenceNumber" Name="ReferenceNumber" Class="rz-w-100" />
                        <RadzenRequiredValidator Component="ReferenceNumber"
                            Text="Reference Number is required for digital payments" />
                    </RadzenStack>
                }

                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Component="Remarks" Text="Remarks (Optional)" TextStyle="TextStyle.Subtitle2" />
                    <RadzenTextArea @bind-Value="paymentModel.Remarks" Name="Remarks" Class="rz-w-100" Rows="2" />
                </RadzenStack>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem"
                Class="rz-mt-4">
                <RadzenButton ButtonType="ButtonType.Submit" Text="Confirm Payment" ButtonStyle="ButtonStyle.Primary"
                    Icon="check_circle" />
                <RadzenButton Text="Cancel" Click="@(() => DialogService.Close(false))"
                    ButtonStyle="ButtonStyle.Light" />
            </RadzenStack>
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenStack>

@code {
    [Parameter] public int BillId { get; set; }
    [Parameter] public int ShiftId { get; set; }

    Payment paymentModel = new Payment();
    decimal BillAmount = 0;
    decimal DueAmount = 0;
    List<string> paymentMethods = new List<string> { "Cash", "Card", "Bank Transfer" };
    List<BillItem> BillItems = new List<BillItem>();

    protected override async Task OnInitializedAsync()
    {
        var bill = FinanceRepo.GetBillById(BillId);
        if (bill != null)
        {
            BillAmount = bill.TotalAmount;
            DueAmount = bill.DueAmount;

            // Load Items
            BillItems = BillingRepo.GetBillItems(BillId);

            if (bill.Status == "Pending" && bill.PaidAmount == 0)
            {
                DueAmount = BillAmount;
            }

            paymentModel.BillId = BillId;
            paymentModel.ShiftId = ShiftId;
            paymentModel.Amount = DueAmount; // Default to full amount
            paymentModel.PaymentMethod = "Cash";

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            paymentModel.TellerId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value ?? "";
        }
    }

    async Task PrintBill()
    {
        await JSRuntime.InvokeVoidAsync("print");
    }

    async Task SubmitPayment(Payment payment)
    {
        try
        {
            FinanceRepo.AddPayment(payment);
            NotificationService.Notify(NotificationSeverity.Success, "Payment Recorded", "Receipt generated successfully.");
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
    }
}
