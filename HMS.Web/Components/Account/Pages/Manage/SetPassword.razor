@page "/Account/Manage/SetPassword"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using HMS.Web.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Credential Initialization | Set Password</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenText Text="Initialize Authorization Credentials" TextStyle="TextStyle.H5" Class="rz-m-0 rz-color-primary" />
    <StatusMessage Message="@message" />

    <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="lock_open">
        <RadzenText Text="Local Credential Required" TextStyle="TextStyle.Subtitle2" Class="rz-font-weight-bold" />
        <RadzenText Text="Your account currently lacks local authorization credentials. Establishing a local password enables direct terminal access without reliance on external federation services." TextStyle="TextStyle.Caption" />
    </RadzenAlert>

    <EditForm Model="Input" FormName="set-password" OnValidSubmit="OnValidSubmitAsync" method="post">
        <DataAnnotationsValidator />
        <ValidationSummary class="rz-color-danger" role="alert" />
        
        <RadzenStack Gap="1.5rem">
            <RadzenRow Gap="1rem">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.5rem">
                        <RadzenLabel Text="New Security Credential" Component="Input.NewPassword" TextStyle="TextStyle.Subtitle2" />
                        <RadzenTextBox @bind-Value="Input.NewPassword" Name="Input.NewPassword" Class="rz-w-100" 
                                       Style="height: 3rem; border-radius: 8px;" 
                                       type="password" autocomplete="new-password" placeholder="Enter new password" />
                        <ValidationMessage For="() => Input.NewPassword" Class="rz-color-danger" Style="font-size: 0.75rem;" />
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.5rem">
                        <RadzenLabel Text="Verify Security Credential" Component="Input.ConfirmPassword" TextStyle="TextStyle.Subtitle2" />
                        <RadzenTextBox @bind-Value="Input.ConfirmPassword" Name="Input.ConfirmPassword" Class="rz-w-100" 
                                       Style="height: 3rem; border-radius: 8px;" 
                                       type="password" autocomplete="new-password" placeholder="Confirm new password" />
                        <ValidationMessage For="() => Input.ConfirmPassword" Class="rz-color-danger" Style="font-size: 0.75rem;" />
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>

            <RadzenButton ButtonType="ButtonType.Submit" Text="Initialize Security Protocols" Icon="lock" 
                          ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large"
                          Class="rz-w-100 rz-mt-4" Style="height: 3.5rem; border-radius: 12px; font-weight: bold;" />
        </RadzenStack>
    </EditForm>
</RadzenStack>

@code {
    private string? message;
    private ApplicationUser? user;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        var hasPassword = await UserManager.HasPasswordAsync(user);
        if (hasPassword)
        {
            RedirectManager.RedirectTo("Account/Manage/ChangePassword");
        }
    }

    private async Task OnValidSubmitAsync()
    {
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        var addPasswordResult = await UserManager.AddPasswordAsync(user, Input.NewPassword!);
        if (!addPasswordResult.Succeeded)
        {
            message = $"Error: {string.Join(",", addPasswordResult.Errors.Select(error => error.Description))}";
            return;
        }

        await SignInManager.RefreshSignInAsync(user);
        RedirectManager.RedirectToCurrentPageWithStatus("Security protocols initialized successfully.", HttpContext);
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "New password")]
        public string? NewPassword { get; set; }

        [DataType(DataType.Password)]
        [Display(Name = "Confirm new password")]
        [Compare("NewPassword", ErrorMessage = "The new password and confirmation password do not match.")]
        public string? ConfirmPassword { get; set; }
    }
}
