@*
 * FILE: GenerateRecoveryCodes.razor
 * PURPOSE: Frontend web component.
 * COMMUNICATES WITH: None
*@
@page "/Account/Manage/GenerateRecoveryCodes"

@using Microsoft.AspNetCore.Identity
@using HMS.Web.Data

@inject UserManager<ApplicationUser> UserManager
@inject IdentityRedirectManager RedirectManager
@inject ILogger<GenerateRecoveryCodes> Logger

<PageTitle>Emergency Protocols | Recovery Code Generation</PageTitle>

<RadzenStack Gap="1.5rem">
    @if (recoveryCodes is not null)
    {
        <ShowRecoveryCodes RecoveryCodes="recoveryCodes.ToArray()" StatusMessage="@message" />
    }
    else
    {
        <RadzenText Text="Generate Emergency Recovery Protocols" TextStyle="TextStyle.H5" Class="rz-m-0 rz-color-primary" />

        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false"
            Icon="warning_amber">
            <RadzenStack Gap="0.5rem">
                <RadzenText Text="Critical Security Compliance Notice" TextStyle="TextStyle.Subtitle2"
                    Class="rz-font-weight-bold" />
                <RadzenText
                    Text="Store these protocols in a secure, offline environmnet. Loss of both authenticator terminal and recovery protocols will result in permanent institutional lockout."
                    TextStyle="TextStyle.Body2" />
                <RadzenText
                    Text="Generating new protocols does not alter authenticator terminal keys. To rotate terminal keys, utilize the 'Reset Authenticator' procedure."
                    TextStyle="TextStyle.Caption" Class="rz-mt-2" />
            </RadzenStack>
        </RadzenAlert>

        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" Class="rz-mt-4">
            <form @formname="generate-recovery-codes" @onsubmit="OnSubmitAsync" method="post">
                <AntiforgeryToken />
                <RadzenButton ButtonType="ButtonType.Submit" Text="Generate Recovery Protocols" Icon="lock_reset"
                    ButtonStyle="ButtonStyle.Danger" Variant="Variant.Filled" />
            </form>
        </RadzenStack>
    }
</RadzenStack>

@code {
    private string? message;
    private ApplicationUser? user;
    private IEnumerable<string>? recoveryCodes;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        var isTwoFactorEnabled = await UserManager.GetTwoFactorEnabledAsync(user);
        if (!isTwoFactorEnabled)
        {
            throw new InvalidOperationException("Cannot generate recovery codes for user because they do not have 2FA enabled.");
        }
    }

    private async Task OnSubmitAsync()
    {
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        recoveryCodes = await UserManager.GenerateNewTwoFactorRecoveryCodesAsync(user, 10);
        message = "New emergency recovery protocols have been generated.";

        Logger.LogInformation("User with ID '{UserId}' has generated new 2FA recovery codes.", userId);
    }
}

