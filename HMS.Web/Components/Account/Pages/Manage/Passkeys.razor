@page "/Account/Manage/Passkeys"

@using HMS.Web.Data
@using Microsoft.AspNetCore.Identity
@using System.ComponentModel.DataAnnotations
@using System.Buffers.Text

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Biometric Credentials | Passkeys</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenText Text="Biometric Access Control (Passkeys)" TextStyle="TextStyle.H5" Class="rz-m-0 rz-color-primary" />
    <StatusMessage />

    @if (currentPasskeys is { Count: > 0 })
    {
        <RadzenCard Class="rz-shadow-2">
            <RadzenText Text="Registered Biometric Credentials" TextStyle="TextStyle.Subtitle1" Class="rz-mb-4" />
            <RadzenStack Gap="1rem">
                @foreach (var passkey in currentPasskeys)
                {
                    <RadzenCard Variant="Variant.Flat" Class="rz-background-color-base-100 rz-p-3">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenIcon Icon="fingerprint" Style="color: var(--rz-primary);" />
                                <RadzenStack Gap="0">
                                    <RadzenText Text="@(passkey.Name ?? "Unnamed Credential")" TextStyle="TextStyle.Body1" Class="rz-m-0 rz-font-weight-bold" />
                                    <RadzenText Text="Secure Hardware Encrypted" TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
                                </RadzenStack>
                            </RadzenStack>

                            @{
                                var credentialId = Base64Url.EncodeToString(passkey.CredentialId);
                            }
                            <form @formname="@($"update-passkey-{credentialId}")" @onsubmit="UpdatePasskey" method="post">
                                <AntiforgeryToken />
                                <input type="hidden" name="CredentialId" value="@credentialId" />
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                    <RadzenButton ButtonType="ButtonType.Submit" Name="Action" Value="rename" 
                                                  Icon="edit" ButtonStyle="ButtonStyle.Info" Variant="Variant.Text" 
                                                  Text="Rename" />
                                    <RadzenButton ButtonType="ButtonType.Submit" Name="Action" Value="delete" 
                                                  Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" 
                                                  Text="Revoke" />
                                </RadzenStack>
                            </form>
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="info">
            <RadzenText Text="No biometric credentials registered." TextStyle="TextStyle.Body2" />
        </RadzenAlert>
    }

    <form @formname="add-passkey" @onsubmit="AddPasskey" method="post">
        <AntiforgeryToken />
        @if (currentPasskeys is { Count: >= MaxPasskeyCount })
        {
             <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="error">
                <RadzenText Text="Credential Limit Reached" TextStyle="TextStyle.Subtitle2" Class="rz-font-weight-bold" />
                <RadzenText Text="Maximum capacity for hardware credentials reached. Revoke an existing credential to enroll a new one." TextStyle="TextStyle.Caption" />
            </RadzenAlert>
        }
        else
        {
            <PasskeySubmit Operation="PasskeyOperation.Create" Name="Input">
                 <RadzenButton Text="Enroll New Biometric Credential" Icon="add_moderator" 
                               ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" Class="rz-w-100" />
            </PasskeySubmit>
        }
    </form>
</RadzenStack>

@code {
    private const int MaxPasskeyCount = 100;

    private ApplicationUser? user;
    private IList<UserPasskeyInfo>? currentPasskeys;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private string? Action { get; set; }

    [SupplyParameterFromForm]
    private string? CredentialId { get; set; }

    [SupplyParameterFromForm(FormName = "add-passkey")]
    private PasskeyInputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }
        currentPasskeys = await UserManager.GetPasskeysAsync(user);
    }

    private async Task AddPasskey()
    {
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        if (!string.IsNullOrEmpty(Input.Error))
        {
            RedirectManager.RedirectToCurrentPageWithStatus($"Error: {Input.Error}", HttpContext);
            return;
        }

        if (string.IsNullOrEmpty(Input.CredentialJson))
        {
            RedirectManager.RedirectToCurrentPageWithStatus("Error: The browser did not provide a passkey.", HttpContext);
            return;
        }

        if (currentPasskeys!.Count >= MaxPasskeyCount)
        {
            RedirectManager.RedirectToCurrentPageWithStatus($"Error: You have reached the maximum number of allowed passkeys.", HttpContext);
            return;
        }

        var attestationResult = await SignInManager.PerformPasskeyAttestationAsync(Input.CredentialJson);
        if (!attestationResult.Succeeded)
        {
            RedirectManager.RedirectToCurrentPageWithStatus($"Error: Could not add the passkey: {attestationResult.Failure.Message}", HttpContext);
            return;
        }

        var addPasskeyResult = await UserManager.AddOrUpdatePasskeyAsync(user, attestationResult.Passkey);
        if (!addPasskeyResult.Succeeded)
        {
            RedirectManager.RedirectToCurrentPageWithStatus("Error: The passkey could not be added to your account.", HttpContext);
            return;
        }

        // Immediately prompt the user to enter a name for the credential
        var credentialIdBase64Url = Base64Url.EncodeToString(attestationResult.Passkey.CredentialId);
        RedirectManager.RedirectTo($"Account/Manage/RenamePasskey/{credentialIdBase64Url}");
    }

    private async Task UpdatePasskey()
    {
        switch (Action)
        {
            case "rename":
                RedirectManager.RedirectTo($"Account/Manage/RenamePasskey/{CredentialId}");
                break;
            case "delete":
                await DeletePasskey();
                break;
            default:
                RedirectManager.RedirectToCurrentPageWithStatus($"Error: Unknown action '{Action}'.", HttpContext);
                break;
        }
    }

    private async Task DeletePasskey()
    {
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        byte[] credentialId;
        try
        {
            credentialId = Base64Url.DecodeFromChars(CredentialId);
        }
        catch (FormatException)
        {
            RedirectManager.RedirectToCurrentPageWithStatus("Error: The specified passkey ID had an invalid format.", HttpContext);
            return;
        }

        var result = await UserManager.RemovePasskeyAsync(user, credentialId);
        if (!result.Succeeded)
        {
            RedirectManager.RedirectToCurrentPageWithStatus("Error: The passkey could not be deleted.", HttpContext);
            return;
        }

        RedirectManager.RedirectToCurrentPageWithStatus("Passkey deleted successfully.", HttpContext);
    }
}
