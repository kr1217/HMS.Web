@*
 * FILE: EnableAuthenticator.razor
 * PURPOSE: Frontend web component.
 * COMMUNICATES WITH: None
*@
@page "/Account/Manage/EnableAuthenticator"

@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using HMS.Web.Data

@inject UserManager<ApplicationUser> UserManager
@inject UrlEncoder UrlEncoder
@inject IdentityRedirectManager RedirectManager
@inject ILogger<EnableAuthenticator> Logger

<PageTitle>Authenticator Orchestration | Configuration</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenText Text="Authenticator App Configuration" TextStyle="TextStyle.H5" Class="rz-m-0 rz-color-primary" />

    @if (recoveryCodes is not null)
    {
        <ShowRecoveryCodes RecoveryCodes="recoveryCodes.ToArray()" StatusMessage="@message" />
    }
    else
    {
        <StatusMessage Message="@message" />
        
        <RadzenCard Class="rz-shadow-3 rz-p-6" Style="border-radius: 12px;">
            <RadzenStack Gap="2rem">
                <RadzenText Text="Follow these steps to synchronize your authenticator terminal:" TextStyle="TextStyle.Body1" Class="rz-color-text-secondary" />

                <RadzenStack Gap="1.5rem">
                    <!-- Step 1 -->
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" Gap="1rem">
                        <RadzenBadge Text="1" BadgeStyle="BadgeStyle.Primary" IsPill="true" Style="font-size: 1.25rem; padding: 0.5rem 1rem;" />
                        <RadzenStack Gap="0.5rem">
                            <RadzenText Text="Download Authenticator Application" TextStyle="TextStyle.Subtitle1" Class="rz-font-weight-bold" />
                            <RadzenText TextStyle="TextStyle.Body2">
                                Install a trusted two-factor authenticator like Microsoft Authenticator for
                                <RadzenLink Path="https://go.microsoft.com/fwlink/?Linkid=825072" Text="Android" Target="_blank" /> or
                                <RadzenLink Path="https://go.microsoft.com/fwlink/?Linkid=825073" Text="iOS" Target="_blank" />.
                                Alternatively, use Google Authenticator for
                                <RadzenLink Path="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&amp;hl=en" Text="Android" Target="_blank" /> or
                                <RadzenLink Path="https://itunes.apple.com/us/app/google-authenticator/id388497605?mt=8" Text="iOS" Target="_blank" />.
                            </RadzenText>
                        </RadzenStack>
                    </RadzenStack>

                    <!-- Step 2 -->
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" Gap="1rem">
                        <RadzenBadge Text="2" BadgeStyle="BadgeStyle.Primary" IsPill="true" Style="font-size: 1.25rem; padding: 0.5rem 1rem;" />
                        <RadzenStack Gap="1rem" Class="rz-w-100">
                            <RadzenText Text="Synchronize Terminal" TextStyle="TextStyle.Subtitle1" Class="rz-font-weight-bold" />
                            <RadzenText TextStyle="TextStyle.Body2">
                                Scan the QR Code below or manually input this key into your authenticator app:
                            </RadzenText>
                            
                            <RadzenCard Variant="Variant.Flat" Class="rz-background-color-info-lighter rz-p-3 rz-text-align-center">
                                <RadzenText Text="@sharedKey" TextStyle="TextStyle.H5" Class="rz-m-0 rz-font-family-monospace Rz-color-info-dark" />
                            </RadzenCard>

                             <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Text" Shade="Shade.Lighter" AllowClose="false" Icon="qr_code_scanner">
                                <RadzenText Text="Visual Synchronization Protocol (QR Code)" TextStyle="TextStyle.Subtitle2" />
                            </RadzenAlert>
                            
                            <div data-url="@authenticatorUri" style="width: 200px; height: 200px; margin: 0 auto; background: #fff; padding: 1rem; border-radius: 8px; border: 1px solid var(--rz-border-color);"></div>
                        </RadzenStack>
                    </RadzenStack>

                    <!-- Step 3 -->
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" Gap="1rem">
                        <RadzenBadge Text="3" BadgeStyle="BadgeStyle.Primary" IsPill="true" Style="font-size: 1.25rem; padding: 0.5rem 1rem;" />
                        <RadzenStack Gap="1rem" Class="rz-w-100">
                            <RadzenText Text="Verify Synchronization" TextStyle="TextStyle.Subtitle1" Class="rz-font-weight-bold" />
                            <RadzenText TextStyle="TextStyle.Body2">
                                Enter the unique verification code generated by your app to finalize the orchestration.
                            </RadzenText>

                            <EditForm Model="Input" FormName="send-code" OnValidSubmit="OnValidSubmitAsync" method="post">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="rz-color-danger" role="alert" />
                                <RadzenStack Gap="1rem">
                                    <RadzenStack Gap="0.5rem">
                                        <RadzenLabel Text="Verification Token" Component="Input.Code" TextStyle="TextStyle.Subtitle2" />
                                        <RadzenTextBox @bind-Value="Input.Code" Name="Input.Code" Class="rz-w-100" 
                                                       Style="height: 3rem; border-radius: 8px; font-family: monospace; font-size: 1.2rem; letter-spacing: 2px;" 
                                                       autocomplete="off" placeholder="000 000" />
                                        <ValidationMessage For="() => Input.Code" Class="rz-color-danger" Style="font-size: 0.75rem;" />
                                    </RadzenStack>
                                    
                                    <RadzenButton ButtonType="ButtonType.Submit" Text="Verify & Activate" 
                                                  ButtonStyle="ButtonStyle.Primary" Icon="verified_user" 
                                                  Class="rz-w-100" Style="height: 3rem; border-radius: 8px; font-weight: bold;" />
                                </RadzenStack>
                            </EditForm>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>
    }
</RadzenStack>

<script type="text/javascript" src="@Assets["/lib/qrcode.js/qrcode.js"]"></script>
<script type="text/javascript">
    window.addEventListener('load', (event) => {
        const uri = document.querySelector('[data-url]').getAttribute('data-url');
        new QRCode(document.querySelector('[data-url]'), {
            text: uri,
            width: 150,
            height: 150
        });
    });
</script>

@code {
    private const string AuthenticatorUriFormat = "otpauth://totp/{0}:{1}?secret={2}&issuer={0}&digits=6";

    private string? message;
    private ApplicationUser? user;
    private string? sharedKey;
    private string? authenticatorUri;
    private IEnumerable<string>? recoveryCodes;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        await LoadSharedKeyAndQrCodeUriAsync(user);
    }

    private async Task OnValidSubmitAsync()
    {
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        // Strip spaces and hyphens
        var verificationCode = Input.Code.Replace(" ", string.Empty).Replace("-", string.Empty);

        var is2faTokenValid = await UserManager.VerifyTwoFactorTokenAsync(
            user, UserManager.Options.Tokens.AuthenticatorTokenProvider, verificationCode);

        if (!is2faTokenValid)
        {
            message = "Error: Verification code is invalid.";
            return;
        }

        await UserManager.SetTwoFactorEnabledAsync(user, true);
        var userId = await UserManager.GetUserIdAsync(user);
        Logger.LogInformation("User with ID '{UserId}' has enabled 2FA with an authenticator app.", userId);

        message = "Your authenticator app has been verified.";

        if (await UserManager.CountRecoveryCodesAsync(user) == 0)
        {
            recoveryCodes = await UserManager.GenerateNewTwoFactorRecoveryCodesAsync(user, 10);
        }
        else
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/TwoFactorAuthentication", message, HttpContext);
        }
    }

    private async ValueTask LoadSharedKeyAndQrCodeUriAsync(ApplicationUser user)
    {
        // Load the authenticator key & QR code URI to display on the form
        var unformattedKey = await UserManager.GetAuthenticatorKeyAsync(user);
        if (string.IsNullOrEmpty(unformattedKey))
        {
            await UserManager.ResetAuthenticatorKeyAsync(user);
            unformattedKey = await UserManager.GetAuthenticatorKeyAsync(user);
        }

        sharedKey = FormatKey(unformattedKey!);

        var email = await UserManager.GetEmailAsync(user);
        authenticatorUri = GenerateQrCodeUri(email!, unformattedKey!);
    }

    private string FormatKey(string unformattedKey)
    {
        var result = new StringBuilder();
        int currentPosition = 0;
        while (currentPosition + 4 < unformattedKey.Length)
        {
            result.Append(unformattedKey.AsSpan(currentPosition, 4)).Append(' ');
            currentPosition += 4;
        }
        if (currentPosition < unformattedKey.Length)
        {
            result.Append(unformattedKey.AsSpan(currentPosition));
        }

        return result.ToString().ToLowerInvariant();
    }

    private string GenerateQrCodeUri(string email, string unformattedKey)
    {
        return string.Format(
            CultureInfo.InvariantCulture,
            AuthenticatorUriFormat,
            UrlEncoder.Encode("Antigravity Hospital"),
            UrlEncoder.Encode(email),
            unformattedKey);
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(7, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Text)]
        [Display(Name = "Verification Code")]
        public string Code { get; set; } = "";
    }
}

