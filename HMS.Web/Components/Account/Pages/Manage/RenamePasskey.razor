@page "/Account/Manage/RenamePasskey/{Id}"

@using HMS.Web.Data
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using System.Buffers.Text

@inject UserManager<ApplicationUser> UserManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Credential Management | Rename</PageTitle>

<RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 50vh;">
    <RadzenCard Class="rz-shadow-4 rz-p-6" Style="width: 100%; max-width: 500px;">
        <RadzenStack Gap="1.5rem">
             <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="edit" Style="font-size: 3rem; color: var(--rz-primary);" />
                <RadzenText Text="Update Credential Alias" TextStyle="TextStyle.H5" Class="rz-m-0 rz-color-primary" />
            </RadzenStack>

            <EditForm Model="Input" OnValidSubmit="Rename" FormName="rename-passkey" method="post">
                <DataAnnotationsValidator />
                <ValidationSummary class="rz-color-danger" role="alert" />
                
                <RadzenStack Gap="1.5rem">
                    <RadzenText Text="@(passkey?.Name is { } name ? $"Current Alias: {name}" : "Assign an alias for this new biometric credential")" 
                                TextStyle="TextStyle.Body1" Class="rz-text-align-center rz-color-text-secondary" />

                    <RadzenStack Gap="0.5rem">
                        <RadzenLabel Text="New Credential Alias" Component="Input.Name" TextStyle="TextStyle.Subtitle2" />
                        <RadzenTextBox @bind-Value="Input.Name" Name="Input.Name" Class="rz-w-100" 
                                       Style="height: 3rem; border-radius: 8px;" 
                                       aria-required="true" placeholder="e.g., Clinical Tablet, Office Workstation" />
                        <ValidationMessage For="() => Input.Name" Class="rz-color-danger" Style="font-size: 0.75rem;" />
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Class="rz-mt-2">
                         <RadzenButton ButtonType="ButtonType.Submit" Text="Save Alias" Icon="save" 
                                      ButtonStyle="ButtonStyle.Primary" Class="rz-w-100" />
                         <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" 
                                       Class="rz-w-100" Click="@(() => RedirectManager.RedirectTo("Account/Manage/Passkeys"))" />
                    </RadzenStack>
                </RadzenStack>
            </EditForm>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private ApplicationUser? user;
    private UserPasskeyInfo? passkey;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [Parameter]
    public string? Id { get; set; }

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        user = (await UserManager.GetUserAsync(HttpContext.User))!;
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        byte[] credentialId;
        try
        {
            credentialId = Base64Url.DecodeFromChars(Id);
        }
        catch (FormatException)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The specified passkey ID had an invalid format.", HttpContext);
            return;
        }

        passkey = await UserManager.GetPasskeyAsync(user, credentialId);
        if (passkey is null)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The specified passkey could not be found.", HttpContext);
            return;
        }
    }

    private async Task Rename()
    {
        passkey!.Name = Input.Name;
        var result = await UserManager.AddOrUpdatePasskeyAsync(user!, passkey);
        if (!result.Succeeded)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The passkey could not be updated.", HttpContext);
            return;
        }

        RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Passkey updated successfully.", HttpContext);
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(200, ErrorMessage = "Passkey names must be no longer than {1} characters.")]
        public string Name { get; set; } = "";
    }
}
