@*
 * FILE: LoginWithRecoveryCode.razor
 * PURPOSE: Frontend web component.
 * COMMUNICATES WITH: None
*@
@page "/Account/LoginWithRecoveryCode"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using HMS.Web.Data

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IdentityRedirectManager RedirectManager
@inject ILogger<LoginWithRecoveryCode> Logger

<PageTitle>Emergency Recovery | Authorization</PageTitle>

<RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 100vh; padding: 2rem; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
    <RadzenCard Class="rz-shadow-4 rz-p-8 rz-p-md-12" Style="width: 100%; max-width: 500px; border-radius: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);">
        <RadzenStack Gap="2rem">
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="history_edu" Style="font-size: 4rem; color: var(--rz-primary);" />
                <RadzenText Text="Antigravity Hospital" TextStyle="TextStyle.H4" Class="rz-m-0 rz-font-weight-black rz-color-primary" />
                <RadzenText Text="Emergency Recovery Authorization" TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
            </RadzenStack>

            <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false" Icon="priority_high">
                <RadzenText Text="Engagement Notice" TextStyle="TextStyle.Subtitle2" Class="rz-font-weight-bold" />
                <RadzenText Text="You are initiating an emergency recovery protocol. This session will not be cached until standard multi-factor synchronization is re-established." TextStyle="TextStyle.Caption" />
            </RadzenAlert>

            <StatusMessage Message="@message" />

            <EditForm Model="Input" FormName="login-with-recovery-code" OnValidSubmit="OnValidSubmitAsync" method="post">
                <DataAnnotationsValidator />
                <RadzenStack Gap="1.5rem">
                    <RadzenStack Gap="0.5rem">
                        <RadzenLabel Text="Emergency Recovery Identifier" Component="Input.RecoveryCode" TextStyle="TextStyle.Subtitle2" />
                        <RadzenTextBox @bind-Value="Input.RecoveryCode" Name="Input.RecoveryCode" Class="rz-w-100" 
                                       Style="height: 3.5rem; border-radius: 8px; font-family: monospace; text-align: center; font-size: 1.25rem;" 
                                       autocomplete="off" placeholder="XXXXX-XXXXX" />
                        <ValidationMessage For="() => Input.RecoveryCode" Class="rz-color-danger" Style="font-size: 0.75rem;" />
                    </RadzenStack>

                    <RadzenButton ButtonType="ButtonType.Submit" Text="Authorize Emergency Access" 
                                  ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" Icon="emergency"
                                  Class="rz-w-100 rz-mt-4" Style="height: 3.5rem; border-radius: 12px; font-weight: bold;" />

                    <RadzenStack AlignItems="AlignItems.Center" Class="rz-mt-4">
                        <RadzenLink Path="@($"Account/LoginWith2fa?ReturnUrl={ReturnUrl}")" 
                                    Text="Return to Standard 2FA Synchronization" Icon="arrow_back" TextStyle="TextStyle.Caption" />
                    </RadzenStack>
                </RadzenStack>
            </EditForm>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private string? message;
    private ApplicationUser user = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();
    }

    protected override async Task OnParametersSetAsync()
    {
        user = await SignInManager.GetTwoFactorAuthenticationUserAsync() ??
            throw new InvalidOperationException("Unable to load multi-factor orchestration user.");
    }

    private async Task OnValidSubmitAsync()
    {
        var recoveryCode = Input.RecoveryCode.Replace(" ", string.Empty);

        var result = await SignInManager.TwoFactorRecoveryCodeSignInAsync(recoveryCode);

        var userId = await UserManager.GetUserIdAsync(user);

        if (result.Succeeded)
        {
            Logger.LogInformation("User with ID '{UserId}' synchronized via recovery code.", userId);
            RedirectManager.RedirectTo(ReturnUrl);
        }
        else if (result.IsLockedOut)
        {
            Logger.LogWarning("User account orchestration locked.");
            RedirectManager.RedirectTo("Account/Lockout");
        }
        else
        {
            Logger.LogWarning("Invalid recovery protocol orchestrated for user with ID '{UserId}' ", userId);
            message = "Error: Invalid recovery protocol orchestrated.";
        }
    }

    private sealed class InputModel
    {
        [Required]
        [DataType(DataType.Text)]
        [Display(Name = "Recovery Code")]
        public string RecoveryCode { get; set; } = "";
    }
}

