@page "/Account/Register"

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using HMS.Web.Data

@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject ILogger<Register> Logger
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager
@inject RoleManager<IdentityRole> RoleManager

<PageTitle>Clinical Gateway | Enrollment</PageTitle>

<RadzenCard Class="rz-shadow-6 rz-p-8 rz-p-md-12" Style="width: 100%; max-width: 900px; border-radius: 24px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);">
    <RadzenStack Gap="2rem">
        <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="app_registration" Style="font-size: 4rem; color: var(--rz-primary);" />
            <RadzenText Text="Antigravity Hospital" TextStyle="TextStyle.H4" Class="rz-m-0 rz-font-weight-black rz-color-primary" />
            <RadzenText Text="Clinical & Personnel Enrollment Portal" TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-mt-2">
                <RadzenIcon Icon="verified_user" Style="font-size: 1rem; color: var(--rz-success);" />
                <RadzenText Text="Secure Registration Gateway" TextStyle="TextStyle.Overline" Class="rz-m-0" />
            </RadzenStack>
        </RadzenStack>

        <StatusMessage Message="@Message" />

        <RadzenRow Gap="3rem">
            <!-- Registration Form -->
            <RadzenColumn Size="12" SizeMD="7">
                <EditForm Model="Input" method="post" OnValidSubmit="RegisterUser" FormName="register">
                    <DataAnnotationsValidator />
                    <RadzenStack Gap="1.5rem">
                        <RadzenText Text="Create Identity" TextStyle="TextStyle.H6" Class="rz-color-primary rz-border-bottom rz-pb-2" />
                        
                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Institutional Email" Component="Input.Email" TextStyle="TextStyle.Subtitle2" />
                            <RadzenTextBox @bind-Value="Input.Email" Name="Input.Email" Class="rz-w-100" 
                                           Style="height: 3rem; border-radius: 8px;" 
                                           autocomplete="username" aria-required="true" Placeholder="name@antigravity.hospital" />
                            <ValidationMessage For="() => Input.Email" Class="rz-color-danger rz-text-align-left" Style="font-size: 0.75rem;" />
                        </RadzenStack>

                        <RadzenRow Gap="1rem">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenLabel Text="Security Key" Component="Input.Password" TextStyle="TextStyle.Subtitle2" />
                                    <RadzenPassword Name="Input.Password" @bind-Value="Input.Password" 
                                           Class="rz-w-100" 
                                           Style="height: 3rem; border-radius: 8px;" 
                                           AutoComplete="true" aria-required="true" />
                                    <ValidationMessage For="() => Input.Password" Class="rz-color-danger rz-text-align-left" Style="font-size: 0.75rem;" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenLabel Text="Validate Key" Component="Input.ConfirmPassword" TextStyle="TextStyle.Subtitle2" />
                                    <RadzenPassword Name="Input.ConfirmPassword" @bind-Value="Input.ConfirmPassword" 
                                           Class="rz-w-100" 
                                           Style="height: 3rem; border-radius: 8px;" 
                                           AutoComplete="true" aria-required="true" />
                                    <ValidationMessage For="() => Input.ConfirmPassword" Class="rz-color-danger rz-text-align-left" Style="font-size: 0.75rem;" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Employee ID (Staff Only)" Component="Input.EmployeeId" TextStyle="TextStyle.Subtitle2" />
                            <RadzenTextBox @bind-Value="Input.EmployeeId" Name="Input.EmployeeId" Class="rz-w-100" 
                                           Style="height: 3rem; border-radius: 8px;" 
                                           Placeholder="Leave empty for Patients (e.g., DR-001, AS-100, OS-500)" />
                            <RadzenText Text="Input your issued ID to be automatically assigned your operational role." TextStyle="TextStyle.Caption" Class="rz-color-text-secondary rz-font-italic" />
                            <ValidationMessage For="() => Input.EmployeeId" Class="rz-color-danger rz-text-align-left" Style="font-size: 0.75rem;" />
                        </RadzenStack>

                        <RadzenButton ButtonType="ButtonType.Submit" Text="Complete Enrollment" 
                                      ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" Icon="check_circle"
                                      Class="rz-w-100 rz-mt-2" Style="height: 3.5rem; border-radius: 12px; font-weight: bold; background: linear-gradient(to right, var(--rz-primary), var(--rz-primary-dark));" />
                    </RadzenStack>
                </EditForm>
            </RadzenColumn>

            <!-- External Login -->
            <RadzenColumn Size="12" SizeMD="5">
                <RadzenStack Gap="1.5rem" Class="rz-h-100 rz-p-4 rz-background-color-base-100 rz-border-radius-2" Style="border: 1px solid var(--rz-border-color-light); background-color: #f8f9fa;">
                    <RadzenText Text="Federated Access" TextStyle="TextStyle.H6" Class="rz-color-primary rz-border-bottom rz-pb-2" />
                    <RadzenText Text="Authenticate using your institutional credentials." TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
                    <ExternalLoginPicker />
                    
                    <RadzenStack AlignItems="AlignItems.Center" Class="rz-mt-auto">
                        <RadzenText Text="ENROLLED PERSONNEL" TextStyle="TextStyle.Overline" Class="rz-color-text-disabled" />
                        <RadzenButton Text="Access Terminal" Click="@(() => NavigationManager.NavigateTo("Account/Login"))" 
                                      Variant="Variant.Outlined" ButtonStyle="ButtonStyle.Primary" Icon="login" Class="rz-w-100" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenStack>
</RadzenCard>

@code {
    private IEnumerable<IdentityError>? identityErrors;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    private string? Message => identityErrors is null ? null : $"Error: {string.Join(", ", identityErrors.Select(error => error.Description))}";

    protected override void OnInitialized()
    {
        Input ??= new();
    }

    public async Task RegisterUser(EditContext editContext)
    {
        // 1. Determine Role from Employee ID
        string roleName = "Patient"; // Default
        string? empId = Input.EmployeeId?.Trim().ToUpper();

        if (!string.IsNullOrWhiteSpace(empId))
        {
            if (empId.StartsWith("DR-")) roleName = "Doctor";
            else if (empId.StartsWith("AS-")) roleName = "Admin";
            else if (empId.StartsWith("OS-")) roleName = "OTStaff";
            else if (empId.StartsWith("FB-")) roleName = "Teller";
            else
            {
                // Invalid Employee ID format provided
                identityErrors = new List<IdentityError> { new IdentityError { Description = "Invalid Employee ID format. Use DR-xxx, AS-xxx, or OS-xxx." } };
                return;
            }
        }

        var user = CreateUser();

        await UserStore.SetUserNameAsync(user, Input.Email, CancellationToken.None);
        var emailStore = GetEmailStore();
        await emailStore.SetEmailAsync(user, Input.Email, CancellationToken.None);
        
        // Note: We are not storing EmployeeId in DB yet as per current schema, 
        // using it only for authorized role assignment validation.
        
        var result = await UserManager.CreateAsync(user, Input.Password);

        if (!result.Succeeded)
        {
            identityErrors = result.Errors;
            return;
        }

        // Ensure roles exist
        if (!await RoleManager.RoleExistsAsync(roleName)) 
        {
            await RoleManager.CreateAsync(new IdentityRole(roleName));
        }

        await UserManager.AddToRoleAsync(user, roleName);

        Logger.LogInformation("User created a new account with password and assigned role {Role} based on EmpID {EmpID}.", roleName, empId ?? "None");

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code, ["returnUrl"] = ReturnUrl });

        await EmailSender.SendConfirmationLinkAsync(user, Input.Email, HtmlEncoder.Default.Encode(callbackUrl));

        if (UserManager.Options.SignIn.RequireConfirmedAccount)
        {
            RedirectManager.RedirectTo(
                "Account/RegisterConfirmation",
                new() { ["email"] = Input.Email, ["returnUrl"] = ReturnUrl });
        }
        else
        {
            try {
                await SignInManager.SignInAsync(user, isPersistent: false);
                RedirectManager.RedirectTo(ReturnUrl);
            } catch (Exception) { /* Ignore sign-in errors and redirect */ RedirectManager.RedirectTo(ReturnUrl); }
        }
    }

    private ApplicationUser CreateUser()
    {
        try
        {
            return Activator.CreateInstance<ApplicationUser>();
        }
        catch
        {
            throw new InvalidOperationException($"Can't create an instance of '{nameof(ApplicationUser)}'. " +
                $"Ensure that '{nameof(ApplicationUser)}' is not an abstract class and has a parameterless constructor.");
        }
    }

    private IUserEmailStore<ApplicationUser> GetEmailStore()
    {
        if (!UserManager.SupportsUserEmail)
        {
            throw new NotSupportedException("The default UI requires a user store with email support.");
        }
        return (IUserEmailStore<ApplicationUser>)UserStore;
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        [Display(Name = "Email")]
        public string Email { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "Password")]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm password")]
        [Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
        public string ConfirmPassword { get; set; } = "";
        
        [Display(Name = "Employee ID")]
        public string? EmployeeId { get; set; }
    }
}


