@*
 * FILE: LoginWith2fa.razor
 * PURPOSE: Frontend web component.
 * COMMUNICATES WITH: None
*@
@page "/Account/LoginWith2fa"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using HMS.Web.Data

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IdentityRedirectManager RedirectManager
@inject ILogger<LoginWith2fa> Logger

<PageTitle>Multi-Factor Authorization | 2FA</PageTitle>

<RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center"
    Style="min-height: 100vh; padding: 2rem; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
    <RadzenCard Class="rz-shadow-4 rz-p-8 rz-p-md-12"
        Style="width: 100%; max-width: 500px; border-radius: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);">
        <RadzenStack Gap="2rem">
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="security" Style="font-size: 4rem; color: var(--rz-primary);" />
                <RadzenText Text="Antigravity Hospital" TextStyle="TextStyle.H4"
                    Class="rz-m-0 rz-font-weight-black rz-color-primary" />
                <RadzenText Text="Multi-Factor Synchronization" TextStyle="TextStyle.Caption"
                    Class="rz-color-text-secondary" />
            </RadzenStack>

            <RadzenText
                Text="Your institutional access is protected by multi-factor orchestration. Enter the token generated by your authenticator terminal."
                TextStyle="TextStyle.Body2" Class="rz-text-align-center rz-color-text-secondary" />

            <StatusMessage Message="@message" />

            <EditForm Model="Input" FormName="login-with-2fa" OnValidSubmit="OnValidSubmitAsync" method="post">
                <input type="hidden" name="ReturnUrl" value="@ReturnUrl" />
                <input type="hidden" name="RememberMe" value="@RememberMe" />
                <DataAnnotationsValidator />

                <RadzenStack Gap="1.5rem">
                    <RadzenStack Gap="0.5rem">
                        <RadzenLabel Text="Authenticator Token" Component="Input.TwoFactorCode"
                            TextStyle="TextStyle.Subtitle2" />
                        <RadzenTextBox @bind-Value="Input.TwoFactorCode" Name="Input.TwoFactorCode" Class="rz-w-100"
                            Style="height: 3.5rem; border-radius: 8px; font-size: 1.5rem; text-align: center; letter-spacing: 0.5rem;"
                            autocomplete="off" placeholder="000 000" />
                        <ValidationMessage For="() => Input.TwoFactorCode" Class="rz-color-danger"
                            Style="font-size: 0.75rem;" />
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenCheckBox @bind-Value="Input.RememberMachine" Name="RememberMachine" />
                        <RadzenLabel Text="Authorize this terminal for future sessions" Component="RememberMachine"
                            TextStyle="TextStyle.Body2" />
                    </RadzenStack>

                    <RadzenButton ButtonType="ButtonType.Submit" Text="Synchronize Authorization"
                        ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" Icon="lock_open"
                        Class="rz-w-100 rz-mt-4" Style="height: 3.5rem; border-radius: 12px; font-weight: bold;" />

                    <RadzenStack AlignItems="AlignItems.Center" Gap="1rem" Class="rz-mt-4 rz-pt-6 rz-border-top">
                        <RadzenText Text="DEVICE UNAVAILABLE?" TextStyle="TextStyle.Overline"
                            Class="rz-color-text-disabled" />
                        <RadzenLink Path="@($"Account/LoginWithRecoveryCode?ReturnUrl={ReturnUrl}")"
                            Text="Authorize via Emergency Recovery Protocol" Icon="history_edu"
                            TextStyle="TextStyle.Caption" />
                    </RadzenStack>
                </RadzenStack>
            </EditForm>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private string? message;
    private ApplicationUser user = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery]
    private bool RememberMe { get; set; }

    protected override void OnInitialized()
    {
        Input ??= new();
    }

    protected override async Task OnParametersSetAsync()
    {
        user = await SignInManager.GetTwoFactorAuthenticationUserAsync() ??
        throw new InvalidOperationException("Unable to load multi-factor orchestration user.");
    }

    private async Task OnValidSubmitAsync()
    {
        var authenticatorCode = Input.TwoFactorCode!.Replace(" ", string.Empty).Replace("-", string.Empty);
        var result = await SignInManager.TwoFactorAuthenticatorSignInAsync(authenticatorCode, RememberMe,
        Input.RememberMachine);
        var userId = await UserManager.GetUserIdAsync(user);

        if (result.Succeeded)
        {
            Logger.LogInformation("User with ID '{UserId}' synchronized via 2fa.", userId);
            RedirectManager.RedirectTo(ReturnUrl);
        }
        else if (result.IsLockedOut)
        {
            Logger.LogWarning("User with ID '{UserId}' account orchestration locked.", userId);
            RedirectManager.RedirectTo("Account/Lockout");
        }
        else
        {
            Logger.LogWarning("Invalid authenticator token orchestrated for user with ID '{UserId}'.", userId);
            message = "Error: Invalid authenticator token orchestrated.";
        }
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(7, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Text)]
        [Display(Name = "Authenticator code")]
        public string? TwoFactorCode { get; set; }

        [Display(Name = "Remember this machine")]
        public bool RememberMachine { get; set; }
    }
}

