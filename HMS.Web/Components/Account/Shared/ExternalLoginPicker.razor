@*
 * FILE: ExternalLoginPicker.razor
 * PURPOSE: Frontend web component.
 * COMMUNICATES WITH: None
*@
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Identity
@using HMS.Web.Data

@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityRedirectManager RedirectManager

@if (externalLogins.Length == 0)
{
    <RadzenStack Gap="1rem" Class="rz-p-4 rz-text-align-center">
        <RadzenText Text="No external institutional authentication services are currently orchestrated."
            TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
        <RadzenLink Path="https://go.microsoft.com/fwlink/?LinkID=532715" Text="Clinical Federation Documentation"
            Target="_blank" Icon="info" />
    </RadzenStack>
}
else
{
    <form class="form-horizontal" action="Account/PerformExternalLogin" method="post">
        <RadzenStack Gap="1.5rem" Class="rz-p-4">
            <AntiforgeryToken />
            <input type="hidden" name="ReturnUrl" value="@ReturnUrl" />
            <RadzenText Text="Or authorize via clinical federation provider:" TextStyle="TextStyle.Caption"
                Class="rz-color-text-secondary rz-mb-2" />
            <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap" Gap="1rem"
                JustifyContent="JustifyContent.Center">
                @foreach (var provider in externalLogins)
                {
                    <RadzenButton ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat"
                        Name="provider" Value="@provider.Name" Text="@provider.DisplayName" Icon="lock_open"
                        title="@($"Log in using your {provider.DisplayName} institutional account")" />
                }
            </RadzenStack>
        </RadzenStack>
    </form>
}

@code {
    private AuthenticationScheme[] externalLogins = [];

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        externalLogins = (await SignInManager.GetExternalAuthenticationSchemesAsync()).ToArray();
    }
}

