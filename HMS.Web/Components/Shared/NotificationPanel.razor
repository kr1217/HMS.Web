@*
 * FILE: NotificationPanel.razor
 * PURPOSE: Frontend web component.
 * COMMUNICATES WITH: NotificationRepository, PatientRepository
*@
@using HMS.Web.DAL
@using HMS.Web.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen.Blazor
@using System
@inject NotificationRepository NotificationRepo
@inject PatientRepository PatientRepo
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Style="position: relative;">
    <RadzenButton Icon="notifications" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text" 
                  Click="@ToggleDropdown" Class="rz-p-2" Style="position: relative;">
        @if (notifications != null && notifications.Any(n => !n.IsRead))
        {
            <RadzenBadge Text="@notifications.Count(n => !n.IsRead).ToString()" BadgeStyle="BadgeStyle.Danger" IsPill="true" 
                         Style="position: absolute; top: 0; right: 0; transform: translate(50%, -50%);" />
        }
    </RadzenButton>

    @if (ShowDropdown)
    {
        <RadzenCard Class="rz-shadow-4 rz-p-0" 
                    Style="position: absolute; top: 100%; right: 0; width: 300px; max-height: 400px; z-index: 1000; overflow: hidden; border-radius: 12px; margin-top: 8px;">
            <RadzenStack Class="rz-p-4 rz-background-color-base-100 rz-border-bottom">
                <RadzenText Text="Notifications" TextStyle="TextStyle.Subtitle1" Class="rz-m-0 rz-font-weight-bold" />
            </RadzenStack>

            <RadzenStack Gap="0" Style="overflow-y: auto; max-height: 340px;">
                @if (notifications == null)
                {
                    <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-8">
                        <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="width: 100px;" />
                        <RadzenText Text="Loading..." TextStyle="TextStyle.Caption" />
                    </RadzenStack>
                }
                else if (!notifications.Any())
                {
                    <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-8">
                        <RadzenText Text="No new notifications" TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
                    </RadzenStack>
                }
                else
                {
                    @foreach (var note in notifications)
                    {
                        string link = "patient/appointments";
                        if (note.Title.Contains("Prescription", StringComparison.OrdinalIgnoreCase))
                        {
                            link = "patient/prescriptions";
                        }
                        else if (note.Title.Contains("Bill", StringComparison.OrdinalIgnoreCase))
                        {
                            link = "patient/bills";
                        }

                        <RadzenLink Path="@link" Class="rz-text-decoration-none">
                            <RadzenStack Gap="0.25rem" Class="@(note.IsRead ? "rz-p-4" : "rz-p-4 rz-background-color-info-lighter")"
                                         Style="@(note.IsRead ? "" : "border-left: 4px solid var(--rz-info);")">
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenText Text="@note.Title" TextStyle="TextStyle.Subtitle2" Class="rz-m-0 rz-font-weight-bold rz-color-text" />
                                    <RadzenText Text="@note.CreatedDate.ToShortDateString()" TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
                                </RadzenStack>
                                <RadzenText Text="@note.Message" TextStyle="TextStyle.Caption" Class="rz-m-0 rz-color-text-secondary text-wrap" />
                            </RadzenStack>
                        </RadzenLink>
                        <RadzenStack Style="height: 1px; background: var(--rz-border-color-light);" />
                    }
                }
            </RadzenStack>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private List<Notification>? notifications;
    private bool ShowDropdown = false;

    private void ToggleDropdown() => ShowDropdown = !ShowDropdown;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask == null) return;

        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            var userId = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (userId != null)
            {
                var patient = PatientRepo.GetPatientByUserId(userId);
                if (patient != null)
                {
                    notifications = NotificationRepo.GetNotificationsByPatientId(patient.PatientId);
                }
                else
                {
                    notifications = new List<Notification>();
                }
            }
        }
    }
}

