@*
 * FILE: ShiftWidget.razor
 * PURPOSE: Frontend web component.
 * COMMUNICATES WITH: FinanceRepository
*@
@using HMS.Web.DAL
@using HMS.Web.Models
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components.Authorization
@inject FinanceRepository FinanceRepo
@inject AuthenticationStateProvider AuthProvider
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager Navigation

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="true" Mode="ProgressBarMode.Indeterminate"
            Size="ProgressBarCircularSize.Small" />
    }
    else if (currentShift != null)
    {
        <RadzenStack AlignItems="AlignItems.End" Gap="0">
             <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Shift Active" IsPill="true" />
             <RadzenText Text="@currentShift.StartTime.ToString("t")" TextStyle="TextStyle.Caption" Class="rz-color-text-secondary" />
        </RadzenStack>
    }
</RadzenStack>

@code {
    bool isLoading = true;
    UserShift? currentShift;
    string userId = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadShiftStatus();
    }

    async Task LoadShiftStatus()
    {
        isLoading = true;
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";

            if (!string.IsNullOrEmpty(userId))
            {
                currentShift = FinanceRepo.GetCurrentShift(userId);

                // Auto-Start for ALL roles (Admin, Teller, Doctor)
                if (currentShift == null)
                {
                    FinanceRepo.StartShift(userId, 0); // Default 0 starting cash for auto-start
                    currentShift = FinanceRepo.GetCurrentShift(userId);
                    NotificationService.Notify(NotificationSeverity.Success, "Shift Auto-Started", "Your shift has begun automatically.");
                }
            }
        }
        isLoading = false;
    }

    async Task StartShiftDialog()
    {
        var result = await DialogService.OpenAsync("Start Shift", ds =>
    @<RadzenStack Gap="1.5rem" Class="rz-p-4">
        <RadzenText Text="Enter starting cash amount in drawer:" TextStyle="TextStyle.Body2" />
        <RadzenNumeric TValue="decimal" @bind-Value="startingCash" Class="rz-w-100" Format="c" />
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="() => ds.Close(false)" />
            <RadzenButton Text="Start Shift" ButtonStyle="ButtonStyle.Success" Click="() => ds.Close(true)" />
        </RadzenStack>
    </RadzenStack>
            , new DialogOptions { Width = "300px", Height = "auto" });

        if (result == true)
        {
            FinanceRepo.StartShift(userId, startingCash);
            await LoadShiftStatus();
            StateHasChanged(); // Force UI refresh
            NotificationService.Notify(NotificationSeverity.Success, "Shift Started", "You are now on duty.");
            await Task.Delay(1000);
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
    }

    decimal startingCash = 0;
    decimal closingActualCash = 0;
    string closingNotes = "";

    async Task EndShiftDialog()
    {
        if (currentShift == null) return;

        var expectedRev = FinanceRepo.GetShiftRevenue(currentShift.ShiftId);

        var result = await DialogService.OpenAsync("End Shift", ds =>
    @<RadzenStack Gap="1.5rem" Class="rz-p-4">
        <RadzenStack Gap="0.5rem">
            <RadzenText Text="@($"Shift Started: {currentShift?.StartTime:g}")" TextStyle="TextStyle.Body2" Class="rz-font-weight-bold" />
            <RadzenText Text="@($"System Expected Revenue: {expectedRev:C}")" TextStyle="TextStyle.Subtitle2" Class="rz-color-primary rz-font-weight-bold" />
        </RadzenStack>
        
        <RadzenStack Gap="0.5rem">
            <RadzenLabel Text="Physical Cash Counted" Component="cash" TextStyle="TextStyle.Caption" />
            <RadzenNumeric Name="cash" TValue="decimal" @bind-Value="closingActualCash" Class="rz-w-100" Format="c" />
            @if (closingActualCash != expectedRev && closingActualCash > 0)
            {
                <RadzenText Text="@($"Variance: {(closingActualCash - expectedRev):C}")" TextStyle="TextStyle.Caption" Class="rz-color-danger rz-mt-1" />
            }
        </RadzenStack>
        
        <RadzenStack Gap="0.5rem">
            <RadzenLabel Text="Notes / Handover" Component="notes" TextStyle="TextStyle.Caption" />
            <RadzenTextArea Name="notes" @bind-Value="closingNotes" Class="rz-w-100" Rows="3"
                Placeholder="Explain variances if any..." />
        </RadzenStack>
        
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="() => ds.Close(false)" />
            <RadzenButton Text="End Shift" ButtonStyle="ButtonStyle.Danger" Click="() => ds.Close(true)" />
        </RadzenStack>
    </RadzenStack>
, new DialogOptions { Width = "400px", Height = "auto" });

        if (result == true)
        {
            FinanceRepo.CloseShift(currentShift.ShiftId, closingActualCash, closingNotes);
            
            NotificationService.Notify(NotificationSeverity.Info, "Shift Ended", "Shift report has been locked. Page will reload...");
            
            // Force page reload to refresh all components
            await Task.Delay(1000); // Give user time to see the notification
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
    }
}

