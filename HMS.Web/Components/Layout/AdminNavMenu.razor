@implements IDisposable
@inject NavigationManager NavigationManager
@inject HMS.Web.DAL.FinanceRepository FinanceRepo
@inject AuthenticationStateProvider AuthProvider
@inject IJSRuntime JSRuntime
@using Radzen.Blazor

<RadzenPanelMenu>
    <AuthorizeView Roles="Admin">
        <Authorized>
            <RadzenPanelMenuItem Text="Governance" Icon="admin_panel_settings" Expanded="true">
                <RadzenPanelMenuItem Text="Dashboard" Icon="dashboard" Path="admin/dashboard" />
                <RadzenPanelMenuItem Text="Staff Registry" Icon="people" Path="admin/staff" />
            </RadzenPanelMenuItem>

            <RadzenPanelMenuItem Text="Clinical Operations" Icon="local_hospital">
                <RadzenPanelMenuItem Text="Admissions" Icon="bed" Path="admin/admissions" />
                <RadzenPanelMenuItem Text="Pending Ops" Icon="emergency" Path="Admin/OperationRequests" />
                <RadzenPanelMenuItem Text="OT Schedule" Icon="event" Path="admin/ot-schedule" />
                <RadzenPanelMenuItem Text="Post-Op Handover" Icon="transfer_within_a_station"
                    Path="admin/pending-transfers" />
            </RadzenPanelMenuItem>

            <RadzenPanelMenuItem Text="Infrastructure" Icon="business">
                <RadzenPanelMenuItem Text="Facilities" Icon="meeting_room" Path="admin/facilities" />
            </RadzenPanelMenuItem>

            <RadzenPanelMenuItem Text="Finance & HR" Icon="payments">
                <RadzenPanelMenuItem Text="Financial Hub" Icon="attach_money" Path="admin/finance" />
                <RadzenPanelMenuItem Text="Doctor Settlements" Icon="account_balance" Path="admin/settlements" />
                <RadzenPanelMenuItem Text="Shift Reports" Icon="assessment" Path="admin/shift-report" />
            </RadzenPanelMenuItem>
        </Authorized>
    </AuthorizeView>

    <AuthorizeView Roles="Teller">
        <Authorized>
            <RadzenPanelMenuItem Text="Teller Services" Icon="point_of_sale" Expanded="true">
                <RadzenPanelMenuItem Text="Teller Desk" Icon="desk" Path="teller/dashboard" />
            </RadzenPanelMenuItem>
        </Authorized>
    </AuthorizeView>

    <AuthorizeView>
        <Authorized>
            <RadzenPanelMenuItem Text="Exit" Icon="close" Click="HandleLogout" />
        </Authorized>
    </AuthorizeView>
</RadzenPanelMenu>

<form action="/Account/Logout" method="post" id="adminLogoutForm" style="display:none">
    <AntiforgeryToken />
    <input type="hidden" name="ReturnUrl" value="@currentUrl" />
</form>

@code {
    private string? currentUrl;

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    private async Task HandleLogout()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                try
                {
                    var shift = FinanceRepo.GetCurrentShift(userId);
                    if (shift != null)
                    {
                        var expectedRevenue = FinanceRepo.GetShiftRevenue(shift.ShiftId);
                        FinanceRepo.CloseShift(shift.ShiftId, expectedRevenue, "Auto-closed on Logout");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error closing shift: {ex.Message}");
                }
            }
        }

        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('adminLogoutForm').submit();");
    }
}
